---
title: 第 5 章-Azure RTOS LevelX NOR サポート
description: NOR フラッシュ メモリは、通常 512 バイトで均等に割り切れるブロックで構成されています。 Azure RTOS LevelX は、各 NOR フラッシュ ブロックを 512 バイトの論理セクターに分割します。
author: philmea
ms.author: philmea
ms.date: 05/19/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: d5d06fa66f0cae29eeb2a89560704b2ef510597e44a565499bf672a75555f208
ms.sourcegitcommit: 93d716cf7e3d735b18246d659ec9ec7f82c336de
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/07/2021
ms.locfileid: "116790566"
---
# <a name="chapter-5---azure-rtos-levelx-nor-support"></a>第 5 章-Azure RTOS LevelX NOR サポート

NOR フラッシュ メモリは、通常 512 バイトで均等に割り切れる "*ブロック*" で構成されています。 NOR フラッシュ メモリにはフラッシュ "*ページ*" の概念はありません。 また、NOR フラッシュ メモリには "*スペア*" バイトがないため、Azure RTOS LevelX では、すべての管理情報に NOR フラッシュ メモリ自体を使用する必要があります。 NOR フラッシュ メモリでは直接読み取りアクセスを実行できます。 通常、書き込みアクセスには、特別な操作シーケンスが必要です。 ビットがクリアされている場合、NOR フラッシュ メモリが複数回書き込まれることがあります。 NOR フラッシュ メモリのビットは、ブロック消去操作によって一度だけ設定できます。

LevelX は、各 NOR フラッシュ ブロックを 512 バイトの論理 *セクター* に分割します。 さらに、LevelX では、各 NOR フラッシュ ブロックの最初の "n" セクターを使用して、管理情報を格納します。 LevelX NOR フラッシュ メモリの管理情報の形式は次のとおりです。

**LevelX NOR ブロック形式**

| バイト オフセット  | 内容                     |
| ------------ | ---------------------------- |
| 0            | [ブロック消去カウント]          |
| 4            | [最小マップ セクター]      |
| 8            | [最大マップ セクター]      |
| 12           | [空きセクター ビット マップ]        |
| m            | [セクター 0 マッピング エントリ]     |
|              | …                            |
| m+4*(n-1)    | [セクター "n" マッピング エントリ]   |
|              | …                            |
| s            | [セクター 0 のコンテンツ]          |
|              | …                            |
| s+512*(n-1) | [セクター "n" のコンテンツ]         |

32 ビットの "*ブロック消去カウント*" には、ブロックが消去された回数が含まれます。 LevelX の主な目的は、すべてのブロックの消去カウントを比較的近い状態に保つことで、1 つのブロックが早期に使い切られないようにすることです。 32 ビットの "*最小マップ セクター*" および "*最大マップ セクター*" フィールドは、ブロック内のすべての論理セクターがマップされ、書き込まれた場合にのみ書き込まれます。 これらのフィールドは、セクターの読み取り操作の最適化に役立ちます。 "*空きセクター ビット マップ*" エントリは、各セット ビットがブロック内のマップされていないセクターに対応するビット マップです。 このフィールドは、空きセクター検索の効率を高めるために使用されます。 これは、ブロック内の 32 セクターごとに 1 ワードを必要とする可変長フィールドです。 "*セクター マッピング エントリ*" の配列には、ブロック内の各セクターのマッピング情報が含まれています。 各エントリは次の形式になっています。

**セクター マッピング エントリ**

| ビット | 意味  |
| ------ | -------- |
| 31     | 有効なフラグ。 設定され、論理セクターがすべて 1 ではない場合、マッピングが有効であることを示します |
| 30     | 廃止されたフラグ。 クリアすると、このマッピングは廃止されるか、廃止のプロセスに入れられます。 |
| 29     | このビットが 0 の場合、マッピング エントリの書き込みが完了します |
| 0-28   | この物理セクターにマップされている論理セクター。すべてが 1 ではない場合。 |

32 ビット フィールドの上位ビット (ビット 31) は、論理セクターのマッピングが有効であることを示すために使用されます。 このビットが 0 の場合、このエントリの情報 (および対応するセクターのコンテンツ) は無効になります。 次のビット (ビット 30) は、このセクターが廃止されるプロセス内にあり、新しいセクターが書き込まれていることを示すために使用されます。 ビット 29 は、マッピング エントリの書き込みがいつ完了するかを示すために使用されます。 ビット 29 が 0 の場合、マッピング エントリの書き込みは完了です。 ビット 29 が設定されている場合、マッピング エントリは書き込み処理中でした。 ビット 30 と 29 は、新しいセクター マッピングを更新するときのパワー ロスの可能性から回復するために使用されます。 最後に、下位 29 ビット (28 から 0) にセクターの論理セクター番号が格納されます。 セクターがマッピングされていない場合は、すべてのビットが設定されます。つまり、値は 0xFFFFFFFF になります。

## <a name="nor-driver-requirements"></a>NOR ドライバーの要件

LevelX には、基になるフラッシュ パーツとハードウェアの実装に固有の、基になる NOR フラッシュ ドライバーが必要です。 ドライバーは、API ***lx_nor_flash_open*** を使用した初期化中に、LevelX に指定されます。 LevelX ドライバーのプロトタイプは次のとおりです。

```c
INT nor_driver_initialize(LX_NOR_FLASH *instance);
```

"*Instance*" パラメーターは、LevelX NOR コントロール ブロックを指定します。 ドライバー初期化関数は、関連する LevelX インスタンスの他のすべてのドライバー レベル サービスを設定します。 各 LevelX NOR インスタンスに必要なサービスは次のとおりです。

- 読み取りセクター
- 書き込みセクター
- ブロック消去
- ブロック消去の確認
- システム エラー ハンドラー

## <a name="driver-initialization"></a>ドライバーの初期化

これらのサービスは、ドライバーの初期化関数内の **LX_NOR_FLASH** インスタンスに関数ポインターを設定することによって設定します。 ドライバー初期化関数は、次の役割も実行します。

1. フラッシュのベース アドレスを指定する。
1. ブロックの合計数とブロックあたりのワード数を指定する。
1. フラッシュの 1 セクター (512 バイト) の読み取りおよび ULONG アクセス用に調整された RAM バッファー。

また、ドライバー初期化関数は、**LX_SUCCESS** を返す前に、追加のデバイスまたは実装固有の初期化処理も実行します。

## <a name="driver-read-sector"></a>ドライバー読み取りセクター

LevelX NOR ドライバー "読み取りセクター" サービスは、NOR フラッシュの特定のブロック内の特定のセクターを読み取りを実行します。 すべてのエラー チェックと修正ロジックは、ドライバー サービスの役割です。 成功した場合、LevelX NOR ドライバーから **LX_SUCCESS** が返されます。 成功しなかった場合、LevelX NOR ドライバーから *LX_ERROR* が返されます。 LevelX NOR ドライバー "読み取りセクター" サービスのプロトタイプは次のとおりです。

```c
INT nor_driver_read_sector(
    ULONG *flash_address,
    ULONG *destination, 
    ULONG words);
```

ここで、"*flash_address*" は、メモリの NOR フラッシュ ブロック内の論理セクターのアドレスを指定し、"*destination*" は、セクターのコンテンツを配置する場所、"*words*" は読み取る 32 ビット ワードの数を指定します。

## <a name="driver-write-sector"></a>ドライバー書き込みセクター

LevelX NOR ドライバー "書き込みセクター" サービスは、特定のセクターを NOR フラッシュのブロックに書き込む処理を実行します。 すべてのエラー チェックは、ドライバー サービスの役割です。 成功した場合、LevelX NOR ドライバーから **LX_SUCCESS** が返されます。 成功しなかった場合、LevelX NOR ドライバーから **LX_ERROR** が返されます。 LevelX NOR ドライバー "書き込みセクター" サービスのプロトタイプは次のとおりです。

```c
INT nor_driver_write_sector(
    ULONG *flash_address,
    ULONG *source, 
    ULONG words);
```

ここで、"*flash_address*" は、メモリーの NOR フラッシュ ブロック内の論理セクターのアドレスを指定し、"*source*" は書き込みのソース、"*words*" は書き込む 32 ビット ワードの数を指定します。

> [!NOTE]
> LevelX は、ドライバーを使用して、書き込みセクターが正常に作成されたことを確認します。 通常、これは、プログラミングされた値を読み取って、書き込まれた要求値と照合することで行われます。

## <a name="driver-block-erase"></a>ドライバー ブロック消去

LevelX NOR ドライバー "ブロック消去" サービスは、NOR フラッシュの指定されたブロックの消去を実行します。 成功した場合、LevelX NOR ドライバーから **LX_SUCCESS** が返されます。 成功しなかった場合、LevelX NOR ドライバーから **LX_ERROR** が返されます。 LevelX NOR ドライバー "ブロック消去" サービスのプロトタイプは次のとおりです。

```c
INT nor_driver_block_erase(ULONG block,  
    ULONG erase_count);
```

ここで、"*block*" は、消去する NOR ブロックを識別します。 パラメーター "*erase_count*" は診断のために提供されています。 たとえば、消去数が特定のしきい値を超えた場合、ドライバーは、アプリケーション ソフトウェアの別の部分を警告することがあります。

> [!NOTE]
> LevelX はドライバーを使用して、ブロックのすべてのバイトを検査し、それらが確実に消去されるようにします (すべて 1 を含む)。

## <a name="driver-block-erased-verify"></a>ドライバー ブロック消去の確認

LevelX NOR ドライバー "ブロック消去の確認" サービスは、NOR フラッシュの指定されたブロックが消去されていることを確認します。 消去されている場合、LevelX NOR ドライバーによって **LX_SUCCESS** が返されます。 ブロックが消去されていない場合、LevelX NOR ドライバーによって **LX_ERROR** が返されます。 LevelX NOR ドライバー "ブロック消去の確認" サービスのプロトタイプは次のとおりです。

```c
INT nor_driver_block_erased_verify(ULONG block);
```

ここで、"*block*" は、消去されていることを確認するブロックを指定します。

> [!NOTE]
> LevelX はドライバーを使用して、指定されたすべてのバイトを検査し、それらが確実に消去されるようにします (すべて 1 を含む)。

## <a name="driver-system-error"></a>ドライバー システム エラー

LevelX NOR ドライバーの "システム エラー ハンドラー" サービスは、LevelX によって検出されたシステム エラーの処理の設定を実行します。 このルーチンでの処理は、アプリケーションに依存します。 成功した場合、LevelX NOR ドライバーによって **LX_SUCCESS** が返されます。 成功しなかった場合、LevelX NOR ドライバーによって **LX_ERROR** が返されます。 LevelX NOR ドライバー "システム エラー" サービスのプロトタイプは次のとおりです。

```c
INT nor_driver_system_error(UINT error_code);
```

"*Error_code*" は、発生したエラーを表します。

## <a name="nor-simulated-driver"></a>NOR シミュレート済みドライバー

LevelX は、単純に RAM を使用して NOR フラッシュ部分の操作をシミュレートする、シミュレート済み NOR フラッシュ ドライバーを提供します。 既定では、NOR シミュレート済みドライバーは、8 個の NOR フラッシュ ブロックと、ブロックあたり 16 の 512 バイトのセクター提供します。

シミュレート済み NOR フラッシュ ドライバー初期化関数は、***lx_nor_flash_simulator_initialize** _ であり、_*_lx_nor_flash_simulator.c_** で定義されます。 このドライバーは、特定の NOR フラッシュ ドライバーを作成するための便利なテンプレートも提供します。

## <a name="nor-filex-integration"></a>NOR FileX の統合

前述のように、LevelX は操作に FileX を使用しません。 LevelX によって提供される論理セクターに生データを格納または取得するために、すべての LevelX API は、アプリケーション ソフトウェアによって直接呼び出される場合があります。 ただし、LevelX では FileX もサポートされています。

ファイル ***fx_nor_flash_simulated_driver .c*** には、NOR フラッシュのシミュレーションで使用する FileX ドライバーの例が含まれています。 また、LevelX 用の NOR フラッシュ FileX ドライバーは、カスタム FileX ドライバーを作成するための効果的な出発点を提供します。

> [!NOTE]
> FileX NOR フラッシュの形式は、NOR フラッシュで提供されるものよりも小さい、セクターの完全なブロック サイズである必要があります。 これにより、消耗レベルの処理中に最適なパフォーマンスを得ることができます。 LevelX の消耗平準化アルゴリズムでは、書き込みパフォーマンスを向上させるための追加の手法があります。
> 1. すべての書き込みが、正確に 1 つ以上のクラスターのサイズになり、正確なクラスター境界で開始されることを確認します。
> 2. API の FileX ***fx_file_allocate*** クラスを使用して大きなファイル書き込み操作を実行する前に、クラスターを事前に割り当てます。
> 3.  ***Lx_nor_flash_defragment*** を定期的に使用して、可能な限り多くの NOR ブロックを解放し、書き込みパフォーマンスを向上させることができます。
> 4. リリース セクター情報を受信するために FileX ドライバーが有効になっていること、およびセクターをリリースするためにドライバーに対して行われた要求が、***lx_nor_flash_sector_release*** を呼び出すことによってドライバーで処理されていることを確認します。
