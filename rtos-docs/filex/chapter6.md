---
title: 第 6 章 - Azure RTOS FileX フォールト トレラント モジュール
description: この章では、Azure RTOS FileX フォールト トレラント モジュールについて説明します。このモジュールは、メディアが電源を喪失したり、ファイルの書き込み操作中にメディアを取り出したりした場合に、ファイル システムの整合性を維持するように設計されています。
author: philmea
ms.author: philmea
ms.date: 05/19/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: 68a24f0345a2c4d3e824270699b00a2daab32f8e
ms.sourcegitcommit: e3d42e1f2920ec9cb002634b542bc20754f9544e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/22/2021
ms.locfileid: "104811321"
---
# <a name="chapter-6---azure-rtos-filex-fault-tolerant-module"></a><span data-ttu-id="f2920-103">第 6 章 - Azure RTOS FileX フォールト トレラント モジュール</span><span class="sxs-lookup"><span data-stu-id="f2920-103">Chapter 6 - Azure RTOS FileX fault tolerant module</span></span>

<span data-ttu-id="f2920-104">この章では、Azure RTOS FileX フォールト トレラント モジュールについて説明します。このモジュールは、メディアが電源を喪失したり、ファイルの書き込み操作中にメディアを取り出したりした場合に、ファイル システムの整合性を維持するように設計されています。</span><span class="sxs-lookup"><span data-stu-id="f2920-104">This chapter contains a description of the Azure RTOS FileX Fault Tolerant Module that is designed to maintain file system integrity if the media loses power or is ejected in the middle of a file write operation.</span></span>

## <a name="filex-fault-tolerant-module-overview"></a><span data-ttu-id="f2920-105">FileX フォールト トレラント モジュールの概要</span><span class="sxs-lookup"><span data-stu-id="f2920-105">FileX Fault Tolerant Module Overview</span></span>

<span data-ttu-id="f2920-106">アプリケーションによってデータがファイルに書き込まれる際、FileX によってデータ クラスターとシステム情報の両方が更新されます。</span><span class="sxs-lookup"><span data-stu-id="f2920-106">When an application writes data into a file, FileX updates both data clusters and system information.</span></span> <span data-ttu-id="f2920-107">この更新は、ファイル システム内の情報の整合性を維持するために、アトミック操作として完了する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f2920-107">These updates must be completed as an atomic operation to keep information in the file system coherent.</span></span> <span data-ttu-id="f2920-108">たとえば、ファイルにデータを追加する場合、FileX はメディア内の利用可能なクラスターを検索し、FAT チェーンを更新して、ディレクトリ エントリに記録された長さを更新する必要があります。また、ディレクトリ エントリ内の開始クラスター番号を更新する必要がある場合もあります。</span><span class="sxs-lookup"><span data-stu-id="f2920-108">For example, when appending data to a file, FileX needs to find an available cluster in the media, update the FAT chain, update the length filed in the directory entry, and possibly update the starting cluster number in the directory entry.</span></span> <span data-ttu-id="f2920-109">電源障害またはメディアの取り出しのいずれの場合も、更新シーケンスが中断される可能性があり、その場合ファイル システムが不整合な状態のままになります。</span><span class="sxs-lookup"><span data-stu-id="f2920-109">Either a power failure or media ejection can interrupt the sequence of updates, which will leave the file system in an inconsistent state.</span></span> <span data-ttu-id="f2920-110">不整合な状態が解決されない場合、更新していたデータが失われる可能性があります。またシステム情報の破損により、後続のファイル システム操作によってメディア上の他のファイルやディレクトリが破損する可能性もあります。</span><span class="sxs-lookup"><span data-stu-id="f2920-110">If the inconsistent state is not corrected, the data being updated can be lost, and because of damage to the system information, subsequent file system operation may damage other files or directories on the media.</span></span>

<span data-ttu-id="f2920-111">FileX フォールト トレラント モジュールは、ファイルの更新に必要な手順を、ファイル システムに適用する "*前に*" ジャーナルに記録することによって動作します。</span><span class="sxs-lookup"><span data-stu-id="f2920-111">The FileX Fault Tolerant Module works by journaling steps required to update a file *before* these steps are applied to the file system.</span></span> <span data-ttu-id="f2920-112">ファイルの更新が成功した場合、これらのログ エントリは削除されます。</span><span class="sxs-lookup"><span data-stu-id="f2920-112">If the file update is successful, these log entries are removed.</span></span> <span data-ttu-id="f2920-113">しかし、ファイルの更新が中断された場合、ログ エントリはメディアに保存されます。</span><span class="sxs-lookup"><span data-stu-id="f2920-113">However, if the file update is interrupted, the log entries are stored on the media.</span></span> <span data-ttu-id="f2920-114">次にメディアがマウントされたとき、FileX は以前の (未完了の) 書き込み操作からこれらのログ エントリを検出します。</span><span class="sxs-lookup"><span data-stu-id="f2920-114">Next time the media is mounted, FileX detects these log entries from the previous (unfinished) write operation.</span></span> <span data-ttu-id="f2920-115">この場合、FileX によってファイル システムに既に加えられた変更がロールバックされるか、必要な変更が再適用されて以前の操作が完了することにより、障害から復旧できます。</span><span class="sxs-lookup"><span data-stu-id="f2920-115">In such cases, FileX can recover from a failure by either rolling back the changes already made to the file system, or by reapplying the required changes to complete the previous operation.</span></span> <span data-ttu-id="f2920-116">FileX フォールト トレラント モジュールはこのようにして、メディアの更新操作中に電源が失われた場合にファイル システムの整合性を維持します。</span><span class="sxs-lookup"><span data-stu-id="f2920-116">In this way, the FileX Fault Tolerant Module maintains file system integrity if the media loses power during an update operation.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="f2920-117">*FileX フォールト トレラント モジュールは、有効なデータが含まれた物理メディアの破損を原因とするファイル システムの破損を防ぐようには設計されていません。*</span><span class="sxs-lookup"><span data-stu-id="f2920-117">*The FileX Fault Tolerant Module is not designed to prevent file system corruption caused by physical media corruption with valid data in it.*</span></span>

> [!IMPORTANT]
> <span data-ttu-id="f2920-118">*FileX フォールト トレラント モジュールでメディアを保護した後は、そのメディアをフォールト トレラントが有効になっている FileX 以外でマウントしないでください。そうした場合、ファイル システム内のログ エントリと、メディア上のシステム情報との整合性が失われる可能性があります。メディアが別のファイル システムによって更新された後に、FileX フォールト トレラント モジュールがログ エントリを処理しようとすると、回復手順が失敗し、ファイル システム全体が予測できない状態になる可能性があります。*</span><span class="sxs-lookup"><span data-stu-id="f2920-118">*After the FileX Fault Tolerant module protects a media, the media must not be mounted by anything other than FileX with Fault Tolerant enabled. Doing so can cause the log entries in the file system to be inconsistent with system information on the media. If the FileX Fault Tolerant module attempts to process log entries after the media is updated by another file system, the recovery procedure may fail, leaving the entire file system in an unpredictable state.*</span></span>

## <a name="use-of-the-fault-tolerant-module"></a><span data-ttu-id="f2920-119">フォールト トレラント モジュールの使用</span><span class="sxs-lookup"><span data-stu-id="f2920-119">Use of the Fault Tolerant Module</span></span>

<span data-ttu-id="f2920-120">FileX フォールト トレラント機能は、FileX でサポートされているすべての FAT ファイル システム (FAT12、FAT16、FAT32、exFAT など) で使用できます。</span><span class="sxs-lookup"><span data-stu-id="f2920-120">The FileX Fault Tolerant feature is available to all FAT file systems supported by FileX, including FAT12, FAT16, FAT32, and exFAT.</span></span> <span data-ttu-id="f2920-121">フォールト トレラント機能を有効にするには、シンボル **FX_ENABLE_FAULT_TOLERANT** が定義された状態で FileX がビルドされている必要があります。</span><span class="sxs-lookup"><span data-stu-id="f2920-121">To enable the fault tolerant feature, FileX must be built with the symbol **FX_ENABLE_FAULT_TOLERANT** defined.</span></span> <span data-ttu-id="f2920-122">アプリケーションは実行時に、_ **_fx_media_open_ *の呼び出しの直後に* _fx_fault_tolerant_enable_** _ を呼び出すことによって、フォールト トレラント サービスを開始します。</span><span class="sxs-lookup"><span data-stu-id="f2920-122">At run time, application starts fault tolerant service by calling **_fx_fault_tolerant_enable_*_ immediately after the call to _*_fx_media_open_**.</span></span> <span data-ttu-id="f2920-123">フォールト トレラントを有効にすると、指定したメディアに対するすべてのファイル書き込み操作が保護されます。</span><span class="sxs-lookup"><span data-stu-id="f2920-123">After fault tolerant is enabled, all file write operations to the designated media are protected.</span></span> <span data-ttu-id="f2920-124">既定では、フォールト トレラント モジュールは有効になっていません。</span><span class="sxs-lookup"><span data-stu-id="f2920-124">By default the fault tolerant module is not enabled.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="f2920-125">*アプリケーションでは、\*\*\*fx_fault_tolerant_enable*\* _ が呼び出される前にファイル システムにアクセスしないようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="f2920-125">\*Application needs to make sure the file system is not being accessed prior to \***fx_fault_tolerant_enable** _ being called.</span></span> <span data-ttu-id="f2920-126">フォールト トレラントが有効になる前にアプリケーションによってファイル システムにデータが書き込まれ、かつ以前の書き込み操作が完了していなかった場合、書き込み操作によってメディアが破損し、ファイル システムがフォールト トレラント ログ エントリを使用して復元されない可能性があります。_</span><span class="sxs-lookup"><span data-stu-id="f2920-126">If application writes data to the file system prior to fault tolerant enable, the write operation could corrupt the media if prior write operations were not completed, and the file system was not restored using fault tolerant log entries._</span></span>

## <a name="filex-fault-tolerant-module-log"></a><span data-ttu-id="f2920-127">FileX フォールト トレラント モジュール ログ</span><span class="sxs-lookup"><span data-stu-id="f2920-127">FileX Fault Tolerant Module Log</span></span>

<span data-ttu-id="f2920-128">FileX フォールト トレラント ログは、フラッシュ内で 1 つの論理クラスターを占有します。</span><span class="sxs-lookup"><span data-stu-id="f2920-128">The FileX fault tolerant log takes up one logical cluster in flash.</span></span> <span data-ttu-id="f2920-129">そのクラスターの開始クラスター番号へのインデックスは、メディアのブート セクター内の、**FX_FAULT_TOLERANT_BOOT_INDEX** シンボルで指定されたオフセット位置に記録されます。</span><span class="sxs-lookup"><span data-stu-id="f2920-129">The index to the starting cluster number of that cluster is recorded in the boot sector of the media, with an offset specified by the symbol **FX_FAULT_TOLERANT_BOOT_INDEX**.</span></span> <span data-ttu-id="f2920-130">既定では、このシンボルは 116 として定義されています。</span><span class="sxs-lookup"><span data-stu-id="f2920-130">By default this symbol is defined to be 116.</span></span> <span data-ttu-id="f2920-131">この場所が選択されている理由は、FAT12/ 16/32 および exFAT の仕様上、予約済みとしてマークされているためです。</span><span class="sxs-lookup"><span data-stu-id="f2920-131">This location is chosen because it is marked as reserved in FAT12/ 16/32 and exFAT specification.</span></span>

<span data-ttu-id="f2920-132">図 5 "ログ構造のレイアウト" に、ログ構造の一般的なレイアウトを示しています。</span><span class="sxs-lookup"><span data-stu-id="f2920-132">Figure 5, "Log Structure Layout," shows the general layout of the log structure.</span></span> <span data-ttu-id="f2920-133">ログ構造には、ログ ヘッダー、FAT チェーン、ログ エントリの 3 つのセクションが含まれています。</span><span class="sxs-lookup"><span data-stu-id="f2920-133">The log structure contains three sections: Log Header, FAT Chain, and Log Entries.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="f2920-134">*ログ エントリに格納されているすべてのマルチバイト値は、リトル エンディアン形式です。*</span><span class="sxs-lookup"><span data-stu-id="f2920-134">*All multi-byte values stored in the log entries are in Little Endian format.*</span></span>

![ログ構造のレイアウト](./media/user-guide/log-structure-layout.png)

<span data-ttu-id="f2920-136">**図 5. ログ構造のレイアウト**</span><span class="sxs-lookup"><span data-stu-id="f2920-136">**Figure 5. Log Structure Layout**</span></span>

<span data-ttu-id="f2920-137">ログ ヘッダー領域には、ログ構造全体を記述する情報が含まれており、各フィールドについて詳しく説明しています。</span><span class="sxs-lookup"><span data-stu-id="f2920-137">The Log Header area contains information that describes the entire log structure and explains each field in detail.</span></span>

<span data-ttu-id="f2920-138">**表 8. ログ ヘッダー領域**</span><span class="sxs-lookup"><span data-stu-id="f2920-138">**TABLE 8. Log Header Area**</span></span>

|<span data-ttu-id="f2920-139">フィールド</span><span class="sxs-lookup"><span data-stu-id="f2920-139">Field</span></span>|<span data-ttu-id="f2920-140">サイズ (byte)</span><span class="sxs-lookup"><span data-stu-id="f2920-140">Size(in bytes)</span></span>|<span data-ttu-id="f2920-141">説明</span><span class="sxs-lookup"><span data-stu-id="f2920-141">Description</span></span>|
|-----|--------------|-----------|
|<span data-ttu-id="f2920-142">id</span><span class="sxs-lookup"><span data-stu-id="f2920-142">ID</span></span>|<span data-ttu-id="f2920-143">4</span><span class="sxs-lookup"><span data-stu-id="f2920-143">4</span></span>|<span data-ttu-id="f2920-144">FileX フォールト トレラント ログ構造を識別します。</span><span class="sxs-lookup"><span data-stu-id="f2920-144">Identifies a FileX Fault Tolerant Log structure.</span></span> <span data-ttu-id="f2920-145">ID 値が 0x46544C52 以外の場合、ログ構造は無効と見なされます。</span><span class="sxs-lookup"><span data-stu-id="f2920-145">The log structure is considered invalid if the ID value is not 0x46544C52.</span></span>|
|<span data-ttu-id="f2920-146">総サイズ</span><span class="sxs-lookup"><span data-stu-id="f2920-146">Total Size</span></span>|<span data-ttu-id="f2920-147">2</span><span class="sxs-lookup"><span data-stu-id="f2920-147">2</span></span>|<span data-ttu-id="f2920-148">ログ構造全体の合計サイズ (byte 単位) を示します。</span><span class="sxs-lookup"><span data-stu-id="f2920-148">Indicates the total size (in bytes) of the entire log structure.</span></span>|
|<span data-ttu-id="f2920-149">ヘッダーのチェックサム</span><span class="sxs-lookup"><span data-stu-id="f2920-149">Header Checksum</span></span>|<span data-ttu-id="f2920-150">2</span><span class="sxs-lookup"><span data-stu-id="f2920-150">2</span></span>|<span data-ttu-id="f2920-151">ログ ヘッダー領域を変換するチェックサム。</span><span class="sxs-lookup"><span data-stu-id="f2920-151">Checksum that converts the log header area.</span></span> <span data-ttu-id="f2920-152">ヘッダー フィールドでチェックサムの検証が失敗した場合、ログ構造は無効と見なされます。</span><span class="sxs-lookup"><span data-stu-id="f2920-152">The log structure is considered invalid if the header fields fail the checksum verification.</span></span>|
|<span data-ttu-id="f2920-153">バージョン番号</span><span class="sxs-lookup"><span data-stu-id="f2920-153">Version Number</span></span>|<span data-ttu-id="f2920-154">2</span><span class="sxs-lookup"><span data-stu-id="f2920-154">2</span></span>|<span data-ttu-id="f2920-155">FileX フォールト トレラントのメジャーおよびマイナー バージョン番号。</span><span class="sxs-lookup"><span data-stu-id="f2920-155">FileX Fault Tolerant major and minor version numbers.</span></span>|
|<span data-ttu-id="f2920-156">予約されています。</span><span class="sxs-lookup"><span data-stu-id="f2920-156">Reserved</span></span>|<span data-ttu-id="f2920-157">2</span><span class="sxs-lookup"><span data-stu-id="f2920-157">2</span></span>|<span data-ttu-id="f2920-158">将来の拡張に使用します。</span><span class="sxs-lookup"><span data-stu-id="f2920-158">For future expansion.</span></span>|

<span data-ttu-id="f2920-159">ログ ヘッダー領域の後には、FAT チェーン ログ領域が続きます。</span><span class="sxs-lookup"><span data-stu-id="f2920-159">The Log Header area is followed by the FAT Chain Log area.</span></span> <span data-ttu-id="f2920-160">図 9 に、FAT チェーンの変更方法を説明する情報を示します。</span><span class="sxs-lookup"><span data-stu-id="f2920-160">Figure 9 contains information that describes how the FAT chain should be modified.</span></span> <span data-ttu-id="f2920-161">このログ領域には、ファイルに割り当てられているクラスター、ファイルから削除されたクラスター、および挿入や削除が必要な場所に関する情報が含まれており、FAT チェーン ログ領域の各フィールドについて記述されています。</span><span class="sxs-lookup"><span data-stu-id="f2920-161">This log area contains information on the clusters being allocated to a file, the clusters being removed from a file, and where the insertion/deletion should be and describes each field in the FAT Chain Log area.</span></span>

<span data-ttu-id="f2920-162">**表 9. FAT チェーン ログ領域**</span><span class="sxs-lookup"><span data-stu-id="f2920-162">**TABLE 9. FAT Chain Log Area**</span></span>

|<span data-ttu-id="f2920-163">フィールド</span><span class="sxs-lookup"><span data-stu-id="f2920-163">Field</span></span>|<span data-ttu-id="f2920-164">サイズ (byte)</span><span class="sxs-lookup"><span data-stu-id="f2920-164">Size(in bytes)</span></span>|<span data-ttu-id="f2920-165">説明</span><span class="sxs-lookup"><span data-stu-id="f2920-165">Description</span></span>|
|-----|--------------|-----------|
|<span data-ttu-id="f2920-166">FAT チェーン ログのチェックサム</span><span class="sxs-lookup"><span data-stu-id="f2920-166">FAT Chain Log Checksum</span></span>|<span data-ttu-id="f2920-167">2</span><span class="sxs-lookup"><span data-stu-id="f2920-167">2</span></span>|<span data-ttu-id="f2920-168">FAT チェーン ログ領域全体のチェックサム。</span><span class="sxs-lookup"><span data-stu-id="f2920-168">Checksum of the entire FAT Chain Log area.</span></span> <span data-ttu-id="f2920-169">チェックサムの検証に失敗した場合、FAT チェーン ログ領域は無効と見なされます。</span><span class="sxs-lookup"><span data-stu-id="f2920-169">The FAT Chain Log area is considered invalid if the it fails the checksum verification.</span></span>|
|<span data-ttu-id="f2920-170">フラグ</span><span class="sxs-lookup"><span data-stu-id="f2920-170">Flag</span></span>|<span data-ttu-id="f2920-171">1</span><span class="sxs-lookup"><span data-stu-id="f2920-171">1</span></span>|<span data-ttu-id="f2920-172">有効なフラグの値は次の通りです。</span><span class="sxs-lookup"><span data-stu-id="f2920-172">Valid flag values are:</span></span><br/><span data-ttu-id="f2920-173">0x01 FAT チェーンが有効です</span><span class="sxs-lookup"><span data-stu-id="f2920-173">0x01 FAT Chain Valid</span></span><br /><span data-ttu-id="f2920-174">0x02 ビットマップが使用されています</span><span class="sxs-lookup"><span data-stu-id="f2920-174">0x02 BITMAP is being used</span></span>|
|<span data-ttu-id="f2920-175">予約されています。</span><span class="sxs-lookup"><span data-stu-id="f2920-175">Reserved</span></span>|<span data-ttu-id="f2920-176">1</span><span class="sxs-lookup"><span data-stu-id="f2920-176">1</span></span>|<span data-ttu-id="f2920-177">予約済み</span><span class="sxs-lookup"><span data-stu-id="f2920-177">Reserved for future use</span></span>|
|<span data-ttu-id="f2920-178">挿入ポイント – フロント</span><span class="sxs-lookup"><span data-stu-id="f2920-178">Insertion Point – Front</span></span>|<span data-ttu-id="f2920-179">4</span><span class="sxs-lookup"><span data-stu-id="f2920-179">4</span></span>|<span data-ttu-id="f2920-180">新しく作成されたチェーンが接続される、(元の FAT チェーンに属している) クラスター。</span><span class="sxs-lookup"><span data-stu-id="f2920-180">The cluster (that belongs to the original FAT chain) where the newly created chain is going to be attached to.</span></span>|
|<span data-ttu-id="f2920-181">新しい FAT チェーンの先頭クラスター</span><span class="sxs-lookup"><span data-stu-id="f2920-181">Head Cluster of New FAT Chain</span></span>|<span data-ttu-id="f2920-182">4</span><span class="sxs-lookup"><span data-stu-id="f2920-182">4</span></span>|<span data-ttu-id="f2920-183">新しく作成された FAT チェーンの最初のクラスター</span><span class="sxs-lookup"><span data-stu-id="f2920-183">The first cluster of the newly created FAT Chain</span></span>|
|<span data-ttu-id="f2920-184">元の FAT チェーンの先頭クラスター</span><span class="sxs-lookup"><span data-stu-id="f2920-184">Head Cluster of Original FAT Chain</span></span>|<span data-ttu-id="f2920-185">4</span><span class="sxs-lookup"><span data-stu-id="f2920-185">4</span></span>|<span data-ttu-id="f2920-186">元の FAT チェーンのうち、削除される部分の最初のクラスター。</span><span class="sxs-lookup"><span data-stu-id="f2920-186">The first cluster of the portion of the original FAT Chain that is to be removed.</span></span>|
|<span data-ttu-id="f2920-187">挿入ポイント - バック</span><span class="sxs-lookup"><span data-stu-id="f2920-187">Insertion Point – Back</span></span>|<span data-ttu-id="f2920-188">4</span><span class="sxs-lookup"><span data-stu-id="f2920-188">4</span></span>|<span data-ttu-id="f2920-189">新しく作成された FAT チェーンが接続される元のクラスター。</span><span class="sxs-lookup"><span data-stu-id="f2920-189">The original cluster where the newly created FAT chain joins at.</span></span>|
|<span data-ttu-id="f2920-190">次の削除ポイント</span><span class="sxs-lookup"><span data-stu-id="f2920-190">Next Deletion Point</span></span>|<span data-ttu-id="f2920-191">4</span><span class="sxs-lookup"><span data-stu-id="f2920-191">4</span></span>|<span data-ttu-id="f2920-192">このフィールドは、FAT チェーンのクリーンアップ手順を支援します。</span><span class="sxs-lookup"><span data-stu-id="f2920-192">This field assists the FAT chain cleanup procedure.</span></span>|

<span data-ttu-id="f2920-193">ログ エントリ領域には、障害からの復旧に必要な変更について記述するログ エントリが含まれています。</span><span class="sxs-lookup"><span data-stu-id="f2920-193">The Log Entries Area contains log entries that describe the changes needed to recover from a failure.</span></span> <span data-ttu-id="f2920-194">FileX フォールト トレラント モジュールでサポートされているログ エントリには、FAT ログ エントリ、ディレクトリ ログ エントリ、ビットマップ ログ エントリの 3 種類があります。</span><span class="sxs-lookup"><span data-stu-id="f2920-194">There are three types of log entry supported in the FileX fault tolerant module: FAT Log Entry; Directory Log Entry; and Bitmap Log Entry.</span></span>

<span data-ttu-id="f2920-195">以下に示す 3 つの図と 3 つの表で、これらのログ エントリについて詳しく説明します。</span><span class="sxs-lookup"><span data-stu-id="f2920-195">The following three figures and three tables describe these log entries in detail.</span></span>

![FAT ログ エントリ](./media/user-guide/fat-log-entry.png)

<span data-ttu-id="f2920-197">**図 6. FAT ログ エントリ**</span><span class="sxs-lookup"><span data-stu-id="f2920-197">**Figure 6. FAT Log Entry**</span></span>

<span data-ttu-id="f2920-198">**表 10. FAT ログ エントリ**</span><span class="sxs-lookup"><span data-stu-id="f2920-198">**TABLE 10. FAT Log Entry**</span></span>

|<span data-ttu-id="f2920-199">フィールド</span><span class="sxs-lookup"><span data-stu-id="f2920-199">Field</span></span>|<span data-ttu-id="f2920-200">サイズ (byte)</span><span class="sxs-lookup"><span data-stu-id="f2920-200">Size(in bytes)</span></span>|<span data-ttu-id="f2920-201">説明</span><span class="sxs-lookup"><span data-stu-id="f2920-201">Description</span></span>|
|-----|--------------|-----------|
<span data-ttu-id="f2920-202">Type</span><span class="sxs-lookup"><span data-stu-id="f2920-202">Type</span></span>|<span data-ttu-id="f2920-203">2</span><span class="sxs-lookup"><span data-stu-id="f2920-203">2</span></span>|<span data-ttu-id="f2920-204">エントリの種類。FX_FAULT_TOLERANT_FAT_LOG_TYPE である必要があります</span><span class="sxs-lookup"><span data-stu-id="f2920-204">Type of Entry, must be FX_FAULT_TOLERANT_FAT_LOG_TYPE</span></span>|
|<span data-ttu-id="f2920-205">サイズ</span><span class="sxs-lookup"><span data-stu-id="f2920-205">Size</span></span>|<span data-ttu-id="f2920-206">2</span><span class="sxs-lookup"><span data-stu-id="f2920-206">2</span></span>|<span data-ttu-id="f2920-207">このエントリのサイズ</span><span class="sxs-lookup"><span data-stu-id="f2920-207">Size of this entry</span></span>|
|<span data-ttu-id="f2920-208">クラスター番号</span><span class="sxs-lookup"><span data-stu-id="f2920-208">Cluster Number</span></span>|<span data-ttu-id="f2920-209">4</span><span class="sxs-lookup"><span data-stu-id="f2920-209">4</span></span>|<span data-ttu-id="f2920-210">クラスター番号</span><span class="sxs-lookup"><span data-stu-id="f2920-210">Cluster number</span></span>|
|<span data-ttu-id="f2920-211">[値]</span><span class="sxs-lookup"><span data-stu-id="f2920-211">Value</span></span>|<span data-ttu-id="f2920-212">4</span><span class="sxs-lookup"><span data-stu-id="f2920-212">4</span></span>|<span data-ttu-id="f2920-213">FAT エントリに書き込まれる値</span><span class="sxs-lookup"><span data-stu-id="f2920-213">Value to be written into the FAT entry</span></span>|

![ディレクトリ ログ エントリ](./media/user-guide/directory-log-entry.png)

<span data-ttu-id="f2920-215">**図 7. ディレクトリ ログ エントリ**</span><span class="sxs-lookup"><span data-stu-id="f2920-215">**Figure 7. Directory Log Entry**</span></span>

<span data-ttu-id="f2920-216">**表 11. ディレクトリ ログ エントリ**</span><span class="sxs-lookup"><span data-stu-id="f2920-216">**TABLE 11. Directory Log Entry**</span></span>

|<span data-ttu-id="f2920-217">フィールド</span><span class="sxs-lookup"><span data-stu-id="f2920-217">Field</span></span>|<span data-ttu-id="f2920-218">サイズ (byte)</span><span class="sxs-lookup"><span data-stu-id="f2920-218">Size(in bytes)</span></span>|<span data-ttu-id="f2920-219">説明</span><span class="sxs-lookup"><span data-stu-id="f2920-219">Description</span></span>|
|-----|--------------|-----------|
|<span data-ttu-id="f2920-220">Type</span><span class="sxs-lookup"><span data-stu-id="f2920-220">Type</span></span>|<span data-ttu-id="f2920-221">2</span><span class="sxs-lookup"><span data-stu-id="f2920-221">2</span></span>|<span data-ttu-id="f2920-222">エントリの種類。FX_FAULT_TOLERANT_DIRECTORY_LOG_TYPE である必要があります</span><span class="sxs-lookup"><span data-stu-id="f2920-222">Type of Entry, must be FX_FAULT_TOLERANT_DIRECTORY_LOG_TYPE</span></span>|
|<span data-ttu-id="f2920-223">サイズ</span><span class="sxs-lookup"><span data-stu-id="f2920-223">Size</span></span>|<span data-ttu-id="f2920-224">2</span><span class="sxs-lookup"><span data-stu-id="f2920-224">2</span></span>|<span data-ttu-id="f2920-225">このエントリのサイズ</span><span class="sxs-lookup"><span data-stu-id="f2920-225">Size of this entry</span></span>|
|<span data-ttu-id="f2920-226">セクターのオフセット</span><span class="sxs-lookup"><span data-stu-id="f2920-226">Sector Offset</span></span>|<span data-ttu-id="f2920-227">4</span><span class="sxs-lookup"><span data-stu-id="f2920-227">4</span></span>|<span data-ttu-id="f2920-228">このディレクトリが配置されているセクターへのオフセット (byte 単位)。</span><span class="sxs-lookup"><span data-stu-id="f2920-228">Offset (in bytes) into the sector where this directory is located.</span></span>|
|<span data-ttu-id="f2920-229">ログ セクター</span><span class="sxs-lookup"><span data-stu-id="f2920-229">Log Sector</span></span>|<span data-ttu-id="f2920-230">4</span><span class="sxs-lookup"><span data-stu-id="f2920-230">4</span></span>|<span data-ttu-id="f2920-231">ディレクトリ エントリが配置されているセクター</span><span class="sxs-lookup"><span data-stu-id="f2920-231">The sector where the directory entry is located</span></span>|
|<span data-ttu-id="f2920-232">ログ データ</span><span class="sxs-lookup"><span data-stu-id="f2920-232">Log Data</span></span>|<span data-ttu-id="f2920-233">変数</span><span class="sxs-lookup"><span data-stu-id="f2920-233">Variable</span></span>|<span data-ttu-id="f2920-234">ディレクトリ エントリの内容</span><span class="sxs-lookup"><span data-stu-id="f2920-234">Content of the directory entry</span></span>|

![ビットマップ ログ エントリ](./media/user-guide/bitmap-log-entry.png)

<span data-ttu-id="f2920-236">**図 8. ビットマップ ログ エントリ**</span><span class="sxs-lookup"><span data-stu-id="f2920-236">**Figure 8. Bitmap Log Entry**</span></span>

<span data-ttu-id="f2920-237">**表 12. ビットマップ ログ エントリ**</span><span class="sxs-lookup"><span data-stu-id="f2920-237">**TABLE 12. Bitmap Log Entry**</span></span>

|<span data-ttu-id="f2920-238">フィールド</span><span class="sxs-lookup"><span data-stu-id="f2920-238">Field</span></span>|<span data-ttu-id="f2920-239">サイズ (byte)</span><span class="sxs-lookup"><span data-stu-id="f2920-239">Size(in bytes)</span></span>|<span data-ttu-id="f2920-240">説明</span><span class="sxs-lookup"><span data-stu-id="f2920-240">Description</span></span>|
|-----|--------------|-----------|
|<span data-ttu-id="f2920-241">Type</span><span class="sxs-lookup"><span data-stu-id="f2920-241">Type</span></span>|<span data-ttu-id="f2920-242">2</span><span class="sxs-lookup"><span data-stu-id="f2920-242">2</span></span>|<span data-ttu-id="f2920-243">エントリの種類。FX_FAULT_TOLERANT_BITMAP_LOG_TYPE である必要があります</span><span class="sxs-lookup"><span data-stu-id="f2920-243">Type of Entry, must be FX_FAULT_TOLERANT_BITMAP_LOG_TYPE</span></span>|
|<span data-ttu-id="f2920-244">サイズ</span><span class="sxs-lookup"><span data-stu-id="f2920-244">Size</span></span>|<span data-ttu-id="f2920-245">2</span><span class="sxs-lookup"><span data-stu-id="f2920-245">2</span></span>|<span data-ttu-id="f2920-246">このエントリのサイズ</span><span class="sxs-lookup"><span data-stu-id="f2920-246">Size of this entry</span></span>|
|<span data-ttu-id="f2920-247">クラスター番号</span><span class="sxs-lookup"><span data-stu-id="f2920-247">Cluster Number</span></span>|<span data-ttu-id="f2920-248">4</span><span class="sxs-lookup"><span data-stu-id="f2920-248">4</span></span>|<span data-ttu-id="f2920-249">クラスター番号</span><span class="sxs-lookup"><span data-stu-id="f2920-249">Cluster number</span></span>|
|<span data-ttu-id="f2920-250">[値]</span><span class="sxs-lookup"><span data-stu-id="f2920-250">Value</span></span>|<span data-ttu-id="f2920-251">4</span><span class="sxs-lookup"><span data-stu-id="f2920-251">4</span></span>|<span data-ttu-id="f2920-252">FAT エントリに書き込まれる値</span><span class="sxs-lookup"><span data-stu-id="f2920-252">Value to be written into the FAT entry</span></span>|

## <a name="fault-tolerant-protection"></a><span data-ttu-id="f2920-253">フォールト トレラントな保護</span><span class="sxs-lookup"><span data-stu-id="f2920-253">Fault Tolerant Protection</span></span>

<span data-ttu-id="f2920-254">FileX フォールト トレラント モジュールが起動すると、まず最初にメディア内の既存のフォールト トレラント ログ ファイルが検索されます。</span><span class="sxs-lookup"><span data-stu-id="f2920-254">After the FileX Fault Tolerant Module starts, it first searches for an existing fault tolerant log file in the media.</span></span> <span data-ttu-id="f2920-255">有効なログ ファイルが見つからない場合、FileX はメディアが保護されていないと見なします。</span><span class="sxs-lookup"><span data-stu-id="f2920-255">If a valid log file cannot be found, FileX considers the media unprotected.</span></span> <span data-ttu-id="f2920-256">この場合、FileX はメディア上にフォールト トレラント ログ ファイルを作成します。</span><span class="sxs-lookup"><span data-stu-id="f2920-256">In this case FileX will create a fault tolerant log file on the media.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="f2920-257">\*FileX フォールト トレラント モジュールが開始する前にファイル システムが破損した場合、FileX ではファイル システムを保護できません。</span><span class="sxs-lookup"><span data-stu-id="f2920-257">\*FileX is not able to protect a file system if it was corrupted before the FileX Fault Tolerant Module starts.</span></span> *

<span data-ttu-id="f2920-258">フォールト トレラント ログ ファイルが見つかった場合、FileX は既存のログ エントリを確認します。</span><span class="sxs-lookup"><span data-stu-id="f2920-258">If a fault tolerant log file is located, FileX checks for existing log entries.</span></span> <span data-ttu-id="f2920-259">ログ ファイルにログ エントリがない場合、以前のファイル操作は成功し、すべてのログ エントリが削除されたことを示します。</span><span class="sxs-lookup"><span data-stu-id="f2920-259">A log file with no log entry indicates prior file operation was successful, and all log entries were removed.</span></span> <span data-ttu-id="f2920-260">この場合、アプリケーションでフォールト トレラントな保護が適用されたファイル システムの使用を開始できます。</span><span class="sxs-lookup"><span data-stu-id="f2920-260">In this case the application can start using the file system with fault tolerant protection.</span></span>

<span data-ttu-id="f2920-261">しかし、ログ エントリがある場合、FileX は以前のファイル操作を完了するか、ファイル システムに既に適用されている変更を元に戻して、変更を実質的に取り消す必要があります。</span><span class="sxs-lookup"><span data-stu-id="f2920-261">However if log entries are located, FileX needs to either complete the prior file operation, or revert the changes already applied to the file system, effectively undo the changes.</span></span> <span data-ttu-id="f2920-262">どちらの場合でも、ログ エントリがファイル システムに適用された後、ファイル システムは一貫性のある状態に復元され、アプリケーションでファイル システムの使用を再開できます。</span><span class="sxs-lookup"><span data-stu-id="f2920-262">In either case, after the log entries are applied to the file system, the file system is restored into a coherent state, and application can start using the file system again.</span></span>

<span data-ttu-id="f2920-263">FileX によって保護されているメディアの場合、ファイルの更新操作時に、データの部分はメディアに直接書き込まれます。</span><span class="sxs-lookup"><span data-stu-id="f2920-263">For media protected by FileX, during file update operation, the data portion is written directly to the media.</span></span> <span data-ttu-id="f2920-264">FileX はデータを書き込む際に、ディレクトリ エントリと FAT テーブルに適用する必要のあるすべての変更も記録します。</span><span class="sxs-lookup"><span data-stu-id="f2920-264">As FileX writes data, it also records any changes needed to be applied to directory entries, FAT table.</span></span> <span data-ttu-id="f2920-265">この情報は、ファイル トレラント ログ エントリに記録されます。</span><span class="sxs-lookup"><span data-stu-id="f2920-265">This information is recorded in the file tolerant log entries.</span></span> <span data-ttu-id="f2920-266">この方法により、データがメディアに書き込まれた後に、ファイル システムへの更新が行われることが保証されます。</span><span class="sxs-lookup"><span data-stu-id="f2920-266">This approach guarantees that updates to the file system occur after the data is written to the media.</span></span> <span data-ttu-id="f2920-267">データ書き込みフェーズでメディアが取り出された場合、重要なファイル システム情報はまだ変更されていません。</span><span class="sxs-lookup"><span data-stu-id="f2920-267">If the media is ejected during the data-write phase, crucial file system information has not been changed yet.</span></span> <span data-ttu-id="f2920-268">そのため、ファイル システムは中断の影響を受けません。</span><span class="sxs-lookup"><span data-stu-id="f2920-268">Therefore the file system is not affected by the interruption.</span></span>

<span data-ttu-id="f2920-269">すべてのデータがメディアに正常に書き込まれた後、FileX はログ エントリの情報に従い、一度に 1 つのエントリずつ、変更をシステム情報に適用します。</span><span class="sxs-lookup"><span data-stu-id="f2920-269">After all the data is successfully written to the media, FileX then follows information in the log entries to applies the changes to system information, one entry at a time.</span></span> <span data-ttu-id="f2920-270">すべてのシステム情報がメディアにコミットされたら、フォールト トレラント ログからログ エントリが削除されます。</span><span class="sxs-lookup"><span data-stu-id="f2920-270">After all the system information is committed to the media, the log entries are removed from the fault tolerant log.</span></span> <span data-ttu-id="f2920-271">この時点で、FileX によるファイルの更新操作が完了します。</span><span class="sxs-lookup"><span data-stu-id="f2920-271">At this point, FileX completes the file update operation.</span></span>

<span data-ttu-id="f2920-272">ファイルの更新操作時には、ファイルは直接上書き更新されません。</span><span class="sxs-lookup"><span data-stu-id="f2920-272">During file update operation, files are not updated in place.</span></span> <span data-ttu-id="f2920-273">フォールト トレラント モジュールによって、新しいデータを書き込むためのデータ セクターが割り当てられてから、上書きされるデータを含むセクターが削除され、関連する FAT エントリが更新されて新しいセクターがチェーンにリンクされます。</span><span class="sxs-lookup"><span data-stu-id="f2920-273">The fault tolerant module allocates a sector for the data to write the new data into, and then remove the sector that contains the data to be overwritten, updating related FAT entries to link the new sector into the chian.</span></span> <span data-ttu-id="f2920-274">クラスター内の一部のデータを変更する必要がある場合、FileX によって常に新しいクラスターが割り当てられ、古いクラスターのデータ全体が更新されたデータとともに新しいクラスターに書き込まれた後で、古いクラスターが解放されます。</span><span class="sxs-lookup"><span data-stu-id="f2920-274">For situations in which partial data in a cluster needs to be modified, FileX always allocates new clusters, writes the entire data from the old clusters with updated data into the new clusters, then frees up the old clusters.</span></span> <span data-ttu-id="f2920-275">こうすることで、ファイルの更新が中断された場合でも、元のファイルはそのままであることが保証されます。</span><span class="sxs-lookup"><span data-stu-id="f2920-275">This guarantees that if the file update is interrupted, the original file is intact.</span></span> <span data-ttu-id="f2920-276">FileX フォールト トレラント保護が有効である場合、アプリケーションでファイル内のデータを更新する際に、古いデータを含むセクターが解放される前にメディアに新しいデータを保持するのに十分な空き領域が必要であることに注意する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f2920-276">The application needs to be aware that under FileX fault tolerant protection, updating data in a file requires the media to have enough free space to hold new data before sectors with old data can be released.</span></span> <span data-ttu-id="f2920-277">メディアに新しいデータを格納するための十分な領域がない場合、更新操作は失敗します。</span><span class="sxs-lookup"><span data-stu-id="f2920-277">If the media doesn't have enough space to hold new data, the update operation fails.</span></span>
