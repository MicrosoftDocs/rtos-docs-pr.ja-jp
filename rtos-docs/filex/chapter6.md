---
title: 第 6 章 - Azure RTOS FileX フォールト トレラント モジュール
description: この章では、Azure RTOS FileX フォールト トレラント モジュールについて説明します。このモジュールは、メディアが電源を喪失したり、ファイルの書き込み操作中にメディアを取り出したりした場合に、ファイル システムの整合性を維持するように設計されています。
author: philmea
ms.author: philmea
ms.date: 05/19/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: 66bffa2dbf52bc458bfaf124aa006a79e810100ac2e926c17444daf090519e66
ms.sourcegitcommit: 93d716cf7e3d735b18246d659ec9ec7f82c336de
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/07/2021
ms.locfileid: "116783750"
---
# <a name="chapter-6---azure-rtos-filex-fault-tolerant-module"></a>第 6 章 - Azure RTOS FileX フォールト トレラント モジュール

この章では、Azure RTOS FileX フォールト トレラント モジュールについて説明します。このモジュールは、メディアが電源を喪失したり、ファイルの書き込み操作中にメディアを取り出したりした場合に、ファイル システムの整合性を維持するように設計されています。

## <a name="filex-fault-tolerant-module-overview"></a>FileX フォールト トレラント モジュールの概要

アプリケーションによってデータがファイルに書き込まれる際、FileX によってデータ クラスターとシステム情報の両方が更新されます。 この更新は、ファイル システム内の情報の整合性を維持するために、アトミック操作として完了する必要があります。 たとえば、ファイルにデータを追加する場合、FileX はメディア内の利用可能なクラスターを検索し、FAT チェーンを更新して、ディレクトリ エントリに記録された長さを更新する必要があります。また、ディレクトリ エントリ内の開始クラスター番号を更新する必要がある場合もあります。 電源障害またはメディアの取り出しのいずれの場合も、更新シーケンスが中断される可能性があり、その場合ファイル システムが不整合な状態のままになります。 不整合な状態が解決されない場合、更新していたデータが失われる可能性があります。またシステム情報の破損により、後続のファイル システム操作によってメディア上の他のファイルやディレクトリが破損する可能性もあります。

FileX フォールト トレラント モジュールは、ファイルの更新に必要な手順を、ファイル システムに適用する "*前に*" ジャーナルに記録することによって動作します。 ファイルの更新が成功した場合、これらのログ エントリは削除されます。 しかし、ファイルの更新が中断された場合、ログ エントリはメディアに保存されます。 次にメディアがマウントされたとき、FileX は以前の (未完了の) 書き込み操作からこれらのログ エントリを検出します。 この場合、FileX によってファイル システムに既に加えられた変更がロールバックされるか、必要な変更が再適用されて以前の操作が完了することにより、障害から復旧できます。 FileX フォールト トレラント モジュールはこのようにして、メディアの更新操作中に電源が失われた場合にファイル システムの整合性を維持します。

> [!IMPORTANT]
> *FileX フォールト トレラント モジュールは、有効なデータが含まれた物理メディアの破損を原因とするファイル システムの破損を防ぐようには設計されていません。*

> [!IMPORTANT]
> *FileX フォールト トレラント モジュールでメディアを保護した後は、そのメディアをフォールト トレラントが有効になっている FileX 以外でマウントしないでください。そうした場合、ファイル システム内のログ エントリと、メディア上のシステム情報との整合性が失われる可能性があります。メディアが別のファイル システムによって更新された後に、FileX フォールト トレラント モジュールがログ エントリを処理しようとすると、回復手順が失敗し、ファイル システム全体が予測できない状態になる可能性があります。*

## <a name="use-of-the-fault-tolerant-module"></a>フォールト トレラント モジュールの使用

FileX フォールト トレラント機能は、FileX でサポートされているすべての FAT ファイル システム (FAT12、FAT16、FAT32、exFAT など) で使用できます。 フォールト トレラント機能を有効にするには、シンボル **FX_ENABLE_FAULT_TOLERANT** が定義された状態で FileX がビルドされている必要があります。 アプリケーションは実行時に、_ **_fx_media_open_ *の呼び出しの直後に* _fx_fault_tolerant_enable_** _ を呼び出すことによって、フォールト トレラント サービスを開始します。 フォールト トレラントを有効にすると、指定したメディアに対するすべてのファイル書き込み操作が保護されます。 既定では、フォールト トレラント モジュールは有効になっていません。

> [!IMPORTANT]
> *アプリケーションでは、***fx_fault_tolerant_enable** _ が呼び出される前にファイル システムにアクセスしないようにする必要があります。 フォールト トレラントが有効になる前にアプリケーションによってファイル システムにデータが書き込まれ、かつ以前の書き込み操作が完了していなかった場合、書き込み操作によってメディアが破損し、ファイル システムがフォールト トレラント ログ エントリを使用して復元されない可能性があります。_

## <a name="filex-fault-tolerant-module-log"></a>FileX フォールト トレラント モジュール ログ

FileX フォールト トレラント ログは、フラッシュ内で 1 つの論理クラスターを占有します。 そのクラスターの開始クラスター番号へのインデックスは、メディアのブート セクター内の、**FX_FAULT_TOLERANT_BOOT_INDEX** シンボルで指定されたオフセット位置に記録されます。 既定では、このシンボルは 116 として定義されています。 この場所が選択されている理由は、FAT12/ 16/32 および exFAT の仕様上、予約済みとしてマークされているためです。

図 5 "ログ構造のレイアウト" に、ログ構造の一般的なレイアウトを示しています。 ログ構造には、ログ ヘッダー、FAT チェーン、ログ エントリの 3 つのセクションが含まれています。

> [!IMPORTANT]
> *ログ エントリに格納されているすべてのマルチバイト値は、リトル エンディアン形式です。*

![ログ構造のレイアウト](./media/user-guide/log-structure-layout.png)

**図 5. ログ構造のレイアウト**

ログ ヘッダー領域には、ログ構造全体を記述する情報が含まれており、各フィールドについて詳しく説明しています。

**表 8. ログ ヘッダー領域**

|フィールド|サイズ (byte)|説明|
|-----|--------------|-----------|
|id|4|FileX フォールト トレラント ログ構造を識別します。 ID 値が 0x46544C52 以外の場合、ログ構造は無効と見なされます。|
|総サイズ|2|ログ構造全体の合計サイズ (byte 単位) を示します。|
|ヘッダーのチェックサム|2|ログ ヘッダー領域を変換するチェックサム。 ヘッダー フィールドでチェックサムの検証が失敗した場合、ログ構造は無効と見なされます。|
|バージョン番号|2|FileX フォールト トレラントのメジャーおよびマイナー バージョン番号。|
|予約されています。|2|将来の拡張に使用します。|

ログ ヘッダー領域の後には、FAT チェーン ログ領域が続きます。 図 9 に、FAT チェーンの変更方法を説明する情報を示します。 このログ領域には、ファイルに割り当てられているクラスター、ファイルから削除されたクラスター、および挿入や削除が必要な場所に関する情報が含まれており、FAT チェーン ログ領域の各フィールドについて記述されています。

**表 9. FAT チェーン ログ領域**

|フィールド|サイズ (byte)|説明|
|-----|--------------|-----------|
|FAT チェーン ログのチェックサム|2|FAT チェーン ログ領域全体のチェックサム。 チェックサムの検証に失敗した場合、FAT チェーン ログ領域は無効と見なされます。|
|フラグ|1|有効なフラグの値は次の通りです。<br/>0x01 FAT チェーンが有効です<br />0x02 ビットマップが使用されています|
|予約されています。|1|予約済み|
|挿入ポイント – フロント|4|新しく作成されたチェーンが接続される、(元の FAT チェーンに属している) クラスター。|
|新しい FAT チェーンの先頭クラスター|4|新しく作成された FAT チェーンの最初のクラスター|
|元の FAT チェーンの先頭クラスター|4|元の FAT チェーンのうち、削除される部分の最初のクラスター。|
|挿入ポイント - バック|4|新しく作成された FAT チェーンが接続される元のクラスター。|
|次の削除ポイント|4|このフィールドは、FAT チェーンのクリーンアップ手順を支援します。|

ログ エントリ領域には、障害からの復旧に必要な変更について記述するログ エントリが含まれています。 FileX フォールト トレラント モジュールでサポートされているログ エントリには、FAT ログ エントリ、ディレクトリ ログ エントリ、ビットマップ ログ エントリの 3 種類があります。

以下に示す 3 つの図と 3 つの表で、これらのログ エントリについて詳しく説明します。

![FAT ログ エントリ](./media/user-guide/fat-log-entry.png)

**図 6. FAT ログ エントリ**

**表 10. FAT ログ エントリ**

|フィールド|サイズ (byte)|説明|
|-----|--------------|-----------|
Type|2|エントリの種類。FX_FAULT_TOLERANT_FAT_LOG_TYPE である必要があります|
|サイズ|2|このエントリのサイズ|
|クラスター番号|4|クラスター番号|
|[値]|4|FAT エントリに書き込まれる値|

![ディレクトリ ログ エントリ](./media/user-guide/directory-log-entry.png)

**図 7. ディレクトリ ログ エントリ**

**表 11. ディレクトリ ログ エントリ**

|フィールド|サイズ (byte)|説明|
|-----|--------------|-----------|
|Type|2|エントリの種類。FX_FAULT_TOLERANT_DIRECTORY_LOG_TYPE である必要があります|
|サイズ|2|このエントリのサイズ|
|セクターのオフセット|4|このディレクトリが配置されているセクターへのオフセット (byte 単位)。|
|ログ セクター|4|ディレクトリ エントリが配置されているセクター|
|ログ データ|変数|ディレクトリ エントリの内容|

![ビットマップ ログ エントリ](./media/user-guide/bitmap-log-entry.png)

**図 8. ビットマップ ログ エントリ**

**表 12. ビットマップ ログ エントリ**

|フィールド|サイズ (byte)|説明|
|-----|--------------|-----------|
|Type|2|エントリの種類。FX_FAULT_TOLERANT_BITMAP_LOG_TYPE である必要があります|
|サイズ|2|このエントリのサイズ|
|クラスター番号|4|クラスター番号|
|[値]|4|FAT エントリに書き込まれる値|

## <a name="fault-tolerant-protection"></a>フォールト トレラントな保護

FileX フォールト トレラント モジュールが起動すると、まず最初にメディア内の既存のフォールト トレラント ログ ファイルが検索されます。 有効なログ ファイルが見つからない場合、FileX はメディアが保護されていないと見なします。 この場合、FileX はメディア上にフォールト トレラント ログ ファイルを作成します。

> [!IMPORTANT]
> *FileX フォールト トレラント モジュールが開始する前にファイル システムが破損した場合、FileX ではファイル システムを保護できません。 *

フォールト トレラント ログ ファイルが見つかった場合、FileX は既存のログ エントリを確認します。 ログ ファイルにログ エントリがない場合、以前のファイル操作は成功し、すべてのログ エントリが削除されたことを示します。 この場合、アプリケーションでフォールト トレラントな保護が適用されたファイル システムの使用を開始できます。

しかし、ログ エントリがある場合、FileX は以前のファイル操作を完了するか、ファイル システムに既に適用されている変更を元に戻して、変更を実質的に取り消す必要があります。 どちらの場合でも、ログ エントリがファイル システムに適用された後、ファイル システムは一貫性のある状態に復元され、アプリケーションでファイル システムの使用を再開できます。

FileX によって保護されているメディアの場合、ファイルの更新操作時に、データの部分はメディアに直接書き込まれます。 FileX はデータを書き込む際に、ディレクトリ エントリと FAT テーブルに適用する必要のあるすべての変更も記録します。 この情報は、ファイル トレラント ログ エントリに記録されます。 この方法により、データがメディアに書き込まれた後に、ファイル システムへの更新が行われることが保証されます。 データ書き込みフェーズでメディアが取り出された場合、重要なファイル システム情報はまだ変更されていません。 そのため、ファイル システムは中断の影響を受けません。

すべてのデータがメディアに正常に書き込まれた後、FileX はログ エントリの情報に従い、一度に 1 つのエントリずつ、変更をシステム情報に適用します。 すべてのシステム情報がメディアにコミットされたら、フォールト トレラント ログからログ エントリが削除されます。 この時点で、FileX によるファイルの更新操作が完了します。

ファイルの更新操作時には、ファイルは直接上書き更新されません。 フォールト トレラント モジュールによって、新しいデータを書き込むためのデータ セクターが割り当てられてから、上書きされるデータを含むセクターが削除され、関連する FAT エントリが更新されて新しいセクターがチェーンにリンクされます。 クラスター内の一部のデータを変更する必要がある場合、FileX によって常に新しいクラスターが割り当てられ、古いクラスターのデータ全体が更新されたデータとともに新しいクラスターに書き込まれた後で、古いクラスターが解放されます。 こうすることで、ファイルの更新が中断された場合でも、元のファイルはそのままであることが保証されます。 FileX フォールト トレラント保護が有効である場合、アプリケーションでファイル内のデータを更新する際に、古いデータを含むセクターが解放される前にメディアに新しいデータを保持するのに十分な空き領域が必要であることに注意する必要があります。 メディアに新しいデータを格納するための十分な領域がない場合、更新操作は失敗します。
