---
title: 第 3 章 - Azure RTOS FileX の機能コンポーネント
description: この章では、高パフォーマンスの Azure RTOS FileX 組み込みファイル システムについて、機能の観点から説明します
author: philmea
ms.author: philmea
ms.date: 05/19/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: a94344a7079e3f0e3e451bc678c369fee543aef6
ms.sourcegitcommit: 60ad844b58639d88830f2660ab0c4ff86b92c10f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/07/2021
ms.locfileid: "106550169"
---
# <a name="chapter-3---functional-components-of-azure-rtos-filex"></a>第 3 章 - Azure RTOS FileX の機能コンポーネント

この章では、高パフォーマンスの Azure RTOS FileX 組み込みファイル システムについて、機能の観点から説明します。

## <a name="media-description"></a>メディアの説明

FileX は、FAT ファイル システム形式に準拠した高パフォーマンスの組み込みファイル システムです。 FileX では、物理メディアが論理セクターの配列と見なされます。 これらのセクターを基になる物理メディアにマップする方法は、***fx_media_open*** の呼び出し中に FileX メディアに接続されている I/O ドライバーによって決まります。

### <a name="fat121632-logical-sectors"></a>FAT12、16、32 の論理セクター

メディアの論理セクターの正確な構成は、物理メディアのブート レコードの内容によって決まります。 図 1 に、メディアの論理セクターの一般的なレイアウトを示します。

FileX の論理セクターは、メディアの最初の予約済みセクターを指す論理セクター 1 から始まります。 予約済みセクターはオプションですが、使用時には、通常、ブート コードなどのシステム情報が格納されます。

### <a name="fat121632-media-boot-record"></a>FAT12、16、32 のメディア ブート レコード

メディアの論理セクター ビュー内の他の領域の正確なセクター オフセットは、"*メディア ブート レコード*" の内容から派生しています。 ブート レコードの場所は、通常、セクター 0 です。 ただし、メディアに "*非表示セクター*" がある場合は、ブート セクターへのオフセットがそれらを占める必要があります (これらはブート セクターの直前にあります)。 表 1 では、メディアのブート レコードのコンポーネントの一覧を示し、そのコンポーネントについては短い文章で説明します。

- **ジャンプ命令**: "*ジャンプ命令*" フィールドは、プロセッサのジャンプ用の Intel x86 マシン命令を表す 3 バイトのフィールドです。 これは、ほとんどの場合にレガシ フィールドです。

  ![FileX Media の論理セクター ビュー](./media/user-guide/filex-media-logical-sector-view.png)

  **図 1. FileX Media の論理セクター ビュー**

- **OEM 名**: "*OEM 名*" フィールドは、製造元が自社の名前またはデバイスの名前を配置するために予約されています。
- **1 セクターあたりのバイト数**: メディア ブート レコードの "*1 セクターあたりのバイト数*" フィールドは、各セクターのバイト数 (メディアの基本要素) を定義します。
- **1 クラスターあたりのセクター数**: メディア ブート レコードの "*1 クラスターあたりのセクター数*" フィールドは、クラスターに割り当てられるセクターの数を定義します。 このクラスターは、FAT 互換ファイル システムの基本的な割り当て要素です。 すべてのファイル情報とサブディレクトリは、ファイル アロケーション テーブル (FAT) によって決定される、メディアの利用可能なクラスターから割り当てられます。

    **表 1. FileX のメディア ブート レコード**
    
    |Offset  |フィールド  |バイト数|
    |----------|-----------|------------|
    |0x00|ジャンプ命令 (e9,xx,xx または eb,xx,90)|3|
    |0x03|OEM 名|8|
    |0x0B|1 セクターあたりのバイト数|2|
    |0x0D|1 クラスターあたりのセクター数|1|
    |0x0E|予約済みセクターの数|2|
    |0x10|FAT の数|1|
    |0x11|ルート ディレクトリのサイズ|2|
    |0x13|セクターの数 (FAT-12 および FAT-16)|2|
    |0x15|メディアの種類|1|
    |0x16|FAT あたりのセクター数|2|
    |0x18|1 トラックあたりのセクター数|2|
    |0x1A|ヘッドの数|2|
    |0x1C|非表示セクターの数|4|
    |0x20|セクターの数 (FAT-32)|4|
    |0x24|FAT あたりのセクター数 (FAT-32)|4|
    |0x2C|ルート ディレクトリ クラスター|4|
    |0x3E|システム ブート コード|448
    |0x1FE|0x55AA|2|

- **予約済みセクターの数**: メディア ブート レコードの "*予約済みセクターの数*" フィールドは、ブート レコードと FAT 領域の最初のセクターの間で予約されるセクターの数を定義します。 ほとんどの場合、このエントリは 0 です。
- **FAT の数**: メディア ブート レコードの "*FAT の数*" エントリは、メディア内の FAT の数を定義します。 メディアには常に 1 つ以上の FAT が必要です。 追加の FAT は、プライマリ (1 番目の) FAT の複製コピーにすぎず、通常は診断または復旧ソフトウェアによって使用されます。
- **ルート ディレクトリのサイズ**: メディア ブート レコードの "*ルート ディレクトリのサイズ*" エントリは、メディアのルート ディレクトリに含まれるエントリの定数を定義します。 このフィールドは、サブディレクトリと FAT-32 ルート ディレクトリには適用されません。これらは両方ともメディアのクラスターから割り当てられるためです。
- **セクターの数 (FAT-12 および FAT-16)** : メディア ブート レコードの "*セクターの数*" フィールドには、メディア内のセクターの総数が格納されます。 このフィールドが 0 の場合、セクターの総数は、ブート レコードでこれより後にある "*セクターの数 (FAT-32)* " フィールドに格納されます。
- **メディアの種類**: "*メディアの種類*" フィールドは、デバイス ドライバーに提示されるメディアの種類を識別するために使用されます。 これは、レガシ フィールドです。
- **FAT あたりのセクター数**: メディア ブート レコードの "*FAT あたりのセクター数*" フィールドには、FAT 領域内の各 FAT に関連付けられているセクターの数が格納されます。 FAT セクターの数は、メディアで割り当てることができるクラスターの最大数を占めるのに十分な大きさにする必要があります。
- **1 トラックあたりのセクター数**: メディア ブート レコードの "*1 トラックあたりのセクター数*" フィールドは、トラックあたりのセクター数を定義します。これは、通常、実際のディスク型メディアのみに関連します。 フラッシュ デバイスはこのマッピングを使用しません。
- **ヘッド数**: メディア ブート レコードの "*ヘッド数*" フィールドは、メディア内のヘッド数を定義します。 これは、通常、実際のディスク型メディアにのみ関連します。 フラッシュ デバイスはこのマッピングを使用しません。
- **非表示セクター**: メディア ブート レコードの "*非表示セクター*" フィールドは、ブート レコードの前にあるセクター数を定義します。 このフィールドは、**FX_MEDIA** 制御ブロック内に保持され、FileX によって行われるすべての読み取りおよび書き込み要求の FileX I/O ドライバー内で考慮する必要があります。
- **セクターの数 (FAT-32)** : メディア ブート レコードの "*セクターの数*" フィールドは、2 バイトの "*セクターの数*" フィールドが 0 の場合にのみ有効です。 このような場合、この 4 バイトのフィールドには、メディア内のセクターの数が格納されます。
- **FAT あたりのセクター数 (FAT-32)** : "*FAT あたりのセクター数 (FAT-32)* " フィールドは、FAT-32 形式でのみ有効です。メディアの各 FAT に割り当てられるセクターの数が格納されます。
- **ルート ディレクトリ クラスター**: "*ルート ディレクトリ クラスター*" フィールドは、FAT-32 形式でのみ有効です。ルート ディレクトリの開始クラスター番号が格納されます。
- **システム ブート コード**: "*システム ブート コード*" フィールドは、ブート コードの一部を格納する領域です。 今日のほとんどのデバイスでは、これはレガシ フィールドです。
- **シグネチャ 0x55AA**: "*シグネチャ*" フィールドは、ブート レコードを識別するために使用されるデータ パターンです。 このフィールドが存在しない場合、ブート レコードは無効です。

### <a name="exfat"></a>exFAT

FAT32 での最大ファイル サイズは 4 GB です。これは、高解像度のマルチメディア ファイルの幅広い導入を制限するものです。 既定では、FAT32 でサポートされるストレージ メディアは最大 32 GB です。 フラッシュと SD カードの容量の増加に伴い、FAT32 では、大容量ボリュームを管理する際の効率が低下します。 exFAT は、これらの制限を克服するために設計されています。 exFAT では、最大 1 エクサバイト (EB) (約 10 億 GB) のファイル サイズがサポートされます。 exFAT と FAT32 のもう 1 つの大きな違いとして、exFAT では、ビットマップを使用してボリューム内の使用可能な領域が管理されます。これにより、exFAT では、ファイルにデータを書き込むときに使用可能な領域をより効率的に見つけることができます。 連続したクラスターに保存されているファイルの場合、exFAT では、FAT チェーンをたどってすべてのクラスターを見つける必要がないため、大きなファイルにより効率的にアクセスできます。 32 GB を超えるフラッシュ ストレージおよび SD カードには exFAT が必要です。

### <a name="exfat-logical-sectors"></a>exFAT の論理セクター

図 2 に、exFAT でのメディアの論理セクターの一般的なレイアウトを示します。 exFAT では、ブート ブロックと FAT 領域はシステム領域に属しています。 残りのクラスターはユーザー領域です。 必須ではありませんが、exFAT 標準では、アロケーション ビットマップをユーザー領域の先頭に配置し、その後に大文字変換テーブルとルート ディレクトリを配置することが推奨されています。

### <a name="exfat-media-boot-record"></a>exFAT のメディア ブート レコード

exFAT のメディア ブート レコードの内容は、FAT12、16、32 のものとは異なります。 これらを表 2 に示します。 exFAT では、混乱を防ぐために、FAT12、16、32 のさまざまなメディア パラメーターを含む 0x0B と 0x40 の間の領域が "*予約済み*" としてマークされています。 この予約済み領域は、メディア ブート レコードを誤って解釈することを避けるために、0 でプログラミングする必要があります。

![exFAT の論理セクター](./media/user-guide/exfat-logical-sectors.png)

**図 2. exFAT の論理セクター**

- **ジャンプ命令**: "*ジャンプ命令*" フィールドは、プロセッサのジャンプ用の Intel x86 マシン命令を表す 3 バイトのフィールドです。 これは、ほとんどの場合にレガシ フィールドです。

    **表 2. exFAT のメディア ブート レコード**

    |Offset  |フィールド  |バイト数|
    |----------|-----------|------------|
    |0x00|ジャンプ命令|3|
    |0x03|ファイル システム名|8|
    |0x0B|予約されています。|53|
    |0x40|パーティション オフセット|8|
    |0x48|ボリュームの長さ|8|
    |0x50|FAT オフセット|4|
    |0x54|FAT の長さ|4|
    |0x58|クラスター ヒープ オフセット|4|
    |0x5C|クラスター数|4|
    |0x60|ルート ディレクトリの最初のクラスター|4|
    |0x64|ボリュームのシリアル番号|4|
    |0x68|ファイル システムのリビジョン|2|
    |0x6A|ボリューム フラグ|2|
    |0x6C|セクターあたりのバイト数のシフト|1|
    |0x6D|クラスターあたりのセクター数のシフト|1|
    |0x6E|FAT の数|1|
    |0x6F|ドライブの選択|1|
    |0x70|使用率|7|
    |0x71|予約されています。|1|
    |0x78|ブート コード|390|
    |0x1FE|ブート シグネチャ|2|

- **ファイル システム名**: exFAT の場合、"*ファイル システム名*" フィールドの内容は、"EXFAT" とそれに続く 3 つの空白である必要があります。
- **予約済み**: "*予約済み*" フィールドの内容は 0 である必要があります。 この領域は、FAT12、16、32 のブート レコードと重複しています。 この領域を 0 にすると、ファイル システムがこのボリュームを誤って解釈するのを防ぐことができます。
- **パーティション オフセット**: "*パーティション オフセット*" フィールドは、このパーティションの開始を示します。
- **ボリュームの長さ**: "*ボリュームの長さ*" フィールドは、このパーティションのサイズをセクター数で定義します。
- **FAT オフセット**: "*FAT オフセット*" フィールドは、このパーティションの先頭を基準にして、このパーティションの FAT テーブルの開始セクター番号を定義します。
- **FAT の長さ**: "*FAT の長さ*" フィールドは、FAT テーブルのサイズをセクター数で定義します。
- **クラスター ヒープ オフセット**: "*クラスター ヒープ オフセット*" フィールドは、パーティションの先頭を基準にして、クラスター ヒープの開始セクター番号を定義します。 クラスター ヒープは、ディレクトリ情報とファイル データが格納される領域です。
- **クラスター数**: "*クラスター数*" フィールドは、このパーティションに含まれるクラスターの数を定義します。
- **ルート ディレクトリの最初のクラスター**: "*ルート ディレクトリの最初のクラスター*" フィールドは、ルート ディレクトリの開始位置を定義します。これは、アロケーション ビットマップと大文字変換テーブルの直後に配置することが推奨されています。
- **ボリュームのシリアル番号**: "*ボリュームのシリアル番号*" フィールドは、このパーティションのシリアル番号を定義します。
- **ファイル システムのリビジョン**: "*ファイル システムのリビジョン*" フィールドは、exFAT のメジャー バージョンとマイナー バージョンを定義します。
- **ボリューム フラグ**: "*ボリューム フラグ*" フィールドには、このボリュームの状態を示すフラグが含まれます。
- **セクターあたりのバイト数のシフト**: "*セクターあたりのバイト数のシフト*" フィールドは、セクターあたりのバイト数を log2(n) として定義します。ここで、n は、セクターあたりのバイト数です。 たとえば、SD カードでは、セクター サイズは 512 バイトです。 したがって、このフィールドは 9 (log2(512) = 9) になります。
- **クラスターあたりのセクター数のシフト**: "*クラスターあたりのセクター数のシフト*" フィールドは、クラスター内のセクター数を log2(n) として定義します。ここで、n は、クラスターあたりのセクター数です。
- **FAT の数**: "*FAT の数*" フィールドは、このパーティション内の FAT テーブルの数を定義します。 exFAT の場合、値を 1 (1 つの FAT テーブルを表します) にすることが推奨されています。
- **ドライブの選択**: "*ドライブの選択*" フィールドは、拡張 INT 13h ドライブ番号を定義します。
- **使用率**: "*使用率*" フィールドは、クラスター ヒープ内の割り当てられているクラスターの割合を定義します。 有効な値は 0 から 100 です。
- **予約済み**: このフィールドは将来の使用のために予約されています。
- **ブート コード**: "*ブート コード*" フィールドは、ブート コードの一部を格納する領域です。 今日のほとんどのデバイスでは、これはレガシ フィールドです。
- **シグネチャ 0x55AA**: "*ブート シグネチャ*" フィールドは、ブート レコードを識別するために使用されるデータ パターンです。 このフィールドが存在しない場合、ブート レコードは無効です。

### <a name="file-allocation-table-fat"></a>ファイル アロケーション テーブル (FAT)

"*ファイル アロケーション テーブル (FAT)* " は、メディアの予約済みセクターの後から開始されます。 FAT 領域は、基本的には、クラスターが割り当て済みであるか、サブディレクトリまたはファイルを構成するクラスターのチェーンの一部であるかを判定する、12 ビット、16 ビット、または 32 ビットのエントリの配列です。 各 FAT エントリのサイズは、表す必要があるクラスターの数によって決まります。 クラスターの数 (セクターの総数をクラスターあたりのセクター数で割ったもの) が 4,086 個以下の場合は、12 ビットの FAT エントリが使用されます。 クラスターの総数が 4,086 個を超え 65,525 個に満たない場合は、16 ビットの FAT エントリが使用されます。 それ以外でクラスターの総数が 65,525 個以上の場合は、32 ビット FAT または exFAT が使用されます。

FAT12、16、32 の場合、FAT テーブルは、クラスター チェーンを保持するだけでなく、クラスターの割り当てに関する情報 (クラスターが使用可能かどうか) も提供します。 exFAT では、クラスターの割り当て情報は、アロケーション ビットマップ ディレクトリ エントリによって保持されます。 各パーティションには、独自のアロケーション ビットマップがあります。 ビットマップは、使用可能なすべてのクラスターを対象とするのに十分な大きさを持ちます。 クラスターを割り当てに使用できる場合、アロケーション ビットマップの対応するビットが 0 に設定されます。 それ以外の場合、ビットは 1 に設定されます。 連続するクラスターが占有されるファイルの場合、exFAT では、すべてのクラスターを追跡するために FAT チェーンを必要としません。 ただし、連続するクラスターが占有されないファイルの場合は、FAT チェーンを保持する必要があります。

### <a name="fat-entry-contents"></a>FAT エントリの内容

FAT テーブルの最初の 2 つのエントリは使用されず、通常は次の内容が含まれます。

|FAT エントリ |12 ビット FAT|16 ビット FAT|32 ビット FAT| exFAT|
|----------|-----------|------------|-------|------|
|エントリ 0|0x0F0|0x00F0|0x000000F0|0xF8FFFFFF|
|エントリ 1|0xFFF|0xFFFF|0x0FFFFFFF|0xFFFFFFFF|

FAT エントリ番号 2 は、メディアのデータ領域の最初のクラスターを表します。 各クラスター エントリの内容によって、それが空であるか、ファイルまたはサブディレクトリに割り当てられたクラスターのリンク リストの一部であるかが判定されます。 クラスター エントリに別の有効なクラスター エントリが含まれている場合は、クラスターが割り当てられていて、その値はクラスター チェーン内で割り当てられている次のクラスターを指します。

使用可能なクラスター エントリは、次のように定義されます。

|説明|12 ビット FAT|16 ビット FAT|32 ビット FAT| exFAT|
|----------|-----------|------------|-------|------|
|空きクラスター|0x000|0x0000|0x00000000|0x00000000|
|未使用|0x001|0x0001|0x00000001|0x00000001|
|予約されています。|0xFF0 から FF6|0xFFF0 から FFF6|0x0FFFFFF0 から 6|ClusterCounter +2 から 0xFFFFFFF6|
|無効なクラスター|0xFF7|0xFFF7|0x0FFFFFF7|0xFFFFFFF7|
|予約されています。| - | - | - | 0xFFFFFFF8 から E|
|最後のクラスター| 0xFF8 から FFF| 0xFFF8 から FFFF| 0x0FFFFFF8 から F| 0xFFFFFFFF|
|クラスター リンク| 0x002 から 0xFEF| 0x0002 から FFEF| 0x2 から 0x0FFFFFEF | 0x2 から ClusterCount + 1|

割り当てられたクラスター チェーンの最後のクラスターには、(上で定義した) 最後のクラスターの値が含まれます。 最初のクラスター番号は、ファイルまたはサブディレクトリのディレクトリ エントリに見つかります。

### <a name="internal-logical-cache"></a>内部論理キャッシュ

FileX では、開かれたメディアごとに "*最近使用された*" 論理セクター キャッシュが保持されます。 論理セクター キャッシュの最大サイズは、**_fx_api.h_** 内の定数 **FX_MAX_SECTOR_CACHE** によって定義されます。 これは、内部論理セクター キャッシュのサイズを判定する最初の要素です。

論理セクター キャッシュのサイズを決定するもう 1 つの要素は、アプリケーションによって ***fx_media_open** _ 呼び出しに渡されるメモリの量です。 少なくとも 1 つの論理セクターに十分なメモリが必要です。 _ *FX_MAX_SECTOR_CACHE** を超える論理セクターが必要な場合は、**_fx_api.h_** 内の定数を変更した後、FileX ライブラリ全体を再構築する必要があります。

> [!IMPORTANT]
> "*オープン呼び出し中に指定されたメモリに応じて、FileX で開かれた各メディアのキャッシュ サイズが異なる場合があります。* "

### <a name="write-protect"></a>書き込み保護

FileX では、メディアに対して書き込み保護を動的に設定する機能がアプリケーション ドライバーに提供されます。 書き込み保護が必要な場合、ドライバーは、関連付けられた FX_MEDIA 構造体の *fx_media_driver_write_protect* フィールドを FX_TRUE に設定します。 設定すると、アプリケーションがメディアを変更しようとする試みがすべて拒否されるだけでなく、書き込み用にファイルを開こうとする試みも拒否されます。 ドライバーは、このフィールドを解除することにより、書き込み保護を無効にすることもできます。

### <a name="free-sector-update"></a>空きセクターの更新

FileX には、セクターが使用されなくなったときにアプリケーション ドライバーに通知するメカニズムがあります。 これは、FileX によって使用されているすべての論理セクターを管理するフラッシュ メモリ マネージャーに特に役立ちます。

空きセクターの通知が必要な場合、アプリケーション ドライバーは、関連付けられた FX_MEDIA 構造体の *fx_media_driver_free_sector_update* フィールドを FX_TRUE に設定します。 この割り当ては、通常、ドライバーの初期化中に行われます。

このフィールドが設定されると、FileX により、1 つ以上の連続するセクターが空きセクターになったことを示す **FX_DRIVER_RELEASE_SECTORS** ドライバー呼び出しが行われます。

### <a name="media-control-block-fx_media"></a>メディア制御ブロック FX_MEDIA

FileX で開かれている各メディアの特性は、メディア制御ブロックに含まれています。 この構造体は ***fx_api.h*** ファイルに定義されています。

メディア制御ブロックは、メモリ内の任意の場所に配置できますが、最も一般的なのは、制御ブロックを任意の関数のスコープ外に定義してグローバルな構造体にすることです。

動的に割り当てられたすべてのメモリと同様に、他の領域に制御ブロックを配置するにはもう少し注意が必要です。 制御ブロックが C 関数内に割り当てられている場合、それに関連付けられているメモリは、呼び出し元スレッドのスタックの一部になります。

> [!WARNING]
>"*一般に、制御ブロックにローカル ストレージを使用することは避けてください。これは、関数から制御が返された後、そのローカル変数スタック領域が、まだ使用中かどうかに関係なくすべて解放されるためです。* "

## <a name="fat121632-directory-description"></a>**FAT12、16、32 のディレクトリの説明**

FileX では、8.3 と Windows の長いファイル名 (LFN) の両方の名前形式がサポートされています。 名前に加えて、各ディレクトリ エントリには、エントリの属性、最終変更時刻と日付、開始クラスター インデックス、およびエントリのサイズ (バイト単位) が含まれます。 表 3 に、FileX の 8.3 ディレクトリ エントリの内容とサイズを示します。

- **ディレクトリ名**

    FileX では、1 から 255 文字のファイル名がサポートされます。 標準の 8 文字のファイル名は、メディア上の 1 つのディレクトリ エントリで表されます。 これらはディレクトリ名フィールドで左寄せされ、空白で埋められます。 また、名前を構成する ASCII 文字は常に大文字になります。

    長いファイル名 (LFN) は、連続するディレクトリ エントリによって逆の順序で表され、その直後に 8.3 標準ファイル名が続きます。 作成された 8.3 名には、その名前に関連付けられているすべての意味のあるディレクトリ情報が含まれます。 表 4 は、長いファイル名情報を保持するために使用されるディレクトリ エントリの内容を示しています。表 5 は、4 つのディレクトリ エントリをまとめたものを必要とする 39 文字の LFN の例を示しています。

> [!IMPORTANT]
> "***fx_api.h** で定義されている定数 **FX_MAX_LONG_NAME_LEN** には、FileX でサポートされる最大長が含まれます。* "

- **ディレクトリ ファイル名拡張子**

    標準の 8.3 ファイル名については、FileX では、省略可能な 3 文字の "*ディレクトリ ファイル名拡張子*" もサポートされます。 8 文字のファイル名と同様に、ファイル名拡張子は、ディレクトリ ファイル名拡張子フィールドで左寄せされ、空白で埋められ、常に大文字になります。

    **表 3. FileX の 8.3 ディレクトリ エントリ**

    |Offset|フィールド|バイト数|
    |------------|-----------|------------|
    |0x00|ディレクトリ エントリ名|8|
    |0x08|ディレクトリ拡張|3|
    |0x0B|属性|1|
    |0x0C|NT (長いファイル名形式で導入され、NT 用に予約されています [常に 0])|1|
    |0x0D|ミリ秒単位の作成時間 (長いファイル名形式で導入され、ファイルが作成されたときのミリ秒数を表します)。|1|
    |0x0E|時間と分単位の作成時間 (長いファイル名形式で導入され、ファイルが作成されたときの時間と分を表します)。|2|
    |0x10|作成日 (長いファイル名形式で導入され、ファイルが作成されたときの日付を表します)。|2|
    |0x12|最終アクセス日 (長いファイル名形式で導入され、ファイルが最後にアクセスされた日付を表します)。|2|
    |0x14|開始クラスター (上位 16 ビット、FAT-32 のみ)|2|
    |0x16|更新時刻|2|
    |0x18|更新日|2|
    |0x1A|開始クラスター (下位 16 ビット、FAT-32 または FAT-12 または FAT-16)|2|
    |0x1C|ファイル サイズ|4|


- **ディレクトリ属性**

    1 バイトの "*ディレクトリ属性*" フィールド エントリには、ディレクトリ エントリのさまざまなプロパティを指定する一連のビットが含まれます。 ディレクトリ属性の定義は次のとおりです。

    |属性ビット|説明|
    |------------|-----------|
    |0x01|エントリは読み取り専用です。|
    |0x02|エントリは非表示です。|
    |0x04|エントリはシステム エントリです。|
    |0x08|エントリはボリューム ラベルです|
    |0x10|エントリはディレクトリです。|
    |0x20|エントリが変更されました。|

    すべての属性ビットは相互に排他的であるため、一度に複数の属性ビットが設定されている可能性があります。

- **ディレクトリ時間**

    2 バイトの "*ディレクトリ時間*" フィールドには、指定されたディレクトリ エントリが最後に変更された時間、分、および秒が含まれます。 ビット 15 から 11 には時間が含まれます。ビット 10 から 5 には分が含まれます。ビット 4 から 0 には 0.5 秒が含まれます。 実際の秒数は、このフィールドに書き込まれる前に 2 で除算されます。

- **ディレクトリ日付**

    2 バイトの "*ディレクトリ日付*" フィールドには、指定されたディレクトリ エントリが最後に変更された年 (1980 年からのオフセット)、月、および日が含まれます。 ビット 15 から 9 には年のオフセットが含まれます。ビット 8 から 5 には月のオフセットが含まれます。ビット 4 から 0 には日が含まれます。

- **ディレクトリ開始クラスター**

    FAT-12 および FAT-16 の場合、このフィールドは 2 バイトを占有します。 FAT-32 の場合、このフィールドは 4 バイトを占有します。 このフィールドには、エントリ (サブディレクトリまたはファイル) に割り当てられた最初のクラスター番号が含まれます。

    > [!NOTE]
    > *FileX では初期クラスターなしで新しいファイルが作成されることに注意してください (開始クラスター フィールド = 0)。これにより、ユーザーは、必要に応じて、新しく作成されたファイルに連続した数のクラスターを割り当てることができます。 *

- **ディレクトリ ファイル サイズ**

    4 バイトの "*ディレクトリ* *ファイル サイズ*" フィールドには、ファイルのバイト数が含まれます。 エントリが実際にはサブディレクトリの場合、サイズ フィールドは 0 になります。

### <a name="long-file-name-directory"></a>長いファイル名ディレクトリ

- **Ordinal**

    LFN エントリの番号を指定する 1 バイトの "*序数*" フィールド。 LFN エントリは逆順に配置されるため、単一の LFN を構成する LFN ディレクトリ エントリの序数値は 1 少なくなります。 さらに、8.3 ファイル名の直前にある LFN の序数値は 1 である必要があります。

    **表 4. 長いファイル名ディレクトリ エントリ**

    | Offset | フィールド | バイト数 |
    |------------|-----------|------------|
    | 0x00 | 序数フィールド | 1 |
    | 0x01 | Unicode 文字 1 | 2 |
    | 0x03 | Unicode 文字 2 | 2 |
    | 0x05 | Unicode 文字 3 | 2 |
    | 0x07 | Unicode 文字 4 | 2 |
    | 0x09 | Unicode 文字 5 | 2 |
    | 0x0B | LFN 属性 | 1 |
    | 0x0C | LFN の種類 (予約済み。常に 0) | 1 |
    | 0x0D | LFN チェックサム | 1 |
    | 0x0E | Unicode 文字 6 | 2 | 
    | 0x10 | Unicode 文字 7 | 2 |
    | 0x12 | Unicode 文字 8 | 2 |
    | 0x14 | Unicode 文字 9 | 2 |
    | 0x16 | Unicode 文字 10 | 2 |
    | 0x18 | Unicode 文字 11 | 2 |
    | 0x1A | LFN クラスター (使用しない。常に 0) | 2 |
    | 0x1C | Unicode 文字 12 | 2 |
    | 0x1E | Unicode 文字 13 | 2 |

- **Unicode 文字**

    2 バイトの "*Unicode 文字*" フィールドは、多くの異なる言語の文字をサポートするように設計されています。 標準 ASCII 文字は、Unicode 文字の最初のバイトに格納されている ASCII 文字とそれに続く空白文字で表されます。

- **LFN 属性**

    1 バイトの "*LFN 属性*" フィールドには、ディレクトリ エントリを LFN ディレクトリ エントリとして識別する属性が含まれます。 これは、読み取り専用、システム、非表示、およびボリュームの属性をすべて設定することによって実現されます。

- **LFN の種類**

    1 バイトの "*LFN の種類*" フィールドは予約されており、常に 0 です。

- **LFN チェックサム**

    1 バイトの "*LFN チェックサム*" フィールドは、関連付けられている MSDOS 8.3 ファイル名の 11 文字のチェックサムを表します。 このチェックサムは、LFN エントリが適切な 8.3 ファイル名に対応していることを確認するために、各 LFN エントリに格納されます。

- **LFN クラスター**

    2 バイトの "*LFN クラスター*" フィールドは使用されておらず、常に 0 です。

    **表 5. 39 文字の LFN を構成するディレクトリ エントリ**

    |入力|説明|
    |------------|-----------|
    |1|LFN ディレクトリ エントリ 3|
    |2|LFN ディレクトリ エントリ 2|
    |3|LFN ディレクトリ エントリ 1|
    |4|8.3 ディレクトリ エントリ (ttttt~n.xx)|

### <a name="exfat-directory-description"></a>exFAT のディレクトリの説明

exFAT ファイル システムでは、ディレクトリ エントリとファイル名が異なる方法で格納されます。 ディレクトリ エントリには、エントリの属性や、エントリが作成、変更、およびアクセスされたときのさまざまなタイムスタンプが含まれます。 ファイル サイズや開始クラスターなどの他の情報は、プライマリ ディレクトリ エントリの直後にあるストリーム拡張ディレクトリ エントリに格納されます。 exFAT では、長いファイル名 (LFN) 名形式のみがサポートされます。 これは、表 2 に示すように、ファイル名ディレクトリ エントリの直後にあるストリーム拡張ディレクトリ エントリに格納されます。

### <a name="exfat-file-directory-entry"></a>exFAT ファイル ディレクトリ エントリ

exFAT ファイル ディレクトリ エントリとその内容について、次の表と段落で説明します。

- **[エントリの種類]**

    エントリの種類フィールドは、このエントリの種類を示します。 ファイル ディレクトリ エントリの場合、このフィールドは 0x85 である必要があります。

- **セカンダリ エントリの数**

    "*セカンダリ エントリの数*" フィールドは、このプライマリ エントリの直後にあるセカンダリ エントリの数を示します。 ファイル ディレクトリ エントリに関連付けられたセカンダリ エントリには、1 つのストリーム拡張ディレクトリ エントリと 1 つ以上のファイル名ディレクトリ エントリが含まれます。

    **表 6. exFAT ファイル ディレクトリ エントリ**

    |Offset|フィールド|バイト数|
    |----|-----------|-|
    |0x00|[エントリの種類]|1|
    |0x01|セカンダリ エントリ|1|
    |0x02|Checksum|2|
    |0x04|ファイル属性|2|
    |0x06|予約済み 1|2|
    |0x08|[タイムスタンプの作成]|4|
    |0x0C|最終変更タイムスタンプ|4|
    |0x10|最終アクセス タイムスタンプ|4|
    |0x14|作成 (10 ミリ秒増分)|1|
    |0x15|最終変更 (10 ミリ秒増分)|1|
    |0x16|作成 (UTC オフセット)|1|
    |0x17|最終変更 (UTC オフセット)|1|
    |0x18|最終アクセス (UTC オフセット)|1|
    |0x19|予約済み 2|7|

- **チェックサム**

    "*チェックサム*" フィールドには、ディレクトリ エントリ セット内のすべてのエントリ (ファイル ディレクトリ エントリとそのセカンダリ エントリ) に対するチェックサムの値が含まれます。

- **ファイル属性**

    1 バイトの属性フィールド エントリには、ディレクトリ エントリのさまざまなプロパティを指定する一連のビットが含まれます。 ほとんどの属性ビットの定義は、FAT 12、16、32 と同じです。 ディレクトリ属性の定義は次のとおりです。

    |属性ビット|説明|
    |------------|-----------|
    |0x01| エントリは読み取り専用です|
    |0x02|エントリは非表示です|
    |0x04|エントリはシステム エントリです|
    |0x08|エントリは予約されています|
    |0x10|エントリはディレクトリです|
    |0x20|エントリが変更されました|
    |他のすべてのビット|予約されています。|

- **Reserved1**

    このフィールドは 0 である必要があります。

- **[タイムスタンプの作成]**

    "*作成タイムスタンプ*" フィールドと "*作成 (10 ミリ秒増分)* " フィールドの情報を組み合わせて、ファイルまたはディレクトリが作成された現地の日付と時刻を記述します。

- **最終変更タイムスタンプ**

    "*最終変更タイムスタンプ*" フィールドと "*最終変更 (10 ミリ秒増分)* " フィールドの情報を組み合わせて、ファイルまたはディレクトリが最後に変更された現地の日付と時刻を記述します。 タイムスタンプについては、以下のメモを参照してください。

- **最終アクセス タイムスタンプ**

    "*最終アクセス タイムスタンプ*" フィールドは、ファイルまたはディレクトリが最後にアクセスされた現地の日付と時刻を記述します。 タイムスタンプについては、以下のメモを参照してください。

- **作成 (10 ミリ秒増分)**

    "*作成 (10 ミリ秒増分)* " フィールドと "*作成タイムスタンプ*" フィールドの情報を組み合わせて、ファイルまたはディレクトリが作成された現地の日付と時刻を記述します。 タイムスタンプについては、以下のメモを参照してください。

- **最終変更 (10 ミリ秒増分)**

    "*最終変更 (10 ミリ秒増分)* " フィールドと "*最終変更タイムスタンプ*" フィールドの情報を組み合わせて、ファイルまたはディレクトリが最後に変更された現地の日付と時刻を記述します。 タイムスタンプについては、以下のメモを参照してください。

- **作成 (UTC オフセット)**

    "*作成 (UTC オフセット)* " フィールドは、ファイルまたはディレクトリが作成されたときの現地時刻と UTC 時刻の差を記述します。 タイムスタンプについては、以下のメモを参照してください。

- **最終変更 (UTC オフセット)**

    "*最終変更 (UTC オフセット)* " フィールドは、ファイルまたはディレクトリが最後に変更されたときの現地時刻と UTC 時刻の差を記述します。 タイムスタンプについては、以下のメモを参照してください。

- **最終アクセス (UTC オフセット)**

    "*最終アクセス (UTC オフセット)* " フィールドは、ファイルまたはディレクトリが最後にアクセスされたときの現地時刻と UTC 時刻の差を記述します。 タイムスタンプについては、以下のメモを参照してください。

- **Reserved2**

    このフィールドは 0 である必要があります。

### <a name="notes-on-timestamps"></a>タイムスタンプに関するメモ

- **タイムスタンプ エントリ**: タイムスタンプ フィールドは次のように解釈されます。

- **10 ミリ秒増分フィールド**: 10 ミリ秒増分フィールドの値により、タイムスタンプ値により細かな細分性が提供されます。 有効な値は、0 (0 ミリ秒) から 199 (1,990 ミリ秒) です。

     ![10 ミリ秒増分フィールド](./media/user-guide/10ms-increment-fields.png)

- **UTC オフセット フィールド**

     ![UTC オフセット フィールド](./media/user-guide/utc-offset-field.png)

- **オフセット値**

    7 ビット符号付き整数は、UTC 時刻からのオフセットを 15 分単位で表します。

- **有効**

    オフセット フィールドの値が有効かどうか。 0 は、オフセット値フィールドの値が無効であることを示します。 1 は、値が有効であることを示します。

### <a name="stream-extension-directory-entry"></a>ストリーム拡張ディレクトリ エントリ

ストリーム拡張ディレクトリ エントリとその内容について、次の表で説明します。

**表 7. ストリーム拡張ディレクトリ エントリ**

|Offset|フィールド| バイト数|
|------------|-----------|-------|
|0x00|[エントリの種類]|1|
|0x01|フラグ|1|
|0x02|予約済み 1|1|
|0x03|名前の長さ|1|
|0x04|名前ハッシュ|2|
|0x06|予約済み 2|2|
|0x08|有効なデータの長さ|8|
|0x10|予約済み 3|4|
|0x14|最初のクラスター|4|
|0x18|データの長さ|8|

- **[エントリの種類]**

    "*エントリの種類*" フィールドは、このエントリの種類を示します。 ストリーミング拡張ディレクトリ エントリの場合、このフィールドは 0xC0 である必要があります。

- **フラグ**

    このフィールドには、さまざまなプロパティを指定する一連のビットが含まれています。
    
    |フラグ ビット|説明    |
    |-----------------|-----------|
    |0x01            |このフィールドは、クラスターの割り当てが可能かどうかを示します。 このフィールドは 1 である必要があります。|
    |0x02            |このフィールドは、関連付けられているクラスターが連続しているかどうかを示します。 値 0 は、FAT エントリが有効であり、FileX が FAT チェーンに従うことを意味します。 値 1 は、FAT エントリが無効であり、クラスターが連続していることを意味します。|
    |他のすべてのビット    |予約済み。|

- **予約済み 1**

    このフィールドは 0 である必要があります。

- **名前の長さ**

    "*名前の長さ*" フィールドには、ファイル名ディレクトリ エントリに集合的に含まれる Unicode 文字列の長さが含まれます。 ファイル名ディレクトリ エントリは、このストリーム拡張ディレクトリ エントリの直後に続く必要があります。

- **名前ハッシュ**

    "*名前ハッシュ*" フィールドは、大文字のファイル名のハッシュ値が含まれる 2 バイトのエントリです。 ハッシュ値により、ファイルまたはディレクトリ名の検索が高速になります。ハッシュ値が一致しない場合、このエントリに関連付けられているファイル名は一致しません。

- **予約済み 2**

    このフィールドは 0 である必要があります。

- **有効なデータの長さ**

    "*有効なデータの長さ*" フィールドは、ファイル内の有効なデータの量を示します。

- **予約済み 3**

    このフィールドは 0 である必要があります。

- **最初のクラスター**

    "*最初のクラスター*" フィールドには、データ ストリームの最初のクラスターのインデックスが含まれます。

- **データの長さ**

    "*データの長さ*" フィールドには、割り当てられたクラスターの合計バイト数が含まれます。 exFAT ではデータ クラスターの事前割り当てが可能であるため、この値は "*有効なデータの長さ*" よりも大きくなる可能性があります。

### <a name="root-directory"></a>[ルート ディレクトリ]

FAT 12 ビットおよび 16 ビット形式では、"*ルート ディレクトリ*" は、メディア内のすべての FAT セクターの直後に配置され、開いている _ *FX_MEDIA** 制御ブロックの ***fx_media_root_sector_start** _ を調べることによって見つけることができます。 ディレクトリ エントリの数 (それぞれ 32 バイトのサイズ) の観点からのルート ディレクトリのサイズは、メディアのブート レコードの対応するエントリによって決定されます。

FAT-32 および exFAT のルート ディレクトリは、使用可能なクラスター内の任意の場所に配置できます。 その場所とサイズは、メディアが開かれたときにブート レコードから決定されます。 メディアが開かれた後、***fx_media_root_sector_start*** フィールドを使用して、FAT-32 または exFAT ルート ディレクトリの開始クラスターを見つけることができます。

### <a name="subdirectories"></a>［サブディレクトリ］

FAT システムには、任意の数のサブディレクトリがあります。 サブディレクトリの名前は、ファイル名と同じようにディレクトリ エントリに格納されます。 ただし、ディレクトリ属性仕様 (0x10) は、エントリがサブディレクトリであり、ファイル サイズが常に 0 であることを示すように設定されています。
図 3 は、_*_FILE.TXT_** という名前のファイルが 1 つ含まれている ***SAMPLE.DIR** _ という名前の新しい単一クラスター サブディレクトリの典型的なサブディレクトリ構造を示しています。
ほとんどの点で、サブディレクトリはファイル エントリとよく似ています。 最初のクラスター フィールドは、クラスターのリンク リストの最初のクラスターを指します。 サブディレクトリが作成されると、最初の 2 つのディレクトリ エントリに、既定のディレクトリ (つまり、"." ディレクトリと ".." ディレクトリ) が格納されます。 "." ディレクトリはサブディレクトリ自体を指し、".." ディレクトリは前のディレクトリまたは親ディレクトリを指します。

### <a name="global-default-path"></a>グローバルな既定のパス

FileX は、メディアのグローバルな既定のパスを提供します。 既定のパスは、完全なパスが明示的に指定されていないファイルまたはディレクトリ サービスで使用されます。

最初に、グローバルな既定のディレクトリは、メディアのルート ディレクトリに設定されます。 これは、アプリケーションで ***fx_directory_default_set*** を呼び出すことによって変更することができます。

メディアの現在の既定のパスは、***fx_directory_default_get** _ を呼び出すことによって調べることができます。 このルーチンは、_ *FX_MEDIA** 制御ブロック内に保持されている既定のパス文字列を指す文字列ポインターを提供します。

### <a name="local-default-path"></a>ローカルの既定のパス

FileX では、スレッドに固有の既定のパスも提供されます。これにより、競合が発生することなく、さまざまなスレッドには一意のパスを設定できます。 **FX_LOCAL_PATH** 構造体は、**_fx_directory_local_path_set_ *_ および _* _fx_directory_local_path_restore_** の呼び出し中に呼び出し元のスレッドのローカル パスを変更するために、アプリケーションによって提供されます。

ローカル パスが存在する場合、ローカル パスはグローバルな既定のメディア パスよりも優先されます。 ローカル パスが設定されていない場合、または ***fx_directory_local_path_clear*** サービスでクリアされている場合は、メディアのグローバルな既定のパスが再び使用されます。

## <a name="file-description"></a>ファイルの説明

FileX では、3 文字の拡張子を含む標準の 8.3 文字と長いファイル名がサポートされています。 ASCII 名に加えて、各ファイル エントリには、エントリの属性、最終変更時刻と日付、開始クラスター インデックス、およびエントリのサイズ (バイト単位) が含まれます。

### <a name="file-allocation"></a>ファイルの割り当て

FileX では、FAT 形式の標準のクラスター割り当てスキームがサポートされています。 さらに、FileX では、連続するクラスターの事前クラスター割り当てがサポートされています。 これに対応するために、各 FileX ファイルは、クラスターが割り当てられていない状態で作成されます。 クラスターは、後続の書き込み要求か、連続するクラスターを事前に割り当てるための ***fx_file_allocate*** 要求で割り当てられます。

図 4 の「FileX FAT-16 ファイルの例」は、クラスター 101 で始まりサイズが 26 の 2 つの順次クラスターが割り当てられている ***FILE.TXT*** という名前のファイルと、ファイルの最初のデータ クラスター番号 101 内のデータとしてのアルファベットを示しています。

### <a name="file-access"></a>ファイル アクセス

FileX ファイルは、読み取りアクセスのために同時に複数回開くことができます。 ただし、書き込み用にファイルを開くことができるのは 1 回だけです。 ファイル アクセスをサポートするために使用される情報は、***FX_FILE*** ファイル制御ブロックに含まれます。

> [!NOTE]
> "*メディア ドライバーでは書き込み保護を動的に設定できることに注意してください。その場合、書き込み用にファイルを開く試みだけでなく、すべての書き込み要求が拒否されます。* "

### <a name="file-layout-in-exfat"></a>exFAT のファイル レイアウト

exFAT の設計では、データが連続するクラスターに格納されている場合はファイルの FAT チェーンを保持する必要はありません。 ストリーム拡張ディレクトリ エントリの *NoFATChain* ビットは、ファイルからデータを読み取るときに FAT チェーンを使用する必要があるかどうかを示します。 *NoFATChain* が設定されている場合、FileX は、ストリーム拡張ディレクトリ エントリの "*最初のクラスター*" フィールドに示されているクラスターから順番に読み取ります。

一方、*NoFATChain* がクリアされている場合、FileX は、FAT12、16、32 の FAT チェーンと同様に、ファイル全体を走査するために FAT チェーンに従います。

図 3 は、FAT チェーンを必要とするファイルと FAT チェーンを必要としないファイルの 2 つのサンプル ファイルを示しています。

## <a name="system-information"></a>システム情報

FileX システム情報は、開いているメディア インスタンスを追跡し、グローバルなシステムの時刻と日付を保持することで構成されます。

![連続するクラスターを含むファイルと、FAT リンクを必要とするファイル](./media/user-guide/system-information.png)

**図 3. 連続するクラスターを含むファイルと、FAT リンクを必要とするファイル**

システムの日付と時刻は、既定で FileX の最終リリース日に設定されます。 システムの正確な日付と時刻を取得するには、アプリケーションは、初期化中に ***fx_system_time_set** _ と _ *_fx_system_date_set_** を呼び出す必要があります。

### <a name="system-date"></a>システム日付

FileX システム日付は、グローバル ***_fx_system_date*** 変数に保持されます。 ビット 15 から 9 には 1980 年からの年のオフセットが含まれます。ビット 8 から 5 には月のオフセットが含まれます。ビット 4 から 0 には日が含まれます。 |

### <a name="system-time"></a>システム時刻

FileX システム時刻は、グローバル ***_fx_system_time*** 変数に保持されます。 ビット 15 から 11 には時間が含まれます。ビット 10 から 5 には分が含まれます。ビット 4 から 0 には 0.5 秒が含まれます。

### <a name="periodic-time-update"></a>定期的な時間の更新

システムの初期化中、FileX により、システムの日付と時刻を定期的に更新する ThreadX アプリケーション タイマーが作成されます。 システムの日付と時刻を更新する頻度は、***_fx_system_initialize*** 関数で使用される 2 つの定数によって決定されます。

定数 **FX_UPDATE_RATE_IN_SECONDS** と **FX_UPDATE_RATE_IN_TICKS** は、同じ期間を表します。 定数 **FX_UPDATE_RATE_IN_TICKS** は、定数 **FX_UPDATE_RATE_IN_SECONDS** で指定された秒数を表す ThreadX タイマー ティックの数です。 定数 **FX_UPDATE_RATE_IN_SECONDS** は、FileX 時刻の各更新間の秒数を指定します。 したがって、内部 FileX 時刻は、**FX_UPDATE_RATE_IN_SECONDS** の間隔で増分されます。 これらの定数は **_fx_system_initialize_ *_ のコンパイル中に提供される場合があります。または、開発者が FileX リリースの _* _fx_port.h_** ファイルにある既定値を変更する場合があります。

定期的な FileX タイマーは、ファイルのタイムスタンプにのみ使用されるグローバルなシステムの日付と時刻を更新するためにのみ使用されます。 タイムスタンプが不要な場合は、**_fx_system_initialize.c_** をコンパイルするときに **FX_NO_TIMER** を定義するだけで、FileX 定期タイマーが作成されなくなります。

![FileX FAT-16 ファイルの例](./media/user-guide/fat-16-file-example.png)

**図 4. FileX FAT-16 ファイルの例**
