---
title: 第 1 章 - Azure RTOS NetX Duo TFTP の概要
description: 簡易ファイル転送プロトコル (TFTP) は、ファイル転送用に設計された軽量プロトコルです。
author: philmea
ms.author: philmea
ms.date: 06/04/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: 4854f96d8f230d7c1f21700ac731d6430854a950009d3ed51fbf90d37885f255
ms.sourcegitcommit: 93d716cf7e3d735b18246d659ec9ec7f82c336de
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/07/2021
ms.locfileid: "116791977"
---
# <a name="chapter-1---introduction-to-azure-rtos-netx-duo-tftp"></a>第 1 章 - Azure RTOS NetX Duo TFTP の概要 

簡易ファイル転送プロトコル (TFTP) は、ファイル転送用に設計された軽量プロトコルです。 他の堅牢なプロトコルと異なり TFTP は細かなエラー チェックを行いません。また、stop-and-wait プロトコルであるためパフォーマンスに制約があります。 TFTP データ パケットを送信した後、送信元は受信元から ACK が返されるまで待機します。 この方法はシンプルですが、TFTP の全体的なスループットが制約を受けます。 TFTP パッケージを使用すると、ホストが IP ネットワークで TFTP プロトコルを使用できます。

## <a name="tftp-requirements"></a>TFTP の要件

NetX Duo TFTP パッケージの TFTP クライアント部分が正しく機能するためには、IP インスタンスを前もって作成しておく必要があります。 さらに、その IP インスタンスで UDP が有効になっている必要があります。 NetX Duo TFTP パッケージのクライアント部分には、それ以上の要件はありません。

NetX Duo TFTP パッケージの TFTP サーバー部分には、それ以外にもいくつか要件があります。 まず、すべてのクライアント TFTP 要求を処理するために、*ウェルノウン ポートの UDP ポート 69* に対する完全なアクセスが必要です。 また、TFTP サーバーは、組み込みファイル システムの FileX と合わせて使用するように設計されています。 FileX が使用できない場合、ユーザーは、使用されている FileX の一部を自分自身の環境に移植することもできます。 これについては、このガイドの後のセクションで説明します。

## <a name="tftp-file-names"></a>TFTP ファイル名 

TFTP ファイル名は、送信先のファイル システムに形式を合わせる必要があります。 また、NULL で終わる ASCII 文字列である必要があり、場合によっては絶対パスの情報も必要です。 NetX Duo TFTP の実装では、TFTP ファイル名のサイズに上限の指定はありません。

## <a name="tftp-messages"></a>TFTP メッセージ

TFTP にはファイルの開閉、読み込み、書き込みを行うためのとてもシンプルな仕組みがあります。 UDP ヘッダーの下には、通常 2 ～ 4 バイトの TFTP ヘッダーがあります。 ファイルを開く TFTP メッセージは次の形式で定義されます:

**oooof…f0OCTET0**

各値の説明:

- **oooo** 2 バイトのオペコード フィールド  
0x0001 -> 読み込むために開く  
0x0002 -> 書き込むために開く

- **f…f** n バイトのファイル名フィールド

- 0  1 バイトの NULL 終端文字

- **OCTET** バイナリ転送を指定する ASCII 文字列 "OCTET"

- 0  1 バイトの NULL 終端文字

TFTP 書き込み、ACK、エラー メッセージの定義は少し異なり、次のように定義されます:

**oooobbbbd…d**

各値の説明:

- **oooo** 2 バイトのオペコード フィールド  
0x0003 -> データ パケット  
0x0004 -> 最後の読み込みに対する ACK  
0x0005 -> Error 状態  

- **bbbb** 2 バイトのブロック番号フィールド (1 - n)

- **d…d** n バイトのデータ フィールド


- 0x0001 (読み取り) ファイル名 0 オクテット 0

- 0x0002 (書き込み) ファイル名 0 オクテット 0

## <a name="tftp-communication"></a>TFTP 通信

TFTP サーバーでは、既知の UDP ポート 69 を使用して、クライアントの要求をリッスンします。 TFTP クライアントのソケットは、使用可能な任意の UDP ポートにバインドできます。 アップロードまたはダウンロードするファイルの入ったデータ パケットのペイロードは、512 バイトのチャンクに分けて送信されます。ただし、最後のパケットは 512 バイト未満になります。 そのため、512 バイト未満のパケットがファイルの終わりの合図になります。 イベントは一般に次の順序で進行します:

TFTP ファイル読み取り要求:

1.  クライアントが "読むために開く" 要求をファイル名と合わせて発行し、サーバーの応答を待機します。

2.  サーバーからファイルの先頭の 512 バイトが送信されます。ただし、ファイルサイズが 512 バイト未満の場合は送信する量もそれ未満になります。

3.  ファイルの内容が 512 バイトを超える場合、クライアントはデータを受信し、ACK を送信し、サーバーからの次のパケットが届くのを待機します。

4.  クライアントが 512 バイト未満のパケットを受信すると、この手順は終了します。

TFTP 書き込み要求:

1.  クライアントが "書き込むために開く" 要求をファイル名と合わせて発行し、ブロック番号が 0 の ACK がサーバーから届くのを待機します。

2.  サーバーは、ファイルに書き込みを行う準備ができたら、ブロック番号が 0 の ACK を送信します。

3.  クライアントからファイルの先頭の 512 バイト (ファイルが 512 バイト未満の場合はそれ未満) がサーバーに送信され、ACK が返されるのを待機します。

4.  サーバーは、バイトを書き込んでから ACK を送信します。

5.  クライアントが 512 バイト未満のパケットの書き込みを完了すると、この手順は終了します。
 

## <a name="tftp-server-session-timer"></a>TFTP サーバー セッション タイマー

TFTP サーバーのクライアント要求スロットは数に制約があります。 クライアント セッションが破棄されたように見える状態になっている場合、そのスロットは再使用できません。 ただし、NX_TFTP_SERVER_RETRANSMIT_ENABLE オプションが有効である場合、NetX Duo TFTP Server によって、各クライアント セッションのタイムアウトを監視するセッション タイマーが作成されます。 タイムアウトするとセッションは終了し、開いているすべてのファイルが閉じられます。 こうしてその "スロット" は、別の TFTP クライアント要求に使用できるようになります。

タイムアウトを設定するには、構成オプション NX_TFTP_SERVER_RETRANSMIT_TIMEOUT を調整します。既定値は 200 タイマー ティックです。 セッション タイムアウトを確認する間隔は NX_TFTP_SERVER_TIMEOUT_PERIOD で設定します。既定値は 20 タイマー ティックです。

TFTP クライアントから (書き込みを行った) ファイルを TFTP FileX メディアにアップロードした後は、メディアをフラッシュして、TFTP サーバーの RAM ディスクから裏で処理を実行するメディア (TFTP クライアントのディスクのメモリ) にデータを書き込めるようにする必要があります。 アプリケーションの使用中に TFTP サーバーを終了したくない場合は、fx_media_flush サービスを使用してこれを実行できます。

ただし、TFTP サーバーを終了した後、アプリケーションで FileX メディアをそれ以上使用しない場合は、fx_media_close サービスを使用してメディアを終了する必要があります。 そうすることで、ファイル データをフラッシュして TFTP クライアントのディスクに戻し、開いているファイル閉じ、ディレクトリの情報をメディアで更新できます。

この章の「簡単な例」セクションでこの操作を例示しています。

FileX メディアを更新する 3 つ目の方法として、FileX サービスを明示的に使用する代わりに、FX_FAULT_TOLERANT または FX_FAULT_TOLERANT_DATA オプションを使用して FileX ライブラリをコンパイルすることもできます。 そのように定義すれば、FileX から書き込み要求が自動的にメディア ドライバーに渡されます。 これらのオプションを使用するとパフォーマンスが落ちる場合もありますが、ファイル データやクラスターの損失防止に大きな効果があります。 これに関する詳しい情報と FileX 一般に関する情報は「Express Logic FileX ユーザー ガイド」をご覧ください。

## <a name="tftp-multi-thread-support"></a>TFTP のマルチスレッド サポート

NetX Duo TFTP Client のサービスは、複数のスレッドから同時に呼び出せます。 ただし、特定の TFTP クライアント インスタンスに対する読み取りまたは書き込み要求は、同じスレッドによって 1 つずつ順番に行う必要があります。

## <a name="tftp-rfcs"></a>TFTP RFC

NetX Duo TFTP は RFC1350 およびその関連 RFC に準拠しています。

