---
title: 第 1 章 - Azure RTOS NetX Duo DHCPv6 サーバーの概要
description: このドキュメントでは、NetX Duo DHCPv6 サーバーが DHCPv6 クライアントに IPv6 アドレスを割り当てるしくみについて詳しく説明します。
author: philmea
ms.author: philmea
ms.date: 06/08/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: 6cf7baa91b1804876b97b1d75d1872d1120ad028
ms.sourcegitcommit: e3d42e1f2920ec9cb002634b542bc20754f9544e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/22/2021
ms.locfileid: "104810859"
---
# <a name="chapter-1---introduction-to-azure-rtos-netx-duo-dhcpv6-server"></a>第 1 章 - Azure RTOS NetX Duo DHCPv6 サーバーの概要

IPv6 ネットワークでは、クライアントが IPv6 アドレスを取得するには DHCPv6 が必要です。 これは、IPv4 アドレスを提供しないという点で、IPv4 に限定される DHCP に代わるものではありません。 DHCPv6 は、DHCP と同様の機能に加え、多くの拡張機能も備えています。 IPv6 ステートレス アドレス自動構成を使用しないまたは使用できないクライアントでは、DHCPv6 を使用することで、DHCPv6 サーバーから一意のグローバル IPv6 アドレスの割り当てを受けることができます。

NetX Duo は、IPv6 ネットワーク ベースのアプリケーションと、DHCPv6 などのネットワーク プロトコルをサポートするために開発されました。 このドキュメントでは、NetX Duo DHCPv6 サーバーが DHCPv6 クライアントに IPv6 アドレスを割り当てるしくみについて詳しく説明します。

## <a name="dhcpv6-communication"></a>DHCPv6 通信

**DHCPv6 メッセージの構造**

メッセージ ヘッダーの後に 1 つまたは複数 (通常は複数) のオプション ブロックが続いているのが、メッセージの基本的な内容です。 この基本構造を次に示します。各ブロックは 1 バイトを表しています。

![DHCPv6 メッセージとオプション ブロックの構造を示す図。](media/image2.jpg)

**図 1. DHCPv6 メッセージとオプション ブロックの構造**

1 バイトの Msg-Type フィールドは、DHCPv6 メッセージの種類を示します。 3 バイトの Transaction-ID フィールドは、クライアントによって設定されます。 任意の文字シーケンスを使用できますが、サーバーへのクライアント メッセージごとに一意である必要があります (クライアントによって送信される重複するメッセージ間で保持されます)。 サーバーではクライアントへの各応答にその Transaction-ID を使用して、ネットワーク上でパケットの遅延やドロップが発生した場合にクライアントがサーバー メッセージを照合できるようにします。 Transaction-ID フィールドの後には、クライアントの要求の内容を示すために使用される 1 つ以上の DHCPv6 オプションが続きます。

DHCPv6 オプションの構造は、オプション コード、長さまたはコード フィールドを含まないオプション長フィールド、オプション データ自体 (クライアントが要求しているデータの 1 つ以上の 2 バイトのオプション コード フィールド) で構成されます。

一部のオプション ブロックには入れ子になったオプションがあります。 たとえば、"*非一時アドレス用 ID 関連付け (IANA)* " オプションには、IPv6 アドレスを要求するための "*ID 関連付け (IA)* " オプションが 1 つ以上含まれています。 サーバー応答メッセージで返される *IANA* オプションには、サーバーによって付与された IPv6 アドレスとリース時間を含む同じ *IA* オプションと、クライアント アドレス要求でエラーが発生したかどうかを示す *Status* オプションが含まれています。

すべてのオプション ブロックとその説明の一覧については、**付録 A** をご覧ください。

**DHCPv6 メッセージの種類**

DHCPv6 では、DHCP の機能が大幅に強化されていますが、DHCP と同じ数のメッセージが使用され、DHCP と同じベンダー オプションがサポートされています。 DHCPv6 メッセージの一覧を次に示します。

- SOLICT (1) (クライアントから送信)
- ADVERTISE (2) (サーバーから送信)
- REQUEST (3) (クライアントから送信)
- REPLY (7) (サーバーから送信)
- CONFIRM (4) (クライアントから送信)
- RENEW (5) (クライアントから送信)
- REBIND (6) (クライアントから送信)
- RELEASE (8) (クライアントから送信)
- DECLINE (9) (クライアントから送信)
- INFORM_REQUEST (11) (クライアントから送信)
- RECONFIGURE* (10) (サーバーから送信)

*RECONFIGURE は、NetX Duo DHCPv6 サーバーではサポートされていません。

基本的な DHCPv6 要求シーケンスは次のとおりです。かっこ内は同等の DHCPv4 メッセージの種類を示しています。

クライアント ***Solicit** _ (_Discovery *) サーバー **Advertise** (* Offer *) クライアント **Request** (* Request *) サーバー **Reply** (* DHCPAck*)

クライアント **Renew** (同じ) サーバー **Reply** (*DHCPAck*)

## <a name="dhcpv6-message-validation"></a>DHCPv6 メッセージの検証

トランザクション ID: クライアントは、サーバーに送信するメッセージごとにトランザクション ID を生成する必要があります。 DHCPv6 サーバーは、このトランザクション ID と一致しないクライアントからのメッセージを拒否します。 このサーバーでは次に、クライアントへの応答で同じトランザクション ID を使用する必要があります。

**DHCPv6 一意識別子 (DUID)**

すべてのサーバー メッセージでは、各メッセージに DHCPv6 一意識別子 (DUID) も含める必要があります。そうしないと、DHCPv6 クライアントはメッセージを受け入れることができません。 Link Layer (LL) DUID は、クライアントの MAC アドレス、ハードウェアの種類、DUID の種類を含む制御ブロックです。 Link Layer Time (LLT) DUID には、ホスト ネットワーク上で DUID が一意でなくなる可能性を低減する時刻フィールドも含まれています。 そのため、RFC 3315 では、LL DUID よりも LLT DUID が推奨されています。 ホスト アプリケーションによって独自の一意の時刻値が作成されていない場合は、NetX Duo DHCPv6 によって既定値が提供されます。 DUID の 3 つ目の種類は、エンタープライズ (ベンダー割り当て) DUID です。これには、登録済みのエンタープライズ ID (IANA に登録されているものなど) と、メモリ サイズやオペレーティング システムの種類などのハードウェア構成に基づいて型と長さが変わるプライベート データが含まれています。 サーバーのベンダー割り当ておよびプライベート ID 値の設定については、このドキュメントの別の場所にある構成オプションの一覧を参照してください。

クライアントも、サーバーへのメッセージ (INFORM_REQUEST を除く) に DUID を含める必要があります。そうしないと、サーバーはそれらを拒否します。

**DHCPv6 クライアント サーバー セッション**

DHCPv6 クライアントとサーバーは、UDP を介してメッセージを交換します。 クライアントではポート 546 を使用して DHCPv6 メッセージを送受信し、サーバーではポート 547 を使用します。 クライアントでは、最初にリンクローカル アドレスを使用して DHCPv6 メッセージを送受信します。 *All_DHCP_Relay_Agents_and_Servers* マルチキャスト アドレス *(FF02::01:02)* と呼ばれるリンクスコープの予約済みマルチキャスト アドレスを使用して、すべてのメッセージが DHCPv6 サーバーに送信されます。

IPv6 アドレス割り当て要求の場合、DHCPv6 サーバーは、*All_DHCP_Relay_Agents_and_Servers* アドレスに送信された *Solicit* メッセージをリッスンします。 *Solicit* 要求では、クライアントは特定の IPv6 アドレスの割り当てを要求することも、サーバーに選択させることもできます。 また、サーバーに他のネットワーク構成情報を要求することもできます。

DHCPv6 サーバーは、有効な *Solicit* メッセージを抽出し、IPv6 アドレスをクライアントに割り当てることができる場合、クライアントに付与する IPv6 アドレス、IPv6 アドレスのリース時間、クライアントから要求された追加情報を含む *Advertise* メッセージで応答します。 クライアントは、サーバーのオファーを受け入れる場合、IPv6 アドレスを受け入れることをサーバーに通知する *Request* メッセージで応答します。 サーバーは、クライアントが IPv6 アドレスにバインドされていることを *Reply* メッセージで確認します。

クライアントの DHCPv6 メッセージが無効の場合、サーバーはそのメッセージを警告なしに破棄します。 サーバーは、要求に応えることができない場合、IP アドレスの IANA オプションの状態フィールドに問題があることを示す *Reply* メッセージを送信します。 重複するクライアント要求を受信した場合、サーバーは、クライアントが単にパケットを受信していなかったと想定して、以前の DHCPv6 応答を再送信します。

クライアントでは、重複アドレス検出などのさまざまな IPv6 プロトコルを使用して、サーバーから割り当てられた IPv6 アドレスがシステム上の別のホストに割り当てられていないことを確認する必要があります。 アドレスが一意でない場合、クライアントはサーバーに *Decline* メッセージを送信します。 サーバーは、この情報で IP リース テーブルを更新し、そのアドレスが既に割り当てられていることを記録します。 その間に、クライアントは別の *Solicit* メッセージで DHCPv6 要求プロセスを再開する必要があります。

クライアントは IPv6 アドレスのほかに、DNS サーバーや、場合によってはネットワーク ドメイン名などの他のネットワーク情報を必要とする可能性があります。 DHCPv6 では、オプション要求を *Solicit* および *Request* メッセージで使用するか、*Information Request* メッセージで個別に使用して、この情報を要求する手段が提供されます。 DHCPv6 オプションについては、この章で後述します。

**IPv6 のリース期間**

サーバーは、IPv6 アドレスをクライアントに付与するときに、IANA オプションでリース期間 (有効期間) も割り当てます。これにより、*Renew* および *Rebind* メッセージを使用してクライアントが IPv6 アドレスの更新 (T1) または再バインド (T2) を開始することが推奨される時間が示されます。 この 2 つの違いは、クライアントが *Renew* メッセージをサーバーに送信するために *Renew* 要求にサーバー DUID を含めるという点にあります。 一方、*All_DHCP_Relay_Agents_and_Servers* アドレスへの *Rebind* メッセージではサーバーを指定しないため、そこにサーバー DUID を含めません。 サーバーがクライアントに付与する実際の IPv6 アドレスを含む IA オプションには、リースされた IPv6 アドレスが非推奨になるまでの優先有効期間と古くなる (無効になる) までの有効な有効期間も含まれます。

NetX Duo DHCPv6 サーバーでは、クライアント メッセージ間の時間を追跡するために、クライアントごとにセッション タイムアウトが維持されます。 これは、クライアント ホストが接続を失った場合や、ネットワークがダウンした場合に必要となります。 セッションがタイムアウトになると、クライアントがサーバーに対して DHCPv6 要求を行う必要がなくなったか、要求を実行できなくなったと想定されます。 サーバーはクライアント レコードを削除し、暫定的に割り当てられた IPv6 アドレスを使用可能なプールに戻します。 セッション タイムアウトの待機はユーザーが構成可能なオプションです。

クライアントは、IPv6 アドレスを解放する必要がある場合、または DHCPv6 サーバーによって割り当てられた IPv6 アドレスが既に使用されていることを検出した場合に、*Release* または *Decline* メッセージをそれぞれ送信します。 *Release* メッセージの場合、サーバーはその IPv6 アドレスの状態を使用可能なプールに戻します。 *Decline* メッセージの場合、IP リース テーブルを更新して、この IPv6 アドレスが使用できないこと (ネットワーク上の別のエンティティが所有していること) を示します。

**IPv6 リースとクライアント レコードのデータ**

DHCPv6 サーバーは、クライアント要求の受け入れを開始すると、IPv6 アドレスを要求しているか、既に割り当てられているアクティブなクライアントのリストを保持します。 サーバーでは、クライアントのリース期間を定期的に更新するリース タイマーを使用して、IP リースの有効期限を確認します。 期間が有効な有効期間を超えると、サーバーはクライアント レコードをクリアし、IPv6 アドレスを使用可能なプールに戻します。 これが行われる前に、更新または再バインド プロセスを開始することはクライアントに委ねられています。

NetX Duo DHCPv6 サーバーのクライアント レコード テーブルには、クライアントを識別するための情報と、DHCPv6 クライアント要求を検証し、IPv6 アドレスの割り当てまたは再割り当てを行うための "状態" 情報が含まれています。 これらの情報は次のとおりです。

- ネットワーク上の各クライアント ホストを一意に定義する、クライアントの DHCPv6 一意識別子 (DUID)。 クライアントでは、すべての DHCPv6 メッセージにこの同じ DUID を常に使用する必要があります。

- クライアントの IPv6 アドレス割り当てパラメーターを定義する、非一時アドレス用 ID 関連付け (IANA) と累積的な ID 関連付け IPv6 アドレス (IA)。

- クライアントのオプション要求 (DNS サーバー、ドメイン名など)。

- クライアントの最新の DHCPv6 要求の IPv6 送信元アドレス (設定されている場合) と宛先アドレス (マルチキャストでない場合)。

- クライアントの最新のメッセージの種類と DHCPv6 の "状態"。

## <a name="netx-duo-dhcpv6-server-requirements-and-constraints"></a>NetX Duo DHCPv6 サーバーの要件と制約

NetX Duo DHCPv6 サーバー API には、ThreadX 5.1 以降と NetX Duo 5.5 以降が必要です。

**必要条件**

***IP スレッド タスクの設定***

NetX Duo DHCPv6 サーバーでは、ネットワーク リンクで DHCPv6 へのメッセージを送受信するための IP インスタンスを作成する必要があります。 これを行うには、*nx_ip_create* サービスを使用します。 NetX Duo DHCPv6 サーバー自体を作成する必要があります。 これを行うには、*nx_dhcpv6_server_create* サービスを使用します。

DHCPv6 では、NetX Duo、ICMPv6、UDP を使用します。 そのため、DHCPv6 サーバーを使用する前に、次の NetX Duo サービスを呼び出して、まず IPv6 を有効にする必要があります。

- *nx_udp_enable*
- *nxd_ipv6_enable*
- *nxd_icmp_enable*

さらに、DHCPv6 サーバーを起動する前に、いくつかの設定タスクを実行する必要があります。

- リンク ローカル アドレスと IPv6 グローバル アドレスを作成して検証します。 アドレスの検証は、重複アドレス検出 (有効になっている場合) を使用して、NetX Duo によって自動的に実行されます。 リンク ローカル アドレスとグローバル IP アドレスの検証の詳細については、"*NetX Duo ユーザー マニュアル*" をご覧ください。

- DHCPv6 インターフェイスのネットワーク インターフェイス インデックスを設定します。

- 割り当て可能な IPv6 アドレスの IP アドレス範囲を作成します。 または、前のサーバー DHCPv6 セッションのデータが存在する場合は、そのセッションの IPv6 リース テーブルとクライアント レコードを、不揮発性メモリから DHCPv6 サーバーにアップロードする必要があります。 このドキュメントの別の場所にある簡単なシステムの例で、この要件を実現するための DHCPv6 サーバー サービスが示されています。

- サーバー DUID を設定します。 前のセッションでサーバーによって DUID が作成された場合、同じデータを使用して、クライアントへのメッセージ用に同じ DUID が作成される必要があります。 このドキュメントの別の場所にある簡単なシステムの例で、この要件を実現する方法が示されています。

この時点で、DHCPv6 サーバーを実行する準備ができました。 内部的には、NetX Duo DHCPv6 サーバーは、ポート 547 にバインドされた UDP ソケットを作成し、クライアント要求のリッスンを開始します。

***パケット プールの要件***

NetX Duo DHCPv6 サーバーには、DHCPv6 メッセージを送信するためのパケット プールが必要です。 パケット プールのサイズは、パケット ペイロードと使用可能なパケットの数に関してユーザーが構成可能であり、DHCPv6 メッセージとホスト アプリケーションによる他の送信の予想される量によって異なります。

クライアントから要求された追加オプションの数とサーバーから入手可能な情報に応じて、一般的な DHCPv6 メッセージは約 200 から 300 バイトになります。

***DHCPv6 サーバー インターフェイスの設定***

DHCPv6 サーバーでは、クライアント要求を受け入れるインターフェイスとして、プライマリ ネットワーク インターフェイスが既定で使用されます。 ただし、ホスト アプリケーションでは、サーバーのグローバル アドレスの作成に使用されたグローバル アドレス インデックスを設定する必要があります。 DHCPv6 インターフェイス インデックスとグローバル アドレス インデックスは、*nx_dhcpv6_server_interface_set* サービスを使用して設定されます。 これも、このドキュメントの "簡単な例" に示されています。

***サーバーの再起動時に使用する DHCPv6 DUID の保存***

DHCPv6 プロトコルでは、サーバーで再起動するたびに同じ DUID を使用する必要があります。 この要件に対応するために、DUID の作成に使用するデータを不揮発性メモリに保存し、そこから取得する必要があります。 リンク層 + 時刻 DUID を使用するホストの場合、リアルタイム クロックにアクセスする必要があります。 NetX Duo DHCPv6 ホスト アプリケーションでは、最初のサーバー DUID の作成時に時刻値を生成するためのリアルタイム データ アクセスを含め、後続のサーバー セッションで再利用できるようにそのデータを保存する必要があります。 その後、*nx_dhcpv6_set_server_duid* で DUID データを引数として受け取り、DUID の種類に応じた構成オプションを取得して、独自の DUID を生成 (または再生成) します。

***割り当て可能な IPv6 アドレス リストの作成***

DHCPv6 サーバーの作成後、以前に保存された IP アドレス リスト データがない場合は、サーバー ホスト アプリケーションで、割り当て可能な IPv6 グローバル アドレスの範囲を作成する必要があります。 これを行うには、開始および終了 IPv6 アドレスを入力として受け取る *nx_dhcpv6_create_ip_address_range* サービスを使用します。

***DHCPv6 の割り当て可能なアドレスとクライアントのデータの保存***

DHCPv6 プロトコルでは、DHCPv6 サーバーは、サーバーを再起動する場合に備えて、クライアントと IPv6 アドレスのデータを不揮発性ストレージに保存することを求められます。 NetX Duo DHCPv6 サーバーには、DHCPv6 サーバーとの間でクライアントと IPv6 アドレスのデータをアップロードおよびダウンロードするための API がいくつかあります。

*nx_dhcpv6_add_client_record*

*nx_dhcpv6_add_ip_address_lease*

*nx_dhcpv6_retrieve_client_record*

*nx_dhcpv6_retrieve_ip_address_lease*

サーバーへのデータのアップロードは、サーバーを再起動する前に実行する必要があります。 データのダウンロードは、DHCPv6 サーバーを停止 (または一時停止) した後にのみ実行する必要があります。 これを行うためのサービスについては、このドキュメントで後ほど詳しく説明します。 ただし、NetX Duo DHCPv6 では、不揮発性ストレージへのアクセスは定義できません。 これは、ホスト アプリケーションで処理する必要があります。 簡単な例に、ホスト アプリケーションでこれを行う方法が示されています。

***サーバーの DHCP 一意識別子 (DUID)***

サーバー DUID により、ネットワーク上の DHCPv6 サーバー ホストが一意に定義されます。 サーバーで DUID をまだ作成していない場合は、*nx_dhcpv6_server_set_duid* を使用して作成できます。 RFC 3315 に従い、DHCPv6 サーバーは、サーバーの再起動後に取得できるように、この DUID を不揮発性メモリに保存する必要があります。 DHCPv6 サーバーでは、DUID の種類として、Link Layer、Link Layer Time、エンタープライズ (ベンダー割り当て) がサポートされています。 ベンダー タイプの DUID は、クライアントが直接送信する必要があることに注意してください。 NetX Duo DHPv6 サーバーでは、ベンダー タイプの DUID (17) のオプションは直接サポートされていません。

DHCPv6 サーバー ホスト アプリケーションには、リース タイムアウトを含む IPv6 アドレス割り当ての既定値があります。 これらのオプションを設定する方法については、このドキュメントで後述する構成可能なオプションを参照してください。 :

*IANA* 制御ブロックには、T1 フィールドと T2 フィールドが含まれています。 *IANA* 制御ブロック内の *IA* ブロックには、優先有効期間フィールドと有効な有効期間フィールドが含まれています。 これらのオプションを設定するために、ホスト アプリケーションには、このドキュメントの別の場所で定義されている構成可能なオプションがあります。 これらは、すべてのクライアント IPv6 アドレス要求に割り当てられます。

これらの DHCPv6 IP リース パラメーターは次のように定義されています。

T1 - IPv6 アドレスを割り当てたサーバーから、クライアントがアドレスの更新を開始する必要がある時間 (秒単位)。

T2 - 更新に失敗した場合に、クライアントがリンク上の任意のサーバーで IPv6 アドレスの再バインドを開始する必要がある時間 (秒単位)。

優先有効期間 - クライアントがアドレスを更新または再バインドしていない場合に、クライアント アドレスが非推奨になるまでの時間 (秒単位)。 クライアントは引き続きこのアドレスを使用できます。

有効な有効期間 - クライアント IP アドレスの有効期限が切れ、ネットワーク送信でこのアドレスを使用できなくなるまでの時間 (秒)。

RFC では、クライアントの *IANA* オプションの優先有効期間の T1 および T2 時間として、それぞれ 0.5 と 0.8 が推奨されています。 サーバーは、優先設定がない場合に、これらの時間を 0 に設定する必要があります。 0 に設定された T1 および T2 時間がサーバー応答に含まれている場合は、クライアントが独自の T1 および T2 時間を設定できます。

**制約**

NetX Duo DHCPv6 サーバーでは、次の DHCPv6 オプションはサポートされていません。

  - DHCPv6 アドレス要求プロセスを最適化して、Solicit と Reply のメッセージ交換だけを行う Rapid Commit オプション。

  - サーバーがクライアントの IP アドレスの状態の変更を開始できるようにする Reconfigure オプション。

  - Unicast オプション。すべてのクライアント メッセージは、DHCPv6 サーバーに直接送信するのではなく、*All_DHCP_Relay_Agents_and_Servers* マルチキャスト アドレスに送信する必要があります。

  - クライアントに付与される一時 IP アドレスである、一時アドレス用 ID 関連付け (IA_TA) オプション。

  - クライアント要求ごとに複数の IA (IPv6 アドレス) オプション。

  - DHCPv6 クライアントとサーバー間のリレー ホスト。たとえば、クライアントとサーバーは同じネットワーク上に存在する必要があります。

  - DHCPv6 メッセージングでの IPSec と認証はサポートされていません。 ただし、使用している NetX Duo のバージョンによっては、IP インスタンスで IPSec が有効になっている場合があります。

  - NetX Duo DHCPv6 サーバーで直接サポートされるのは、DNS サーバー オプション要求だけです。 これは、将来のリリースで変更される可能性があります。

  - プレフィックス委任オプションはサポートされていません。

  - DHCPv6 メッセージの認証。ただし、基になる NetX Duo 環境で IPSec を有効にすることは可能です。 NetX Duo DHCPv6 サーバーでは、クライアントへのリレー接続もサポートされていません。 すべてのクライアント要求は、サーバー ネットワーク上のホストからのものと見なされます。

## <a name="netx-duo-dhcpv6-server-callback-functions"></a>NetX Duo DHCPv6 サーバーのコールバック関数

*nx_dhcpv6_IP_address_declined_handler*

DHCPv6 クライアントが Decline メッセージを送信すると、NetX Duo DHCPv6 サーバーは、IPv6 アドレス テーブルでそのアドレスを使用不可としてマークします。 このメッセージのサーバー処理をカスタマイズできるようにするために、*nx_dhcpv6_IP_address_declined_handler* が用意されています *。* ただし、このコールバックは現在実装されていません。

*nx_dhcpv6_server_option_request_handler*

DHCPv6 クライアント メッセージにオプション要求データが含まれている場合、NetX Duo DHCPv6 サーバーは、各オプション要求のオプション コードをこのユーザー コールバック (定義されている場合) に転送します。 これにより、NetX Duo サーバーは、ユーザー定義のコールバックにデータを入力させることができます。 ただし、この機能は現在実装されていません。

## <a name="supported-dhcpv6-rfcs"></a>サポートされている DHCPv6 RFC

NetX Duo DHCPv6 は、RFC3315、RFC3646、および関連する RFC に準拠しています。