---
title: 第 1 章 - Azure RTOS NetX Duo FTP の概要
description: ファイル転送プロトコル (FTP) は、ファイル転送用に設計されたプロトコルです。
author: philmea
ms.author: philmea
ms.date: 07/14/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: a36357ce486d5ba8a68b23c829de6c4b821dfb3cc62f47b0958ff32deaa2f7a7
ms.sourcegitcommit: 93d716cf7e3d735b18246d659ec9ec7f82c336de
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/07/2021
ms.locfileid: "116791297"
---
# <a name="chapter-1---introduction-to-azure-rtos-netx-duo-ftp"></a>第 1 章 - Azure RTOS NetX Duo FTP の概要

ファイル転送プロトコル (FTP) は、ファイル転送用に設計されたプロトコルです。 FTP では、信頼性の高い伝送制御プロトコル (TCP) サービスを利用して、ファイル転送機能を実行します。 そのため、FTP は信頼性の高いファイル転送プロトコルです。 また、FTP は高パフォーマンスです。 実際の FTP ファイル転送は、専用の FTP 接続で実行されます。 NetX Duo FTP は、IPv4 と IPv6 の両方のネットワークに対応しています。 IPv6 によって FTP プロトコルが直接変更されることはありませんが、IPv6 に対応するために元の NetX FTP API にいくつかの変更が必要となります。これについては、このドキュメントで説明します。

## <a name="ftp-requirements"></a>FTP の要件

NetX FTP パッケージを正しく機能させるには、NetX Duo が必要です。 ホスト アプリケーションでは、NetX サービスと定期的なタスクを実行するための IP インスタンスを作成する必要があります。 FTP ホスト アプリケーションを IPv6 ネットワーク経由で実行する場合は、IP タスクで IPv6 と ICMPv6 を有効にする必要があります。 また、IPv6 と IPv4 のどちらのネットワークでも、TCP を有効にする必要があります。 IPv6 ホスト アプリケーションでは、IPv6 API または DHCPv6、あるいはその両方を使用して、リンクローカルおよびグローバル IPv6 アドレスを設定する必要があります。 **第 2 章** の「簡単なシステムの例」セクションのデモ プログラムでこの方法が示されています。

FTP サーバーとクライアントは、FileX 組み込みファイル システムとも連携するように設計されています。 FileX が使用できない場合、ホスト開発者は、filex_stub.h に示されているガイドラインに従って、このファイルに記載されている各サービスを定義することによって、独自のファイル システムを実装または代用できます。 これについては、このガイドの後のセクションで説明します。

NetX FTP パッケージの FTP クライアント部分には、これ以上の要件はありません。

NetX FTP パッケージの FTP サーバー部分には、追加要件がいくつかあります。 最も重要なのは、TCP の "*ウェルノウン ポート 21*" (すべてのクライアント FTP コマンド要求を処理) と、"*ウェルノウン ポート 20*" (すべてのクライアント FTP データ転送を処理) への完全なアクセス権が必要であることです。

## <a name="ftp-constraints"></a>FTP の制約

FTP 標準には、ファイル データの表現に関する多くのオプションがあります。 NetX FTP は、ls -al などのスイッチ オプションを実装していません。 NetX FTP サーバーでは、連続したパケットではなく、1 つのパケットで要求とその引数を受信することを想定しています。

UNIX の実装と同様に、NetX FTP には次のファイル形式の制約があります。

- ファイルの種類: **バイナリ**
- ファイル形式: **onprint のみ**
- ファイル構造: **ファイル構造のみ**

## <a name="ftp-file-names"></a>FTP ファイル名

FTP ファイル名は、ターゲット ファイル システム (通常は FileX) の形式である必要があります。 これらは、必要に応じて完全なパス情報を含む、NULL 終端 ASCII 文字列である必要があります。 NetX FTP 実装では、FTP ファイル名のサイズに特に制限はありません。 ただし、パケット プールのペイロード サイズは、最大のパスやファイル名に対応できる必要があります。

## <a name="ftp-client-commands"></a>FTP クライアント コマンド

FTP には、接続を開き、ファイルおよびディレクトリ操作を実行するための単純なメカニズムがあります。 基本的には、TCP の "*ウェルノウン ポート 21*" で接続が正常に確立された後にクライアントによって発行される一連の標準の FTP コマンドがあります。 基本的な FTP コマンドの一部を次に示します。 FTP が IPv6 で実行される場合の唯一の違いは、PORT コマンドが EPRT コマンドに置き換えられることです。

- CWD パス: "*作業ディレクトリを変更する*"
- DELE ファイル名: "*指定したファイル名を削除する*"
- EPRT IP アドレス, ポート: "*IPv6 アドレスとクライアント データ ポートを指定する*"
- EPSV: "*IPv6 のパッシブ転送モードを要求する*"
- LIST ディレクトリ: "*ディレクトリの一覧を取得する*"
- MKD ディレクトリ: "*新しいディレクトリを作成する*"
- NLST ディレクトリ: "*ディレクトリの一覧を取得する*"
- NOOP: "*操作なし、成功を返す*"
- PASS パスワード: "*ログインのパスワードを指定する*"
- PASV: "*IPv4 のパッシブ転送モードを要求する*"
- PORT IP アドレス, ポート: "*IP アドレスとクライアント データ ポートを指定する*"
- PWD パス: "*現在のディレクトリ パスを選択する*"
- QUIT: "*クライアント接続を終了する*"
- RETR ファイル名: "*指定したファイルを読み取る*"
- RMD ディレクトリ: "*指定したディレクトリを削除する*"
- RNFR 古いファイル名: "*名前を変更するファイルを指定する*"
- RNTO 新しいファイル名: "*ファイル名を指定したファイル名に変更する*"
- STOR ファイル名: "*指定したファイルを書き込む*"
- TYPE I: "*バイナリ ファイル イメージを選択する*"
- USER ユーザー名: "*ログインのユーザー名を指定する*"

これらの ASCII コマンドは、FTP サーバーで FTP 操作を実行するために、NetX FTP クライアント ソフトウェアによって内部的に使用されます。

## <a name="ftp-server-responses"></a>FTP サーバーの応答

FTP サーバーは、クライアント要求を処理すると、ASCII でコード化された 3 桁の応答に続いて、任意の ASCII テキストを返します。 この数値の応答は、操作が成功したか失敗したかを判断するために、FTP クライアント ソフトウェアによって使用されます。 クライアント要求に対するさまざまな FTP サーバー応答を次に示します。

**最初の数値フィールドの意味**

- 1xx: "*肯定的な準備状態 - さらに別の応答が返されます*"。
- 2xx: "*肯定的な完了状態*"。
- 3xx: "*肯定的な準備状態 - 別のコマンドを送信する必要があります*"。
- 4xx: "*一時的なエラー状態*"。
- 5xx: "*エラー状態。"*

**2 番目の数値フィールドの意味**

- x0x: "*コマンドの構文エラー*"。
- x1x: "*情報メッセージ*"。
- x2x: "*接続関連*"。
- x3x: "*認証関連*"。
- x4x: "*未指定*"。
- x5x: "*ファイル システム関連*"。

たとえば、クライアントが QUIT コマンドで FTP 接続の切断を要求すると、通常はサーバーから "221" コードで応答が返されます (切断が成功した場合)。

## <a name="ftp-passive-transfer-mode"></a>FTP パッシブ転送モード

既定では、NetX Duo FTP クライアントではアクティブ転送モードを使用して、データ ソケットを介して FTP サーバーとデータを交換します。 この配置の問題は、FTP サーバーが接続する TCP サーバー ソケットを FTP クライアントが開く必要があることです。 これはセキュリティ リスクをもたらす可能性があり、クライアント ファイアウォールによってブロックされる場合があります。 パッシブ転送モードは、データ接続で FTP サーバーが TCP サーバー ソケットを作成するという点で、アクティブ転送モードとは異なります。 これにより、(FTP クライアントの) セキュリティ リスクが排除されます。

パッシブ データ転送を有効にするには、以前に作成された FTP クライアントに対して、2 番目の引数を NX_TRUE に設定した *nx_ftp_client_passive_mode_set* をアプリケーションで呼び出します。 その後、データを転送するための後続の NetX Duo FTP クライアント サービス (NLST、RETR、STOR) は、すべてパッシブ転送モードで試行されます。

FTP クライアントは、最初にパッシブ コマンド (引数なし) を送信します。IPv4 の場合は PASV コマンド、IPv6 の場合は EPSV コマンドです。 FTP サーバーがこの要求をサポートしている場合、PASV では 227 "OK" 応答、EPSV では 229 "OK" 応答が返されます。 次に、クライアントが RETR などの要求を送信します。 サーバーがパッシブ転送モードを拒否した場合、NetX Duo FTP クライアント サービスはエラー状態を返します。

パッシブ転送モードを無効にし、アクティブ転送モードに戻すには、2 番目の引数を NX_FALSE に設定した *nx_ftp_client_passive_mode_set* をアプリケーションで呼び出します。

## <a name="ftp-communication"></a>FTP 通信

FTP サーバーでは、"*ウェルノウン TCP ポート 21*" を使用してクライアント要求を処理します。 FTP クライアントでは、使用可能な任意の TCP ポートを使用できます。 FTP イベントの一般的なシーケンスは次のとおりです。

**FTP ファイル読み取り要求**:

1. クライアントがサーバー ポート 21 への TCP 接続を発行します。
1. サーバーが "220" 応答を送信して成功を通知します。
1. クライアントが "ユーザー名" を含む "USER" メッセージを送信します。
1. サーバーが "331" 応答を送信して成功を通知します。
1. クライアントが "パスワード" を含む "PASS" メッセージを送信します。
1. サーバーが "230" 応答を送信して成功を通知します。
1. クライアントがバイナリ転送用の "TYPE I" メッセージを送信します。
1. サーバーが "200" 応答を送信して成功を通知します。
1. "*IPv4 アプリケーション*": クライアントが、IP アドレスとポートを含む "PORT" メッセージを送信します。<br />"*IPv6 アプリケーション*": クライアントが、IP アドレスとポートを含む "EPRT" メッセージを送信します。
1. サーバーが "200" 応答を送信して成功を通知します。
1. クライアントが、読み取るファイル名を含む "RETR" メッセージを送信します。
1. サーバーがデータ ソケットを作成し、"PORT" コマンドで指定されたクライアント データ ポートに接続します。
1. サーバーが "125" 応答を送信して、ファイルの読み取りが開始されたことを通知します。
1. サーバーが、データ接続を介してファイルの内容を送信します。 ファイルが完全に転送されるまで、このプロセスが続行されます。
1. 完了すると、サーバーはデータ接続を切断します。
1. サーバーが "250" 応答を送信して、ファイルの読み取りが成功したことを通知します。
1. クライアントが "QUIT" を送信して FTP 接続を終了します。
1. サーバーが "221" 応答を送信して、切断が成功したことを通知します。
1. サーバーが FTP 接続を切断します。

前述のように、IPv4 で実行される FTP と IPv6 で実行される FTP の唯一の違いは、IPv6 では PORT コマンドが EPRT コマンドに置き換えられていることです。

Pv6 では PORT コマンドが EPRT コマンドに置き換えられています。

FTP クライアントがパッシブ転送モードで読み取り要求を行う場合、コマンド シーケンスは次のようになります (**太字** の行は、アクティブ転送モードとは異なる手順を示しています)。

1. クライアントがサーバー ポート 21 への TCP 接続を発行します。
1. サーバーが "220" 応答を送信して成功を通知します。
1. クライアントが "ユーザー名" を含む "USER" メッセージを送信します。
1. サーバーが "331" 応答を送信して成功を通知します。
1. クライアントが "パスワード" を含む "PASS" メッセージを送信します。
1. サーバーが "230" 応答を送信して成功を通知します。
1. クライアントがバイナリ転送用の "TYPE I" メッセージを送信します。
1. サーバーが "200" 応答を送信して成功を通知します。
1. **"*IPv4 アプリケーション:"* クライアントが "PASV" メッセージを送信します。**<br />**"_IPv6 アプリケーション:"_ クライアントが "EPSV" メッセージを送信します。**
1. **"*IPv4 アプリケーション:"* サーバーが "227" 応答と、クライアントの接続先となる IP アドレスとポートを送信して、成功を通知します。**<br />**"_IPv6 アプリケーション:"_ サーバーが "229" 応答と、クライアントの接続先となる IP アドレスとポートを送信して、成功を通知します。**
1. クライアントが、読み取るファイル名を含む "RETR" メッセージを送信します。
1. **サーバーがデータ サーバー ソケットを作成し、手順 10. の応答で指定したポートを使用して、このソケットでクライアント接続要求をリッスンします。**
1. **サーバーが制御ソケットで "150" 応答を送信して、ファイルの読み取りが開始されたことを通知します。**
1. サーバーが、データ接続を介してファイルの内容を送信します。 ファイルが完全に転送されるまで、このプロセスが続行されます。
1. 完了すると、サーバーはデータ接続を切断します。
1. **サーバーが制御ソケットで "226" 応答を送信して、ファイルの読み取りが成功したことを通知します。**
1. クライアントが "QUIT" を送信して FTP 接続を終了します。
1. サーバーが "221" 応答を送信して、切断が成功したことを通知します。
1. サーバーが FTP 接続を切断します。

**FTP 書き込み要求**:

1. クライアントがサーバー ポート 21 への TCP 接続を発行します。
1. サーバーが "220" 応答を送信して成功を通知します。
1. クライアントが "ユーザー名" を含む "USER" メッセージを送信します。
1. サーバーが "331" 応答を送信して成功を通知します。
1. クライアントが "パスワード" を含む "PASS" メッセージを送信します。
1. サーバーが "230" 応答を送信して成功を通知します。
1. クライアントがバイナリ転送用の "TYPE I" メッセージを送信します。
1. サーバーが "200" 応答を送信して成功を通知します。
1. "*IPv4 アプリケーション*": クライアントが、IP アドレスとポートを含む "PORT" メッセージを送信します。<br />"*IPv6 アプリケーション*": クライアントが、IP アドレスとポートを含む "EPRT" メッセージを送信します。
1. サーバーが "200" 応答を送信して成功を通知します。
1. クライアントが、書き込むファイル名を含む "STOR" メッセージを送信します。
1. サーバーがデータ ソケットを作成し、前の "EPRT" または "PORT" コマンドで指定されたクライアント データ ポートに接続します。
1. サーバーが "125" 応答を送信して、ファイルの書き込みが開始されたことを通知します。
1. クライアントが、データ接続を介してファイルの内容を送信します。 ファイルが完全に転送されるまで、このプロセスが続行されます。
1. 完了すると、クライアントはデータ接続を切断します。
1. サーバーが "250" 応答を送信して、ファイルの書き込みが成功したことを通知します。
1. クライアントが "QUIT" を送信して FTP 接続を終了します。
1. サーバーが "221" 応答を送信して、切断が成功したことを通知します。
1. サーバーが FTP 接続を切断します。

FTP クライアントがパッシブ転送モードで書き込み要求を行う場合、コマンド シーケンスは次のようになります (**太字** の行は、アクティブ転送モードとは異なる手順を示しています)。

1. クライアントがサーバー ポート 21 への TCP 接続を発行します。
1. サーバーが "220" 応答を送信して成功を通知します。
1. クライアントが "ユーザー名" を含む "USER" メッセージを送信します。
1. サーバーが "331" 応答を送信して成功を通知します。
1. クライアントが "パスワード" を含む "PASS" メッセージを送信します。
1. サーバーが "230" 応答を送信して成功を通知します。
1. クライアントがバイナリ転送用の "TYPE I" メッセージを送信します。
1. サーバーが "200" 応答を送信して成功を通知します。
1. **"*IPv4 アプリケーション:"* クライアントが "PASV" メッセージを送信します。**<br />**"_IPv6 アプリケーション:"_ クライアントが "EPSV" メッセージを送信します。**
1. **"*IPv4 アプリケーション:"* サーバーが "227" 応答と、クライアントの接続先となる IP アドレスとポートを送信して、成功を通知します。**<br />**"_IPv6 アプリケーション:"_ サーバーが "229" 応答と、クライアントの接続先となる IP アドレスとポートを送信して、成功を通知します。**
1. クライアントが、書き込むファイル名を含む "STOR" メッセージを送信します。
1. **サーバーがデータ サーバー ソケットを作成し、手順 10. の応答で指定したポートを使用して、このソケットでクライアント接続要求をリッスンします。**
1. **サーバーが制御ソケットで "150" 応答を送信して、ファイルの書き込みが開始されたことを通知します。**
1. クライアントが、データ接続を介してファイルの内容を送信します。 ファイルが完全に転送されるまで、このプロセスが続行されます。
1. 完了すると、クライアントはデータ接続を切断します。
1. **サーバーが制御ソケットで "226" 応答を送信して、ファイルの書き込みが成功したことを通知します。**
1. クライアントが "QUIT" を送信して FTP 接続を終了します。
1. サーバーが "221" 応答を送信して、切断が成功したことを通知します。
1. サーバーが FTP 接続を切断します。

## <a name="ftp-authentication"></a>FTP Authentication

FTP 接続が行われるたびに、クライアントは "*ユーザー名*" と "*パスワード*" をサーバーに提供する必要があります。 一部の FTP サイトでは、特定のユーザー名とパスワードなしで FTP アクセスを許可する、"*匿名 FTP*" と呼ばれるものを使用できます。 この種類の接続では、ユーザー名に "anonymous" を指定し、パスワードには完全な電子メール アドレスを使用します。

ログインおよびログアウト認証ルーチンは、ユーザーが NetX FTP に提供する必要があります。 これらは、***nxd_ftp_server_create** _ および _*_nx_ftp_server_create_*_ サービスの実行中に提供され、パスワード処理から呼び出されます。 この 2 つの違いは、ログインおよびログアウト認証関数への _*_nxd_ftp_server_create_*_ の入力関数ポインターでは、NetX Duo の _*_NXD_ADDRESS_*_ アドレス型が想定されていることです。 このデータ型では IPv4 と IPv6 の両方のアドレス形式が保持されるので、この関数は IPv4 と IPv6 の両方のネットワークをサポートする "duo" サービスになります。 ログインおよびログアウト認証関数への、_ *_nx_ftp_server_create_** の入力関数ポインターでは、ULONG IP アドレス型が想定されています。 この関数は IPv4 ネットワークに限定されます。 開発者は、可能な限り "duo" サービスを使用することをお勧めします。

*login* 関数から NX_SUCCESS が返された場合は、接続が認証され、FTP 操作が許可されます。 *login* 関数から NX_SUCCESS 以外のものが返された場合、接続試行は拒否されます。

## <a name="ftp-multi-thread-support"></a>FTP マルチスレッドのサポート

NetX FTP クライアント サービスは、複数のスレッドから同時に呼び出すことができます。 ただし、特定の FTP クライアント インスタンスの読み取りまたは書き込み要求は、同じスレッドから順番に実行する必要があります。

## <a name="ftp-rfcs"></a>FTP RFC

NetX Duo FTP は、RFC 959、RFC 2428、および関連する RFC に準拠しています。
