---
title: 第 1 章 - Azure RTOS NetX Duo DNS クライアントの概要
description: DNS とは、ドメイン名と物理 IP アドレスの間のマッピングを含む分散型データベースを提供するものです。
author: philmea
ms.author: philmea
ms.date: 06/04/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: 4c07d6e3183d421c637874dcdeff3767554fca78
ms.sourcegitcommit: e3d42e1f2920ec9cb002634b542bc20754f9544e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/22/2021
ms.locfileid: "104810841"
---
# <a name="chapter-1---introduction-to-the-azure-rtos-netx-duo-dns-client"></a>第 1 章 - Azure RTOS NetX Duo DNS クライアントの概要

DNS とは、ドメイン名と物理 IP アドレスの間のマッピングを含む分散型データベースを提供するものです。 インターネット上には完全なマッピングを含む単一のエンティティは存在しないため、このデータベースは "*分散型*" と呼ばれます。 マッピングの一部を保持するエンティティは、DNS サーバーと呼ばれます。 インターネットは多数の DNS サーバーで構成されており、それぞれにデータベースのサブセットが含まれています。 また DNS サーバーは、要求されたマッピングがサーバーに存在する場合にのみ、ドメイン名マッピング情報に関する DNS クライアント要求に応答します。

NetX Duo 用 DNS クライアント プロトコルを使用すると、アプリケーションに対し、1 つまたは複数の DNS サーバーにマッピング情報を要求するサービスが提供されます。

## <a name="dns-client-setup"></a>DNS クライアントのセットアップ

DNS クライアント パッケージを正常に機能させるには、事前に NetX Duo IP インスタンスが作成されている必要があります。

DNS クライアントを作成した後は、アプリケーションで DNS クライアントが管理するサーバーの一覧に 1 つ以上の DNS サーバーを追加する必要があります。 DNS サーバーを追加するには、アプリケーションで *nxd_dns_server_add* サービスを使用します。 NetX Duo DNS クライアント サービスである *nx_dns_server_add* を使用してサーバーを追加することもできます。 ただし、これは IPv4 アドレスのみを許容するため、開発者は代わりに *nxd_dns_server_add* サービスを使用することをお勧めします。

NX_DNS_IP_GATEWAY_SERVER オプションが有効になっていて、IP インスタンス ゲートウェイのアドレスがゼロ以外の場合は、IP インスタンス ゲートウェイがプライマリ DNS サーバーとして自動的に追加されます。 DNS サーバー情報を静的に認識していない場合は、NetX Duo 用の動的ホスト構成プロトコル (DHCP) を通じて取得することも可能です。 詳細については、『NetX Duo DHCP ユーザー ガイド』を参照してください。

DNS クライアントには、DNS メッセージを送信するためのパケット プールが必要です。 既定ではこのパケット プールは、*nx_dns_create* サービスが呼び出されたときに DNS クライアントによって作成されます。 構成オプションの NX_DNS_PACKET_PAYLOAD_UNALIGNED と NX_DNS_PACKET_POOL_SIZE を使用すると、アプリケーションでこのパケット プールのパケット ペイロードとパケット プール サイズ (パケット数など) をそれぞれ指定できます。 これらのオプションについては、第 2 章の「構成オプション」で説明しています。

DNS クライアントで独自のパケット プールを作成するのに代わる別の方法として、アプリケーションでパケット プールを作成し、*nx_dns_packet_pool_set* サービスを使用して DNS クライアントのパケット プールとして設定することもできます。 これを行うには、NX_DNS_CLIENT_USER_CREATE_PACKET_POOL オプションを定義する必要があります。 このオプションでは、*nx_dns_packet_pool_set* へのパケット プール ポインター入力として、事前に *nx_packet_pool_create* を使用して作成したパケット プールも必要となります。 NX_DNS_CLIENT_USER_CREATE_PACKET_POOL が有効になっている場合に DNS クライアント インスタンスが削除された場合、DNS クライアント パケット プールが不要であればアプリケーションがそれを削除する責任を持ちます。

> [!NOTE] 
> NX_DNS_CLIENT_USER_CREATE_PACKET_POOL オプションを使用して独自のパケット プールを指定するアプリケーションの場合、パケット サイズを、DNS の最大文字数 (512 bytes) に加えて、UDP ヘッダー、IPv4 または IPv6 ヘッダー、および MAC ヘッダー用のスペースを保持できるようにする必要があります。

## <a name="dns-messages"></a>DNS メッセージ

DNS では、ホスト名と IP アドレスの間のマッピングを取得するためのメカニズムは非常に簡単です。 マッピングを取得するために、DNS クライアントによって、解決する必要がある名前または IP アドレスを含む DNS クエリ メッセージが準備されます。 次に、サーバーの一覧の最初の DNS サーバーにメッセージが送信されます。 サーバーに要求されたマッピングが存在する場合、サーバーは要求されたマッピング情報を含む DNS 応答メッセージを使用して DNS クライアントに応答します。 サーバーが応答しない場合、DNS クライアントは一覧にある次のサーバーに対してクエリを行い、すべての DNS サーバーが照会されるまでこれを続けます。 すべての DNS サーバーから応答がなかった場合、DNS クライアントには DNS メッセージを再送信する再試行ロジックがあります。 DNS クエリを再送信した場合、再送信タイムアウトが 2 倍になります。 このプロセスは、最大転送タイムアウト (*nxd_dns.h* で NX_DNS_MAX_RETRANS_TIMEOUT として定義されています) に達するか、サーバーから正常な応答を受信するまで続行されます。

NetX Duo DNS クライアントでは、*nxd_dns_host_by_name_get* の呼び出しで IP アドレスのバージョンを指定することによって、IPv6 アドレス検索 (タイプ AAAA) と IPv4 アドレス検索 (タイプ A) の両方を実行できます。 DNS クライアントは *nxd_dns_host_by_address_get* を使用して、IP アドレスの逆引き参照 (タイプ PTR のクエリ) を実行して Web ホスト名を取得できます。 NetX Duo DNS クライアントでは依然として *nx_dns_host_by_name_get* と *nx_dns_host_by_address_get* がサポートされています。これは同等のサービスですが、IPv4 ネットワーク通信に限定されています。 ただし開発者は、既存の DNS クライアント アプリケーションを *nxd_dns_host_by_name_get* および *nxd_dns_host_by_address_get* サービスに移植することが推奨されています。

DNS メッセージでは、UDP プロトコルを利用して要求とフィールドの応答を送信します。 DNS サーバーは、クライアントからのクエリをポート番号 53 でリッスンします。 そのため、事前に作成した IP インスタンス (_*_nx_ip_create_**) で ***nx_udp_enable** _ サービスを使用して、NETX Duo で UDP サービスを有効にする必要があります。

この時点で、DNS クライアントがアプリケーションからの要求を受け入れて、DNS クエリを送信する準備ができました。

## <a name="extended-dns-resource-record-types"></a>拡張 DNS リソース レコード タイプ

NX_DNS_ENABLE_EXTENDED_RR_TYPES が有効になっている場合、NetX Duo DNS クライアントでは次のレコード タイプのクエリもサポートされます。

- CNAME: エイリアスの正規名が含まれています
- TXT: テキスト文字列が含まれています
- NS: 権威ネーム サーバーが含まれています
- SOA: 権威のゾーンの開始が含まれています
- MX: メール交換で使用されます
- SRV: ドメインによって提供されるサービスに関する情報が含まれています

CNAME および TXT レコード タイプを除いて、アプリケーションでは DNS データ レコードを受信するために、4-byte のアラインされたバッファーを提供する必要があります。

NetX Duo DNS クライアントでは、レコード データはバッファー領域を最も効率的に使用できるように格納されます。

固定長のレコード バッファー (タイプ AAAA レコード) の例を次に示します。

![固定長のレコード バッファー](media/image2.png)

ホスト名が可変長である NS レコードのような、レコード タイプが可変のデータ長を持つクエリの場合、NetX Duo DNS クライアントは次のようにデータを保存します。 DNS クライアント クエリで指定されたバッファーは、固定長データの領域と非構造化メモリの領域に編成されます。 メモリ バッファーの先頭は、4-byte のアラインされたレコード エントリに編成されます。 各レコード エントリには IP アドレスと、その IP アドレスの可変長データへのポインターが含まれます。 各 IP アドレスの可変長データは、メモリ バッファーの末尾から始まる非構造化領域のメモリに格納されます。 連続する各レコード エントリの可変長データは、前のレコード エントリの変数データに隣接する次の領域のメモリに保存されます。 そのため、新しいレコード エントリと可変長データを格納するためのメモリが不足するまで、レコード エントリを格納する構造化されたメモリ領域に向かって変数データが "増加" していきます。

これは次の図で示されます。

![図 2](media/image3.png)

DNS ドメイン名 (NS) データ ストレージの例を次に示します。

レコード ストレージ形式を使用する NetX Duo DNS クライアントのクエリは、レコード バッファーに保存されたレコードの数を返します。 この情報を使用して、アプリケーションでレコード バッファーから NS レコードを抽出できます。

このレコード ストレージ形式を使用して可変長の DNS データを格納する DNS クライアント クエリの例を次に示します。

```C
UINT  _nx_dns_domain_name_server_get(NX_DNS *dns_ptr, 
                    UCHAR *host_name, VOID *record_buffer, 
                    UINT buffer_size, UINT *record_count, 
                    ULONG wait_option);
```


詳細については、第 3 章の「DNS クライアント サービスの説明」を参照してください。

## <a name="dns-cache"></a>DNS キャッシュ

NX_DNS_CACHE_ENABLE が有効になっている場合、NetX Duo DNS クライアントでは DNS キャッシュ機能がサポートされます。 DNS クライアントを作成した後、アプリケーションでは API *nx_dns_cache_initialize()* を呼び出して、特別な DNS キャッシュを設定できます。 DNS キャッシュ機能を有効にすると、DNS クライアントは DNS クエリの送信を開始する前に、DNS キャッシュから使用可能な応答を検索します。使用可能な応答が見つかった場合は、その応答を直接アプリケーションに返します。見つからなかった場合、DNS クライアントは DNS サーバーにクエリ メッセージを送信し、応答を待ちます。 DNS クライアントが応答メッセージを取得したときに利用可能な空きキャッシュがある場合、DNS クライアントはアプリケーションに応答を返し、応答をリソース レコードとして DNS キャッシュに追加します。

それぞれの応答は、キャッシュ内の *NX_DNS_RR* データ構造体 (リソース レコード) に格納されます。 レコード内の文字列 (リソース レコード名とデータ) は可変長であるため、NX_DNS_RR 構造体には格納されません。 レコードには、文字列が格納されている実際のメモリ位置へのポインターが含まれています。 文字列テーブルとレコードはキャッシュを共有します。 レコードはキャッシュの先頭から格納され、キャッシュの末尾に向かって増加していきます。 文字列テーブルはキャッシュの末尾から開始し、キャッシュの先頭に向かって増加していきます。 文字列テーブル内の各文字列には、長さフィールドとカウンター フィールドがあります。 文字列が文字列テーブルに追加されるときに、同じ文字列がテーブルに既に存在する場合は、カウンター値が増分され、その文字列にはメモリが割り当てられません。 リソース レコードまたは新しい文字列をこれ以上キャッシュに追加できない場合、キャッシュはいっぱいであると見なされます。

## <a name="dns-client-limitations"></a>DNS クライアントの制限事項

DNS クライアントでは、一度に 1 つの DNS 要求がサポートされます。 別の DNS 要求を実行しようとしているスレッドは、前の DNS 要求が完了するまで一時的にブロックされます。

NetX Duo DNS クライアントは、権威のある応答からのデータを使用して、他の DNS サーバーに追加の DNS クエリを転送しません。

## <a name="dns-rfcs"></a>DNS RFC

NetX Duo DNS は、次の RFC に準拠しています。

- RFC1034 ドメイン名 - 概念と機能
- RFC1035 ドメイン名 - 実装と仕様
- RFC1480 US ドメイン
- RFC 2782 サービスの場所を指定するための DNS RR (DNS SRV)
- RFC 3596 IP バージョン 6 をサポートするための DNS 拡張