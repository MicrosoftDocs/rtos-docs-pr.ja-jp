---
title: 第 3 章 - 内部サービス キャッシュの説明
description: NetX Duo mDNS モジュールは、ローカル サービス キャッシュとピア サービス キャッシュの 2 つの内部サービス キャッシュを管理します。
author: philmea
ms.author: philmea
ms.date: 07/09/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: 007f1080a076730cfbcdedc9f063ac0c427a414c
ms.sourcegitcommit: e3d42e1f2920ec9cb002634b542bc20754f9544e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/22/2021
ms.locfileid: "104810730"
---
# <a name="chapter-3---description-of-internal-service-cache"></a>第 3 章 - 内部サービス キャッシュの説明

NetX Duo mDNS モジュールは、ローカル サービス キャッシュとピア サービス キャッシュの 2 つの内部サービス キャッシュを管理します。 ローカル サービス キャッシュには、ノードで実行されているアプリケーションが提供するサービスに関連付けられたリソース レコードが格納されます。 受信クエリの場合、提供されたサービスと質問が一致すると、ローカル サービス キャッシュに格納されている回答を含む応答が mDNS から返されます。 アプリケーションは、API *nx_mdns_service_add()* を呼び出すことによってサービスを登録します。 サービスを削除するには、アプリケーションは API *nx_mdns_service_delete()* を使用します。これにより、ローカル サービス キャッシュ内の対応するエントリが削除される前に "goodbye" というメッセージが送信されます。

サービスが追加された場合は、mDNS により、ローカル サービス キャッシュ内に少なくとも 3 つのリソース レコード (SRV、PTR、TXT) が保持されます。 サービスの種類にサブタイプが含まれている場合は、追加の PTR リソース レコードが追加されることがあります。 たとえば、アプリケーションがサービスを登録します。

```
*name*._*subtype*._sub._*type*._tcp.local,
```

2 つの PTR リソース レコードがローカル サービス キャッシュに追加されます。1 つは以下に該当します。

```
“*_subtype._*sub*._type._*tcp.local *PTR name.type._*tcp*.*local”
```

もう 1 つは以下に該当します。

```
*“_type._*tcp*.*local *PTR name.type._*tcp*.*local”.
```

ピア サービス キャッシュには、隣接ノードから受信した mDNS リソース レコードが格納されています。 mDNS モジュールは、ネットワーク上の他のノードによってアドバタイズされたリソース レコードを収集し、受信した情報をピア サービス キャッシュに格納します。 アプリケーションがホスト IPv4 または IPv6 アドレスなどの情報を照会すると、mDNS により、ピア サービス キャッシュ内でローカルにキャッシュされた応答が検索されます。 アプリケーションがピアによって提供されるサービスを照会すると、mDNS により、キャッシュ内で関連する PTR、SRV、TXT、および IPv4 または IPv6 アドレス レコードが検索されます。 ピア サービス キャッシュには、ノードに送信されたクエリも格納されます。 たとえば、アプリケーションは、*nx_mdns_service_one_shot_query* を呼び出すことによって特定のサービスを要求できます。 このサービスがピア サービス キャッシュ内に見つからない場合は、mDNS によって、ピア サービス キャッシュにクエリの質問 (PTR、SRV、TXT) が作成されます。 これらのクエリの質問は、サービスが解決されるかタイムアウトするまで、定期的にネットワークに送信されます。同様に、アプリケーションは、API *nx_mdns_service_continous_query()* を使用して、長期間にわたって特定のサービスを要求する場合があります (アプリケーションは、API *nx_mdns_service_query_stop()* を使用して、以前に発行された連続クエリを取り消します)。 ネットワークにクエリを送信せずにピア サービス キャッシュ内の特定のサービスを検索するには、アプリケーションで API *nx_mdns_serivce_lookup()* を使用できます。 この API を使用すると、ピア サービス キャッシュ内のリソース レコードのみが検索されます。

各リソース レコードは、サービス キャッシュ内のデータ構造体 *NX_MDNS_RR* に格納されます。 リソース レコードの文字列は可変長であるため、*NX_MDNS_RR* 構造体には格納されません。 リソース レコードには、文字列が格納されている実際のメモリ位置を指すポインターが格納されています。 文字列テーブルとリソース レコードは、サービス キャッシュを共有します。 リソース レコードは、サービス キャッシュの先頭から格納され、キャッシュの末尾に向かって増加していきます。 文字列テーブルは、サービス キャッシュの末尾から開始され、キャッシュの先頭に向かって増加していきます。 文字列テーブル内の各文字列には、長さフィールドとカウンター フィールドがあります。 文字列が文字列テーブルに追加されたときに、同じ文字列が既にそのテーブルに存在する場合は、カウンター値が増分され、その文字列にはメモリが割り当てられません。 リソース レコードまたは新しい文字列をこれ以上サービス キャッシュに追加できない場合、サービス キャッシュはいっぱいであると見なされます。

アプリケーションがローカル ネットワークで提供されているサービスを見つける方法は 2 つあります。 ワンショット クエリを介して特定のサービス検索を発行するか、ネットワーク上のアクティビティを "監視" する連続クエリを開始することができます。 ワンショット クエリのシナリオでは、アプリケーションがサービスの種類を指定する必要があります。 mDNS により、ローカル サービス キャッシュとピア サービス キャッシュが検索されます。 サービス インスタンスが見つかった場合は、ワンショット クエリでリソース レコード内に見つかった情報が返されます。 ローカル サービス キャッシュまたはピア サービス キャッシュにレコードがない場合は、mDNS によってクエリ メッセージが送信されます。 インスタンス名が指定されている場合、*ANY* 型 (SRV および TXT 型を照会) と特定のインスタンス名が "name.type.local" 形式でローカル ネットワークに送信されます。 インスタンス名が指定されていない場合は、PTR 型のクエリがローカル ネットワークに送信されます。 最初に受信した完全なサービスが呼び出し元に返されます。

連続クエリの動作は異なります。 連続クエリの一般的なユース ケースには、特定のサービスについてローカル ネットワークを監視することがあります (たとえば、ローカル ネットワーク上で印刷サービスを定期的に探すため)。 この場合、アプリケーションは、特定の種類のサービスに対して (API *nx_mdns_service_continious_query* を介して) 検索クエリを発行します。 呼び出し元は、通常、特定の応答を待機しません。 連続クエリとして送信されるクエリの場合、mDNS モジュールは、指数関数的に増加する間隔でクエリを定期的に送信します。 クエリを停止するには、アプリケーションで API *nx_mdns_service_query_stop* を使用して、これらのクエリの内部タイマーを停止する必要があります。 クエリの種類は NULL にすることができます。その場合、特殊な PTR 型の "_services._dns-sd._udp.local" にクエリの種類が設定されます。 このサービスの種類は、ローカル ネットワーク上で使用可能なすべてのサービスを検出する方法として mDNS によって定義されています。 インスタンス名が指定されている場合、ANY 型 (SRV および TXT 型を照会) と特定のインスタンス名の "name.type.local" がローカル ネットワークに送信されます。 インスタンス名が NULL の場合は、PTR 型のクエリがローカル ネットワークに送信されます。

すべての応答 (要求されていないクエリからの応答を含む) は、ピア サービス キャッシュに記録されます。 アプリケーションは後で API *nx_mdns_service_lookup* を使用して、ピア サービス キャッシュから特定のサービスを取得します。

断片化に関する注意事項: 各 *NX_MDNS_RR* 構造体はサイズが固定されているため、mDNS によって RR が追加および削除されたときに断片化の影響を受けません。 一方、文字列は可変長です。 文字列が削除されると、その領域が使用可能になります。そこに新しい文字列が収まる場合は、その新しい文字列用にその領域を使用できます。 ただし、この操作によってメモリが断片化されます。 サービスの追加と削除が繰り返されると、文字列テーブルが断片化され、文字列のために十分な未使用バイトがサービス キャッシュに含まれていても新しい文字列を追加できなくなる場合があります。 ローカル アプリケーションの安定性と予測可能性は高くなる傾向があります。 したがって、ローカル サービス キャッシュの方が断片化の影響を受けにくくなります。 一方、ピア サービス キャッシュでは常に、サービスが使用可能になると RR が追加され、ネットワーク上のノードによってサービスが削除されると RR が削除されます。 ネットワーク上のサービスは一定ではないため、文字列テーブルに対してより頻繁に割り当てまたは削除操作が発生します。 時間が経つにつれて、文字列テーブルが断片化する可能性があります。 その状況が発生した場合の簡単な解決策として、ピア サービス キャッシュ全体をフラッシュします。 これを行うには、API *nx_mdns_peer_cache_clear()* を呼び出します。 この API により未処理の連続クエリが自動的に終了することに注意してください。
