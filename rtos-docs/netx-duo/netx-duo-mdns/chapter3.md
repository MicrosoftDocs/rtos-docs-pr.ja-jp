---
title: 第 3 章 - 内部サービス キャッシュの説明
description: NetX Duo mDNS モジュールは、ローカル サービス キャッシュとピア サービス キャッシュの 2 つの内部サービス キャッシュを管理します。
author: philmea
ms.author: philmea
ms.date: 07/09/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: 007f1080a076730cfbcdedc9f063ac0c427a414c
ms.sourcegitcommit: e3d42e1f2920ec9cb002634b542bc20754f9544e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/22/2021
ms.locfileid: "104810730"
---
# <a name="chapter-3---description-of-internal-service-cache"></a><span data-ttu-id="c92b5-103">第 3 章 - 内部サービス キャッシュの説明</span><span class="sxs-lookup"><span data-stu-id="c92b5-103">Chapter 3 - Description of internal service cache</span></span>

<span data-ttu-id="c92b5-104">NetX Duo mDNS モジュールは、ローカル サービス キャッシュとピア サービス キャッシュの 2 つの内部サービス キャッシュを管理します。</span><span class="sxs-lookup"><span data-stu-id="c92b5-104">NetX Duo mDNS module manages two internal services caches: the local service cache, and the peer service cache.</span></span> <span data-ttu-id="c92b5-105">ローカル サービス キャッシュには、ノードで実行されているアプリケーションが提供するサービスに関連付けられたリソース レコードが格納されます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-105">The local service cache stores Resource Records related to services offered by applications running on the node.</span></span> <span data-ttu-id="c92b5-106">受信クエリの場合、提供されたサービスと質問が一致すると、ローカル サービス キャッシュに格納されている回答を含む応答が mDNS から返されます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-106">For incoming queries, if the question matches the service offered, mDNS responses with answers stored in the local service cache.</span></span> <span data-ttu-id="c92b5-107">アプリケーションは、API *nx_mdns_service_add()* を呼び出すことによってサービスを登録します。</span><span class="sxs-lookup"><span data-stu-id="c92b5-107">Applications register services by calling the API *nx_mdns_service_add()*.</span></span> <span data-ttu-id="c92b5-108">サービスを削除するには、アプリケーションは API *nx_mdns_service_delete()* を使用します。これにより、ローカル サービス キャッシュ内の対応するエントリが削除される前に "goodbye" というメッセージが送信されます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-108">To remove services, applications use the API *nx_mdns_service_delete()*, which will in turn send "goodbye" messages before removing the corresponding entries in the local service cache.</span></span>

<span data-ttu-id="c92b5-109">サービスが追加された場合は、mDNS により、ローカル サービス キャッシュ内に少なくとも 3 つのリソース レコード (SRV、PTR、TXT) が保持されます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-109">When a service is added, mDNS maintains at least 3 Resource Records in the local service cache: SRV, PTR, and TXT.</span></span> <span data-ttu-id="c92b5-110">サービスの種類にサブタイプが含まれている場合は、追加の PTR リソース レコードが追加されることがあります。</span><span class="sxs-lookup"><span data-stu-id="c92b5-110">Additional PTR Resource Record may be added if the service type includes subtype.</span></span> <span data-ttu-id="c92b5-111">たとえば、アプリケーションがサービスを登録します。</span><span class="sxs-lookup"><span data-stu-id="c92b5-111">For example, an application registers a service:</span></span>

```
*name*._*subtype*._sub._*type*._tcp.local,
```

<span data-ttu-id="c92b5-112">2 つの PTR リソース レコードがローカル サービス キャッシュに追加されます。1 つは以下に該当します。</span><span class="sxs-lookup"><span data-stu-id="c92b5-112">two PTR Resource Records are added to the local service cache, one for</span></span>

```
“*_subtype._*sub*._type._*tcp.local *PTR name.type._*tcp*.*local”
```

<span data-ttu-id="c92b5-113">もう 1 つは以下に該当します。</span><span class="sxs-lookup"><span data-stu-id="c92b5-113">and the other one for</span></span>

```
*“_type._*tcp*.*local *PTR name.type._*tcp*.*local”.
```

<span data-ttu-id="c92b5-114">ピア サービス キャッシュには、隣接ノードから受信した mDNS リソース レコードが格納されています。</span><span class="sxs-lookup"><span data-stu-id="c92b5-114">The peer service cache contains mDNS Resource Records received from neighboring nodes.</span></span> <span data-ttu-id="c92b5-115">mDNS モジュールは、ネットワーク上の他のノードによってアドバタイズされたリソース レコードを収集し、受信した情報をピア サービス キャッシュに格納します。</span><span class="sxs-lookup"><span data-stu-id="c92b5-115">mDNS module collects Resource Records advertised by other nodes on the network, and stores the received information in the peer service cache.</span></span> <span data-ttu-id="c92b5-116">アプリケーションがホスト IPv4 または IPv6 アドレスなどの情報を照会すると、mDNS により、ピア サービス キャッシュ内でローカルにキャッシュされた応答が検索されます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-116">When application queries for information such as host IPv4 or IPv6 addresses, mDNS searches the peer service cache for locally cached responses.</span></span> <span data-ttu-id="c92b5-117">アプリケーションがピアによって提供されるサービスを照会すると、mDNS により、キャッシュ内で関連する PTR、SRV、TXT、および IPv4 または IPv6 アドレス レコードが検索されます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-117">When application queries for services offered by peers, mDNS searches through the cache for related PTR, SRV, TXT, and IPv4/IPv6 address records.</span></span> <span data-ttu-id="c92b5-118">ピア サービス キャッシュには、ノードに送信されたクエリも格納されます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-118">The peer service cache also stores queries sent to the node.</span></span> <span data-ttu-id="c92b5-119">たとえば、アプリケーションは、*nx_mdns_service_one_shot_query* を呼び出すことによって特定のサービスを要求できます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-119">For example, an application may request a particular service by calling *nx_mdns_service_one_shot_query.*</span></span> <span data-ttu-id="c92b5-120">このサービスがピア サービス キャッシュ内に見つからない場合は、mDNS によって、ピア サービス キャッシュにクエリの質問 (PTR、SRV、TXT) が作成されます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-120">If the service is not found in the peer service cache, mDNS creates query questions (PTR, SRV, and TXT) in the peer service cache.</span></span> <span data-ttu-id="c92b5-121">これらのクエリの質問は、サービスが解決されるかタイムアウトするまで、定期的にネットワークに送信されます。同様に、アプリケーションは、API *nx_mdns_service_continous_query()* を使用して、長期間にわたって特定のサービスを要求する場合があります (アプリケーションは、API *nx_mdns_service_query_stop()* を使用して、以前に発行された連続クエリを取り消します)。</span><span class="sxs-lookup"><span data-stu-id="c92b5-121">These query questions will be sent to the network periodically till the service is resolved, or times out. Similar, the application may use the API *nx_mdns_service_continous_query()* to request a particular service over a long period of time (application cancels a previously issued continuous query by using the API *nx_mdns_service_query_stop()* ).</span></span> <span data-ttu-id="c92b5-122">ネットワークにクエリを送信せずにピア サービス キャッシュ内の特定のサービスを検索するには、アプリケーションで API *nx_mdns_serivce_lookup()* を使用できます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-122">To search for a particular service in the peer service cache without sending queries to the network, applications can use the API *nx_mdns_serivce_lookup().*</span></span> <span data-ttu-id="c92b5-123">この API を使用すると、ピア サービス キャッシュ内のリソース レコードのみが検索されます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-123">This API only searches the resource records in the peer service cache.</span></span>

<span data-ttu-id="c92b5-124">各リソース レコードは、サービス キャッシュ内のデータ構造体 *NX_MDNS_RR* に格納されます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-124">Each Resource Record is stored in a data structure *NX_MDNS_RR* in the service caches.</span></span> <span data-ttu-id="c92b5-125">リソース レコードの文字列は可変長であるため、*NX_MDNS_RR* 構造体には格納されません。</span><span class="sxs-lookup"><span data-stu-id="c92b5-125">Strings in Resource Records are variable length, therefore are not stored in the *NX_MDNS_RR* structure.</span></span> <span data-ttu-id="c92b5-126">リソース レコードには、文字列が格納されている実際のメモリ位置を指すポインターが格納されています。</span><span class="sxs-lookup"><span data-stu-id="c92b5-126">The Resource Record contains a pointer to the actual memory location where the string is stored.</span></span> <span data-ttu-id="c92b5-127">文字列テーブルとリソース レコードは、サービス キャッシュを共有します。</span><span class="sxs-lookup"><span data-stu-id="c92b5-127">The string table and the Resource Records share the service cache.</span></span> <span data-ttu-id="c92b5-128">リソース レコードは、サービス キャッシュの先頭から格納され、キャッシュの末尾に向かって増加していきます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-128">Resource Records are stored from the beginning of the service cache, and grow towards the end of the cache.</span></span> <span data-ttu-id="c92b5-129">文字列テーブルは、サービス キャッシュの末尾から開始され、キャッシュの先頭に向かって増加していきます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-129">The string table starts from the end of the service cache and grows towards the beginning of the cache.</span></span> <span data-ttu-id="c92b5-130">文字列テーブル内の各文字列には、長さフィールドとカウンター フィールドがあります。</span><span class="sxs-lookup"><span data-stu-id="c92b5-130">Each string in the string table has a length field and a counter field.</span></span> <span data-ttu-id="c92b5-131">文字列が文字列テーブルに追加されたときに、同じ文字列が既にそのテーブルに存在する場合は、カウンター値が増分され、その文字列にはメモリが割り当てられません。</span><span class="sxs-lookup"><span data-stu-id="c92b5-131">When a string is added to the string table, if the same string is already present in the table, the counter value is incremented and no memory is allocated for the string.</span></span> <span data-ttu-id="c92b5-132">リソース レコードまたは新しい文字列をこれ以上サービス キャッシュに追加できない場合、サービス キャッシュはいっぱいであると見なされます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-132">The service cache is considered full if no more resource records or new strings can be added to the service cache.</span></span>

<span data-ttu-id="c92b5-133">アプリケーションがローカル ネットワークで提供されているサービスを見つける方法は 2 つあります。</span><span class="sxs-lookup"><span data-stu-id="c92b5-133">There are two ways for an application to find services offered on the local network.</span></span> <span data-ttu-id="c92b5-134">ワンショット クエリを介して特定のサービス検索を発行するか、ネットワーク上のアクティビティを "監視" する連続クエリを開始することができます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-134">It can either issue a specific service look up through a one-shot query, or it can initiate a continuous query to “monitor” the activities on the network.</span></span> <span data-ttu-id="c92b5-135">ワンショット クエリのシナリオでは、アプリケーションがサービスの種類を指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="c92b5-135">In the one-short query scenario, the application must specify the service type.</span></span> <span data-ttu-id="c92b5-136">mDNS により、ローカル サービス キャッシュとピア サービス キャッシュが検索されます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-136">mDNS searches through the local service cache and the peer service cache.</span></span> <span data-ttu-id="c92b5-137">サービス インスタンスが見つかった場合は、ワンショット クエリでリソース レコード内に見つかった情報が返されます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-137">If a service instances is located, the one-shot query returns with the information found in the Resource Records.</span></span> <span data-ttu-id="c92b5-138">ローカル サービス キャッシュまたはピア サービス キャッシュにレコードがない場合は、mDNS によってクエリ メッセージが送信されます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-138">If there are no records in the local service cache or peer service cache, mDNS sends out query messages.</span></span> <span data-ttu-id="c92b5-139">インスタンス名が指定されている場合、*ANY* 型 (SRV および TXT 型を照会) と特定のインスタンス名が "name.type.local" 形式でローカル ネットワークに送信されます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-139">If the instance name is specified, an *ANY* type (query the SRV and TXT type) with the specific instance name, in the form of “name.type.local”, is sent to the local network.</span></span> <span data-ttu-id="c92b5-140">インスタンス名が指定されていない場合は、PTR 型のクエリがローカル ネットワークに送信されます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-140">If the instance name is not specified, a PTR type of query is sent to the local network.</span></span> <span data-ttu-id="c92b5-141">最初に受信した完全なサービスが呼び出し元に返されます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-141">The first complete service received is returned to the caller.</span></span>

<span data-ttu-id="c92b5-142">連続クエリの動作は異なります。</span><span class="sxs-lookup"><span data-stu-id="c92b5-142">Continuous query works differently.</span></span> <span data-ttu-id="c92b5-143">連続クエリの一般的なユース ケースには、特定のサービスについてローカル ネットワークを監視することがあります (たとえば、ローカル ネットワーク上で印刷サービスを定期的に探すため)。</span><span class="sxs-lookup"><span data-stu-id="c92b5-143">The typical use case for a continuous query is to monitor the local network for a specific service (for example to constantly look for printing services on the local network).</span></span> <span data-ttu-id="c92b5-144">この場合、アプリケーションは、特定の種類のサービスに対して (API *nx_mdns_service_continious_query* を介して) 検索クエリを発行します。</span><span class="sxs-lookup"><span data-stu-id="c92b5-144">In this case the application issues a search query (via the API *nx_mdns_service_continious_* query) for certain type of services.</span></span> <span data-ttu-id="c92b5-145">呼び出し元は、通常、特定の応答を待機しません。</span><span class="sxs-lookup"><span data-stu-id="c92b5-145">The caller typically does not wait for a particular response.</span></span> <span data-ttu-id="c92b5-146">連続クエリとして送信されるクエリの場合、mDNS モジュールは、指数関数的に増加する間隔でクエリを定期的に送信します。</span><span class="sxs-lookup"><span data-stu-id="c92b5-146">For queries submitted as continuous query, the mDNS module transmits the queries periodically with exponentially increasing intervals.</span></span> <span data-ttu-id="c92b5-147">クエリを停止するには、アプリケーションで API *nx_mdns_service_query_stop* を使用して、これらのクエリの内部タイマーを停止する必要があります。</span><span class="sxs-lookup"><span data-stu-id="c92b5-147">To stop the query, application must use the API *nx_mdns_service_query_stop* to stop the internal timer in these queries.</span></span> <span data-ttu-id="c92b5-148">クエリの種類は NULL にすることができます。その場合、特殊な PTR 型の "_services._dns-sd._udp.local" にクエリの種類が設定されます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-148">The query type can be NULL, in which case the query type is set to special PTR type “_services._dns-sd._udp.local”.</span></span> <span data-ttu-id="c92b5-149">このサービスの種類は、ローカル ネットワーク上で使用可能なすべてのサービスを検出する方法として mDNS によって定義されています。</span><span class="sxs-lookup"><span data-stu-id="c92b5-149">This service type is defined by mDNS as a way to discover all services available on the local network.</span></span> <span data-ttu-id="c92b5-150">インスタンス名が指定されている場合、ANY 型 (SRV および TXT 型を照会) と特定のインスタンス名の "name.type.local" がローカル ネットワークに送信されます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-150">If the instance name is supplied, an ANY type (query the SRV and TXT type) with the specific instance name “name.type.local” is sent to the local network.</span></span> <span data-ttu-id="c92b5-151">インスタンス名が NULL の場合は、PTR 型のクエリがローカル ネットワークに送信されます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-151">If the instance name is NULL, a PTR type of query is sent to the local network,</span></span>

<span data-ttu-id="c92b5-152">すべての応答 (要求されていないクエリからの応答を含む) は、ピア サービス キャッシュに記録されます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-152">All responses, including responses from unsolicited queries, are recorded in the peer service cache.</span></span> <span data-ttu-id="c92b5-153">アプリケーションは後で API *nx_mdns_service_lookup* を使用して、ピア サービス キャッシュから特定のサービスを取得します。</span><span class="sxs-lookup"><span data-stu-id="c92b5-153">At a later time, the application uses the API *nx_mdns_service_lookup* to retrieve specific service from the peer service cache.</span></span>

<span data-ttu-id="c92b5-154">断片化に関する注意事項: 各 *NX_MDNS_RR* 構造体はサイズが固定されているため、mDNS によって RR が追加および削除されたときに断片化の影響を受けません。</span><span class="sxs-lookup"><span data-stu-id="c92b5-154">Special note on fragmentation: Each *NX_MDNS_RR* structure is fixed in size, and therefore is not subject to fragmentation as mDNS adds and deletes RRs.</span></span> <span data-ttu-id="c92b5-155">一方、文字列は可変長です。</span><span class="sxs-lookup"><span data-stu-id="c92b5-155">However strings are variable length.</span></span> <span data-ttu-id="c92b5-156">文字列が削除されると、その領域が使用可能になります。そこに新しい文字列が収まる場合は、その新しい文字列用にその領域を使用できます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-156">After a string is deleted, the space becomes available and could be used for a new string if the new string is able to fit in.</span></span> <span data-ttu-id="c92b5-157">ただし、この操作によってメモリが断片化されます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-157">But this operation causes the memory to fragment.</span></span> <span data-ttu-id="c92b5-158">サービスの追加と削除が繰り返されると、文字列テーブルが断片化され、文字列のために十分な未使用バイトがサービス キャッシュに含まれていても新しい文字列を追加できなくなる場合があります。</span><span class="sxs-lookup"><span data-stu-id="c92b5-158">As services are added and removed, the string table may be fragmented to the point that no new strings can be added even though the service cache contains enough unused bytes for the string.</span></span> <span data-ttu-id="c92b5-159">ローカル アプリケーションの安定性と予測可能性は高くなる傾向があります。</span><span class="sxs-lookup"><span data-stu-id="c92b5-159">Local applications tend to be more stable and predictable.</span></span> <span data-ttu-id="c92b5-160">したがって、ローカル サービス キャッシュの方が断片化の影響を受けにくくなります。</span><span class="sxs-lookup"><span data-stu-id="c92b5-160">Therefore the local service cache is less likely to suffer from fragmentation.</span></span> <span data-ttu-id="c92b5-161">一方、ピア サービス キャッシュでは常に、サービスが使用可能になると RR が追加され、ネットワーク上のノードによってサービスが削除されると RR が削除されます。</span><span class="sxs-lookup"><span data-stu-id="c92b5-161">The peer service cache, on the other hand, constantly add RRs as the services become available, or remove RRs as services are deleted by the nodes on the network.</span></span> <span data-ttu-id="c92b5-162">ネットワーク上のサービスは一定ではないため、文字列テーブルに対してより頻繁に割り当てまたは削除操作が発生します。</span><span class="sxs-lookup"><span data-stu-id="c92b5-162">Services on the network come and go, causing more frequent allocate/delete operations on the string table.</span></span> <span data-ttu-id="c92b5-163">時間が経つにつれて、文字列テーブルが断片化する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="c92b5-163">Over time it is possible the string table becomes fragmented.</span></span> <span data-ttu-id="c92b5-164">その状況が発生した場合の簡単な解決策として、ピア サービス キャッシュ全体をフラッシュします。</span><span class="sxs-lookup"><span data-stu-id="c92b5-164">When this situation happens, a simple solution is to flush the entire peer service cache.</span></span> <span data-ttu-id="c92b5-165">これを行うには、API *nx_mdns_peer_cache_clear()* を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="c92b5-165">This can be done by calling the API *nx_mdns_peer_cache_clear().*</span></span> <span data-ttu-id="c92b5-166">この API により未処理の連続クエリが自動的に終了することに注意してください。</span><span class="sxs-lookup"><span data-stu-id="c92b5-166">Note that this API automatically terminates any outstanding continuous queries.</span></span>
