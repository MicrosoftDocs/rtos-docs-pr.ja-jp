---
title: 第 1 章 - ネットワーク アドレス変換の概要
description: IP のネットワーク アドレス変換 (NAT) は、もともと、限られた数のインターネット IPv4 アドレスの問題を解決するために開発されました。
author: philmea
ms.author: philmea
ms.date: 07/14/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: 8639b87decd78f58a34fe6b8033a2427b560c872814abfdbbcb6057166412d0d
ms.sourcegitcommit: 93d716cf7e3d735b18246d659ec9ec7f82c336de
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/07/2021
ms.locfileid: "116797467"
---
# <a name="chapter-1---an-introduction-to-network-address-translation"></a>第 1 章 - ネットワーク アドレス変換の概要

## <a name="the-need-for-network-address-translation"></a>ネットワーク アドレス変換の必要性

IP のネットワーク アドレス変換 (NAT) は、もともと、限られた数のインターネット IPv4 アドレスの問題を解決するために開発されました。 複数のデバイスがインターネットにアクセスする必要があり、しかしインターネット サービス プロバイダー (ISP) によって割り当てられる IPv4 インターネット アドレスが 1 つだけである場合、NAT が必要になります。

NAT を使用すると、他にも利点があります。 ローカル ドメインの外部のネットワーク トポロジを、さまざまな方法で変更できます。 お客様はプロバイダーを変更したり、企業はバックボーンを再構成したり、プロバイダーを結合または分割したりすることができます。 外部のトポロジが変化するたびに、それらの外部の変更を反映するように、ローカル ドメイン内のホストのアドレスの割り当ても変更する必要があります。 この種の変更は、単一のアドレス変換ルーターに変更を一元化することで、ドメイン内のユーザーに認識されないようにすることができます。 NAT を使用すると、ローカル ホストからパブリック インターネットにアクセスできるようになり、外部からの直接アクセスから保護されます。 ネットワークのセットアップは内部使用が中心で、外部アクセスの必要性が低い組織は、このスキームの候補として適しています。

## <a name="basic-nat-and-network-address-port-translation"></a>基本的な NAT とネットワーク アドレス ポート変換

NAT 対応のルーターは、パブリック ネットワークとプライベート ネットワークの間にインストールされます。 NAT 対応のルーターの役割は、内部のプライベート IPv4 アドレスと、割り当てられているパブリック IPv4 アドレスとの間の変換を行うことなので、プライベート ネットワーク上のすべてのデバイスが、同じパブリック IPv4 アドレスを共有できます。

NAT の基本的な実装では、NAT ルーターにより、自身の IP アドレスとは別に、1 つまたは複数のグローバルに登録された IP アドレスが "所有されます"。 これらのグローバル アドレスは、プライベート ネットワーク上のホストに静的または動的に割り当てることができます。 NAPT (ネットワーク アドレス ポート変換) は基本的な NAT の一種であり、"トランスポート" 識別子を含むようにネットワーク アドレス変換が拡張されたものです。 通常、これは、TCP および UDP パケットの場合はポート番号、ICMP パケットの場合はクエリ ID です。

NAT 境界をまたぐ接続は、通常、外部ホストに発信パケットを送信するプライベート ネットワーク上のホストによって開始されます。 通常、これらのホストには、この目的のために (一時的な) IP アドレスが "*動的に*" 割り当てられます。 ただし、プライベート ネットワークに "サーバー" (たとえば、外部ネットワークからのクライアント要求を受け付ける HTTP または FTP サーバーなど) がある場合は、逆方向に接続を開始することもできます。 通常、これらのローカル ホストには、NAT により、"*静的な*" (永続的) IP アドレス:ポートが割り当てられます。

## <a name="how-network-address-translation-works"></a>ネットワーク アドレス変換の仕組み

図 1 は、NAT 対応ルーターを使用する一般的なネットワーク設定を示したものです。

![NAT 対応ルーターのある一般的なネットワーク設定](media/image2.png)

**図 1 - NAT 対応ルーターのある一般的なネットワーク設定**

NAT 対応ルーターには、通常、2 つのネットワーク インターフェイスがあります。 1 つのインターフェイスは、パブリック インターネットに接続されています。もう 1 つは、プライベート ネットワークに接続されています。 このセットアップでの一般的なルーターには、宛先 IP アドレスに基づいてプライベート ネットワークとパブリック ネットワークの間で IP データグラムをルーティングする役割があります。 NAT 対応ルーターにより、パブリック インターフェイスとプライベート インターフェイスの間で IPv4 データグラムがルーティングされる前に、アドレス変換が実行されます。 変換は、内部送信元アドレス、送信元ポート番号、外部宛先アドレス、宛先ポート番号に基づいて、TCP または UDP のセッションごとに確立されます。 ICMP のエコー要求と応答データグラムの場合は、ポート番号の代わりに ICMP クエリ ID が使用されます。

ネットワーク アドレス変換の一般的な実装を示すため、図 2 のネットワーク設定について考えてみましょう。

![ネットワーク アドレス変換の一般的な実装](media/image3.png)

**図 2 - ネットワーク アドレス変換の一般的な実装**

このシナリオでは、NAT ルーターによって、左側のプライベート ネットワークと、右側のパブリック ネットワークが接続されます。 パブリック ネットワーク側の NAT ルーター インターフェイスの IP アドレスは 202.151.25.14 であり、プライベート ネットワーク インターフェイス側では、NAT ルーターによって IP アドレス 192.168.1.254 が使用されているものとします。 プライベート ネットワーク上のノードによって、インターネット上の Web サーバーとの TCP 接続が開始されます。

図 3 は、ネットワーク アドレス変換プロセスの概要を示したものです。

![ネットワーク アドレス変換プロセスの概要](media/image4.png)

**図 3 - ネットワーク アドレス変換プロセスの概要**

1. クライアントによって、TCP SYN メッセージが Web サーバーに送信されます。 送信元のアドレスは 192.168.1.15 で、ポート番号 6732 です。宛先のアドレスは 128.15.54.3 で、ポート番号 80 です。
1. クライアントからのパケットは、NAT ルーターによってプライベート ネットワーク インターフェイスで受信されます。 送信トラフィック規則がパケットに適用されます。送信側 (クライアント) のアドレスは NAT ルーターのパブリック IP アドレス 202.15.25.14 に変換され、送信側 (クライアント) の送信元ポート番号はパブリック インターフェイスの TCP ポート番号 2015 に変換されます。
1. パケットが、インターネットを介して送信され、最終的に宛先ホスト 128.15.54.3 に到達します。 受信側では、IP レイヤーの送信元アドレスと TCP レイヤーのポート番号に基づいて、パケットの発信元が 202.151.24.14、ポート番号が 2015 であることがわかります。
   図 4 に、戻りパスでの NAT プロセスを示します。

   ![戻りパスでの NAT プロセス](media/image5.png)

   **図 4 - 戻りパスでの NAT プロセス**
1. このシナリオでは、インターネット ホスト 128.15.54.3 により、NAT ルーターのインターネット アドレスを宛先として、応答パケットが送信されます。
1. パケットが NAT ルーターに到達します。 これは受信パケットであるため、受信変換規則が適用されます。宛先アドレスは、元の送信側 (クライアント) の IP アドレス 192.168.1.15 と宛先ポート番号 6732 に戻されます。
1. その後、パケットは、内部ネットワークに接続されているインターフェイスを介してクライアントに転送されます。

この方法では、送信側のインターネット ネットワーク アドレスとポート番号は、パブリック インターネット上の他のホストに公開されません。

## <a name="netx-duo-nat-features"></a>NetX Duo NAT の機能

*nx_nat_create* の呼び出しを使用して NAT インスタンスが作成されると、NAT 変換テーブルが作成されます。

```C
UINT nx_nat_create(NX_NAT_DEVICE *nat_ptr, NX_IP *ip_ptr,
    UINT global_interface_index,
    VOID *dynamic_cache_memory,
    UINT dynamic_cache_size);
```

ローカルと外部のネットワーク間のすべてのアクティブな接続のネットワーク アドレス変換を追跡するため、NetX Duo NAT 対応ルーターによって、送信元と宛先の IP アドレスとポート番号が含まれる、各プライベート ホスト接続に関する情報についての変換テーブルが保持されます。

この変換テーブル ("cache") の場所は、dynamic_cache_memory ポインターを使用して設定されます。 この領域は、4 バイトでアラインされたバッファー領域である必要があります。 テーブルのサイズ (つまりエントリの数) は、キャッシュ サイズ dynamic_cache_size を NAT テーブル エントリのサイズで除算することによって決定されます。 テーブルは、*nx_nat.h* で定義されている **NX_NAT_MIN_ENTRY_COUNT によって指定されている最小エントリ数に対して十分な大きさである必要があります。既定値は 3 です。**

NetX Duo NAT 変換テーブル内のすべての動的エントリのタイムアウトは、*nx_nat.h* で定義されている NX_NAT_ENTRY_RESPONSE_TIMEOUT に初期化されます。 RFC 2663 で推奨されているように、既定値は 4 分 (つまり、100 mHz プロセッサで 240 システム ティック) です。 NetX Duo NAT により、テーブル内の動的エントリと一致するパケットが受信または送信されるたびに、そのエントリのタイムアウトが NX_NAT_ENTRY_RESPONSE_TIMEOUT にリセットされます。 テーブルを検索するときに、NetX Duo NAT によってテーブルで期限切れのエントリもチェックされて、削除されます。

テーブルで受信エントリを静的として作成するには (ローカル ネットワーク上のサーバーなど)、NetX Duo NAT によって *nx_nat_inbound_entry_create* サービスが提供されます。 テーブル エントリで静的として定義されているローカル ホスト接続には、有効期限はありません。

```C
UINT nx_nat_inbound_entry_create(NX_NAT_DEVICE *nat_ptr,
    NX_NAT_TRANSLATION_ENTRY *entry_ptr,
    ULONG local_ip_address, USHORT external_port,
    USHORT local_port, UCHAR protocol);
```

このサービスについては、[サービスの説明に関する第 4 章](chapter4.md)で詳しく説明されています

実行時に、変換テーブルに空きがなく、それ以上エントリを追加できない場合、キャッシュ フル コールバックが NAT インスタンスに登録されていると、NetX Duo NAT によりそれを通して NAT アプリケーションに通知されます。 これは、*nx_nat_cache_notify_set* サービスを使用して行われます。

```C
UINT nx_nat_cache_notify_set(NX_NAT_DEVICE *nat_ptr,
    VOID (*cache_full_notify_cb)(NX_NAT_DEVICE *nat_ptr));
```

このサービスの詳細については、[サービスの説明に関する第 4 章](chapter4.md)を参照してください。

## <a name="nat-packet-processing-in-netx-duo"></a>NetX Duo での NAT パケットの処理

NetX Duo NAT は、IPv4 ルーターで使用することが意図されています。 NAT が機能するには、NAT サーバーにパケットを転送するように NetX Duo を構成する必要があります。 その方法については、NetX Duo NAT のインストールに関する第 2 章を参照してください。 その場合、NAT サーバーでは、いずれかのネットワーク上のホストに対するパケットを "使用" (転送を試行) するかどうかが示されます。 パケットが使用されない場合、パケットは、通常どおり、パケットの処理のために NetX Duo に "返され" ます。

NAT サーバーは、NetX Duo から転送するパケットを受信すると、パケットが受信と送信のどちらであるかを判断します。

送信パケットの場合は、NAT サーバーによってパケットの IP ヘッダーの送信元アドレスとポートが確認されます。 以前にこのホストによって同じ宛先に送信されたパケットのエントリが変換テーブルに含まれていない場合は、NAT によって、その接続に対する一意のグローバル送信元 IP アドレス:ポートが含まれる新しいエントリが作成され、外部ネットワークに送信する前に、パケットのヘッダーがこの新しい IP アドレス:ポートで変更されます。

受信パケットの場合は、NAT サーバーによって、パケットの宛先 IP アドレス:ポートと一致する外部 IP アドレス:ポートが含まれる以前のエントリが、変換テーブルで検索されます。 一致するものが見つからない場合、宛先アドレス:ポートがローカル ネットワーク上のサーバーの外部アドレスでない限り、パケットは破棄されます。 一致するものが見つかった場合は、パケット ヘッダーの外部宛先 IP アドレス:ポートがプライベート IP アドレス:ポートに置き換えられて、パケットはローカル ネットワーク上の目的のプライベート ホストに送信されます。

外部ホストと接続するローカル ホスト用の一意のローカル アドレス:ポート接続を作成するため、NetX Duo NAT により、TCP、UDP、ICMP の変換ポートの範囲が使用されます。 *nx_nat.h* で定義されている次のユーザー構成可能なオプションにより、各プロトコルの範囲が定義されます。

```C
NX_NAT_START_TCP_PORT

NX_NAT_END_TCP_PORT

NX_NAT_START_UDP_PORT

NX_NAT_END_UDP_PORT

NX_NAT_START_ICMP_QUERY_ID

NX_NAT_END_ICMP_QUERY_ID
```

## <a name="nat-requirements-and-constraints"></a>NAT の要件と制約

NetX Duo NAT には、NetX Duo 5.8 以降が必要です。 単一の IP インスタンスと、内部および外部の物理ネットワークへのインターフェイスを、NAT アプリケーションで作成する必要があります。

制約:

- NetX Duo NAT では、TCP、UDP、ICMP がサポートされています。 IGMP はサポートされていません。
- NetX Duo NAT は、IPv6 のアドレス指定に対応していません。
- NetX Duo NAT には DNS または DHCP サービスは含まれませんが、NetX Duo NAT は NAT 操作でこれらのサービスと統合できます。

## <a name="rfcs-supported-by-netx-duo-nat"></a>NetX Duo NAT によってサポートされている RFC

NetX Duo NAT の実装は、次の RFC に記載されている情報に基づいています。

- RFC 2663: IP ネットワーク アドレス トランスレーター (NAT) の用語と考慮事項
- RFC 3022: 従来の IP ネットワーク アドレス トランスレーター (従来の NAT)
- RFC 4787: ユニキャスト UDP に関するネットワークアドレス変換 (NAT) の動作の要件
