---
title: 第 1 章 - Azure RTOS NetX Duo SNTP の概要
description: Azure RTOS NetX Simple Network Time Protocol (SNTP) は、インターネット経由でクロックを同期するように設計されたプロトコルです。
author: philmea
ms.author: philmea
ms.date: 06/04/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: b3e1170197c6c4981060459104da80e354fac5db
ms.sourcegitcommit: e3d42e1f2920ec9cb002634b542bc20754f9544e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/22/2021
ms.locfileid: "104810568"
---
# <a name="chapter-1---introduction-to-azure-rtos-netx-duo-sntp"></a><span data-ttu-id="5ea06-103">第 1 章 - Azure RTOS NetX Duo SNTP の概要</span><span class="sxs-lookup"><span data-stu-id="5ea06-103">Chapter 1 - Introduction to Azure RTOS NetX Duo SNTP</span></span> 

<span data-ttu-id="5ea06-104">Azure RTOS NetX Simple Network Time Protocol (SNTP) は、インターネット経由でクロックを同期するように設計されたプロトコルです。</span><span class="sxs-lookup"><span data-stu-id="5ea06-104">The Azure RTOS NetX Simple Network Time Protocol (SNTP) is a protocol designed for synchronizing clocks over the Internet.</span></span> <span data-ttu-id="5ea06-105">SNTP バージョン 4 は、ネットワーク タイム プロトコル (NTP) に基づいて簡略化されたプロトコルです。</span><span class="sxs-lookup"><span data-stu-id="5ea06-105">SNTP Version 4 is a simplified protocol based on the Network Time Protocol (NTP).</span></span> <span data-ttu-id="5ea06-106">ユーザー データグラム プロトコル (UDP) サービスを利用して、シンプルでステートレスなプロトコルで時刻の更新を実行します。</span><span class="sxs-lookup"><span data-stu-id="5ea06-106">It utilizes User Datagram Protocol (UDP) services to perform time updates in a simple, stateless protocol.</span></span> <span data-ttu-id="5ea06-107">NTP ほど複雑ではありませんが、SNTP は信頼性と正確性に優れています。</span><span class="sxs-lookup"><span data-stu-id="5ea06-107">Though not as complex as NTP, SNTP is highly reliable and accurate.</span></span> <span data-ttu-id="5ea06-108">現在のインターネットのほとんどの場所で、SNTP では、同期ソースとネットワーク パスの特性に応じて 1 ～ 50 ミリ秒の精度が実現されています。</span><span class="sxs-lookup"><span data-stu-id="5ea06-108">In most places of the Internet of today, SNTP provides accuracies of 1-50 milliseconds, depending on the characteristics of the synchronization source and network paths.</span></span> <span data-ttu-id="5ea06-109">SNTP には、時刻更新の受信に信頼性をもたらす多くのオプションが用意されています。</span><span class="sxs-lookup"><span data-stu-id="5ea06-109">SNTP has many options to provide reliability of receiving time updates.</span></span> <span data-ttu-id="5ea06-110">別のサーバーへの切り替え、バックオフ ポーリング アルゴリズムの適用、および自動タイム サーバー検出は、変わりやすいインターネット時刻サービス環境を SNTP クライアントが処理するための手段のほんの一部にすぎません。</span><span class="sxs-lookup"><span data-stu-id="5ea06-110">Ability to switch to alternative servers, applying back off polling algorithms and automatic time server discovery are just a few of the means for an SNTP client to handle a variable Internet time service environment.</span></span> <span data-ttu-id="5ea06-111">シンプルさと簡単な実装で、精度に欠ける点を補います。</span><span class="sxs-lookup"><span data-stu-id="5ea06-111">What it lacks in precision it makes up for in simplicity and ease of implementation.</span></span> <span data-ttu-id="5ea06-112">SNTP は、国の時刻および周波数伝達 (NTP サーバーなど) サービスにアクセスするための包括的なメカニズムを提供することを主な目的としています。</span><span class="sxs-lookup"><span data-stu-id="5ea06-112">SNTP is intended primarily for providing comprehensive mechanisms to access national time and frequency dissemination (e.g. NTP server) services.</span></span>

## <a name="netx-duo-sntp-client-requirements"></a><span data-ttu-id="5ea06-113">NetX Duo SNTP クライアントの要件</span><span class="sxs-lookup"><span data-stu-id="5ea06-113">NetX Duo SNTP Client Requirements</span></span>

<span data-ttu-id="5ea06-114">NetX Duo SNTP クライアントでは、IP インスタンスが既に作成されている必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ea06-114">The NetX Duo SNTP Client requires that an IP instance has already been created.</span></span> <span data-ttu-id="5ea06-115">さらに、同じ IP インスタンスで UDP が有効になっている必要があります。また、SNTP サーバーに時刻データを送信するための "*既知の*" ポート 123 にアクセスできるようにする必要がありますが、代替ポートも同様に機能します。</span><span class="sxs-lookup"><span data-stu-id="5ea06-115">In addition, UDP must be enabled on that same IP instance and should have access to the *well-known* port 123 for sending time data to an SNTP Server, although alternative ports will work as well.</span></span> <span data-ttu-id="5ea06-116">ブロードキャスト クライアントは、ブロードキャスト サーバーが送信している UDP ポート (通常は 123) をバインドする必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ea06-116">Broadcast clients should bind the UDP port their broadcast server is sending on, usually 123.</span></span> <span data-ttu-id="5ea06-117">NetX Duo SNTP クライアント アプリケーションには、1 つまたは複数の IP SNTP サーバー アドレスが必要です。</span><span class="sxs-lookup"><span data-stu-id="5ea06-117">The NetX Duo SNTP Client application must have one or more IP SNTP Server addresses.</span></span>

## <a name="netx-duo-sntp-client-limitations"></a><span data-ttu-id="5ea06-118">NetX Duo SNTP クライアントの制限事項</span><span class="sxs-lookup"><span data-stu-id="5ea06-118">NetX Duo SNTP Client Limitations</span></span> 

<span data-ttu-id="5ea06-119">SNTP クライアント API によって処理される NTP 時刻の更新におけるローカル時刻表現の精度は、ミリ秒の分解能に制限されています。</span><span class="sxs-lookup"><span data-stu-id="5ea06-119">Precision in local time representation in NTP time updates handled by the SNTP Client API is limited to millisecond resolution.</span></span>

<span data-ttu-id="5ea06-120">SNTP クライアントは、常に 1 つの SNTP サーバー アドレスのみを保持します。</span><span class="sxs-lookup"><span data-stu-id="5ea06-120">The SNTP Client only holds a single SNTP Server address at any time.</span></span> <span data-ttu-id="5ea06-121">サーバーが有効ではなくなったと思われる場合、アプリケーションでは、SNTP クライアント タスクを停止し、ブロードキャストまたはユニキャストのいずれかの SNTP 通信を使用して、別の SNTP サーバー アドレスで再初期化する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ea06-121">If that Server appears to be no longer valid, the application must stop the SNTP Client task, and reinitialize it with another SNTP server address, using either broadcast or unicast SNTP communication.</span></span>

<span data-ttu-id="5ea06-122">SNTP クライアントでは、メニーキャストはサポートされていません。</span><span class="sxs-lookup"><span data-stu-id="5ea06-122">The SNTP Client does not support manycast.</span></span>

<span data-ttu-id="5ea06-123">NetX Duo SNTP クライアントでは、受信したパケット データを検証するための認証メカニズムはサポートされません。</span><span class="sxs-lookup"><span data-stu-id="5ea06-123">NetX Duo SNTP Client does not support authentication mechanisms for verifying received packet data.</span></span>

## <a name="netx-duo-sntp-client-operation"></a><span data-ttu-id="5ea06-124">NetX Duo SNTP クライアント操作</span><span class="sxs-lookup"><span data-stu-id="5ea06-124">NetX Duo SNTP Client Operation</span></span>

<span data-ttu-id="5ea06-125">RFC 4330 では、SNTP クライアントがローカル ネットワークの最上位の stratum でのみ動作し、NTP または SNTP クライアントが同期のためにそれらのクライアントに依存していない構成にすることを推奨しています。</span><span class="sxs-lookup"><span data-stu-id="5ea06-125">RFC 4330 recommends that SNTP clients should operate only at the highest stratum of their local network and preferably in configurations where no NTP or SNTP client is dependent them for synchronization.</span></span> <span data-ttu-id="5ea06-126">stratum レベルには、NTP 時刻階層のホスト位置が反映されます。これは、stratum 1 が最上位 (ルート タイム サーバー) で、15 が許容される最下位レベル (クライアントなど) です。</span><span class="sxs-lookup"><span data-stu-id="5ea06-126">Stratum level reflects the host position in the NTP time hierarchy where stratum 1 is the highest level (a root time server) and 15 is the lowest allowed level (e.g. Client).</span></span> <span data-ttu-id="5ea06-127">SNTP クライアントの既定の最小 stratum は 2 です。</span><span class="sxs-lookup"><span data-stu-id="5ea06-127">The SNTP Client default minimum stratum is 2.</span></span>

<span data-ttu-id="5ea06-128">NetX Duo SNTP クライアントは、ユニキャストまたはブロードキャストの 2 つの基本モードのいずれかで動作し、インターネット経由で時刻を取得できます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-128">The NetX Duo SNTP Client can operate in one of two basic modes, unicast or broadcast, to obtain time over the Internet.</span></span> <span data-ttu-id="5ea06-129">ユニキャスト モードでは、クライアントは自身の SNTP サーバーを定期的にポーリングし、そのサーバーからの応答を受信するまで待機します。</span><span class="sxs-lookup"><span data-stu-id="5ea06-129">In unicast mode, the Client polls its SNTP Server on regular intervals and waits to receive a reply from that Server.</span></span> <span data-ttu-id="5ea06-130">受信したら、クライアントでは、RFC 4330 で推奨されている一連の "正常性チェック" を適用することによって、応答に有効な時刻の更新が含まれているかどうかが確認されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-130">When one is received, the Client verifies that the reply contains a valid time update by applying a set of ‘sanity checks’ recommended by RFC 4330.</span></span> <span data-ttu-id="5ea06-131">クライアントでは、サーバーのクロックとの時刻の差 (ある場合) が、自身のローカル クロックに適用されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-131">The Client then applies the time difference, if any, with the Server clock to its local clock.</span></span> <span data-ttu-id="5ea06-132">ブロードキャスト モードでは、クライアントは、更新時刻データを確認するために類似する一連の正常性チェックを適用した後、時刻更新ブロードキャストをリッスンし、ローカル クロックを維持するだけです。</span><span class="sxs-lookup"><span data-stu-id="5ea06-132">In broadcast mode, the Client merely listens for time update broadcasts and maintains its local clock after applying a similar set of sanity checks to verify the update time data.</span></span> <span data-ttu-id="5ea06-133">整合性チェックの詳細については、以下の「**SNTP の正常性チェック**」セクションを参照してください。</span><span class="sxs-lookup"><span data-stu-id="5ea06-133">Sanity checks are described in detail in the **SNTP Sanity Checks** section below.</span></span>

<span data-ttu-id="5ea06-134">クライアントをいずれかのモードで実行するには、その動作のパラメーターを設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ea06-134">Before the Client can run in either mode, it must establish its operating parameters.</span></span> <span data-ttu-id="5ea06-135">これは、ユニキャスト モードまたはブロードキャスト モードで、*nx_sntp_client_initialize_unicast* または *nx_sntp_client_initialize_broadcast* のいずれかを呼び出すことによって行われます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-135">This is done by calling either *nx_sntp_client_initialize_unicast* or *nx_sntp_client_initialize_broadcast* for unicast or broadcast modes, respectively.</span></span> <span data-ttu-id="5ea06-136">これらでは、有効な更新のない最大時間の経過に対するタイムアウト、受信した連続する無効な更新数の制限、ユニキャスト モードのポーリング間隔、オペレーション モード (ユニキャストとブロードキャストなど)、および SNTP サーバーが設定されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-136">These serves set the time outs for maximum time lapse without a valid update, the limit on consecutive invalid updates received, a polling interval for unicast mode, operation mode e.g. unicast vs. broadcast, and SNTP Server.</span></span>

<span data-ttu-id="5ea06-137">最大時間の経過または受信した無効な更新の最大数を超えた場合、SNTP クライアントは引き続き実行されますが、現在の SNTP サーバーの状態は無効に設定されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-137">If the maximum time lapse or maximum invalid updates received is exceeded, the SNTP Client continues to run but sets the current SNTP Server status to invalid.</span></span> <span data-ttu-id="5ea06-138">アプリケーションでは、*nx_sntp_client_receiving_updates* サービスを使用して SNTP クライアントをポーリングして、SNTP サーバーがまだ有効な更新を送信していることが確認されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-138">The application can poll the SNTP Client using the *nx_sntp_client_receiving_updates* service to verify the SNTP Server is still sending valid updates.</span></span> <span data-ttu-id="5ea06-139">これが行われていない場合は、*nx_sntp_client_stop* サービスを使用して SNTP クライアント スレッドを停止し、2 つの初期化サービスのいずれかを呼び出して、別の SNTP サーバー アドレスが設定されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-139">If not, it should stop the SNTP Client thread using the *nx_sntp_client_stop* service and call either of the two initialize services to set another SNTP Server address.</span></span> <span data-ttu-id="5ea06-140">SNTP クライアントを再起動するには、*nx_sntp_client_run_broadcast* または *nx_sntp_client_run_unicast* がアプリケーションで呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-140">To restart the SNTP Client, the application calls *nx_sntp_client_run_broadcast* or *nx_sntp_client_run_unicast*.</span></span> <span data-ttu-id="5ea06-141">アプリケーションでは、初期化呼び出しで SNTP クライアントの動作モードを変更して、必要に応じてユニキャストまたはブロードキャストに切り替えることができることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="5ea06-141">Note that the application can change SNTP Client operating mode in the initialize call to switch to unicast or broadcast as desired.</span></span>

### <a name="local-clock-operation"></a><span data-ttu-id="5ea06-142">ローカル クロックの動作</span><span class="sxs-lookup"><span data-stu-id="5ea06-142">Local Clock Operation</span></span>

<span data-ttu-id="5ea06-143">SNTP の時刻は、マスター NTP クロックの秒数、つまり、1 月 1 日 **1900 00:00:00 から** 1 月 1 日 **1999 00:00:00** までなどの、最初の NTP エポックの経過秒数に基づいています。</span><span class="sxs-lookup"><span data-stu-id="5ea06-143">The SNTP time based on the number of seconds on the master NTP clock, or number of seconds elapsed in the first NTP epoch e.g. from Jan 1 **1900 00:00:00 to** Jan 1 **1999 00:00:00**.</span></span> <span data-ttu-id="5ea06-144">01-01-1999 の有意性は、これが最後のうるう秒が発生したときだったことです。</span><span class="sxs-lookup"><span data-stu-id="5ea06-144">The significance of 01-01-1999 was when the last leap second occurred.</span></span> <span data-ttu-id="5ea06-145">この値は、次のように定義されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-145">This value is defined as follows:</span></span>

<span data-ttu-id="5ea06-146">\#define NTP_SECONDS_AT_01011999 0xBA368E80</span><span class="sxs-lookup"><span data-stu-id="5ea06-146">\#define NTP_SECONDS_AT_01011999 0xBA368E80</span></span>

<span data-ttu-id="5ea06-147">SNTP クライアントを実行する前に、アプリケーションでは必要に応じて、クライアントが基準時刻として使用するために、SNTP クライアントのローカル時刻を初期化することができます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-147">Before the SNTP Client runs, the application can optionally initialize the SNTP Client local time for the Client to use as a baseline time.</span></span> <span data-ttu-id="5ea06-148">これを行うには、*nx_sntp_client_set_local_time* サービスを使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ea06-148">To do so, it must use the *nx_sntp_client_set_local_time* service.</span></span> <span data-ttu-id="5ea06-149">これには、NTP 形式の時刻 (秒と小数部) を指定します。ここで、小数部は、NTP の短縮された時刻におけるミリ秒です。</span><span class="sxs-lookup"><span data-stu-id="5ea06-149">This takes the time in NTP format, seconds and fraction, where fraction is the milliseconds in the NTP condensed time.</span></span> <span data-ttu-id="5ea06-150">アプリケーションは、独立したソースから SNTP 時刻を取得できるのが理想的です。</span><span class="sxs-lookup"><span data-stu-id="5ea06-150">Ideally the application can obtain an SNTP time from an independent source.</span></span> <span data-ttu-id="5ea06-151">NetX Duo SNTP クライアントには、年、月、日付、時刻を NTP 時刻に変換するための API はありません。</span><span class="sxs-lookup"><span data-stu-id="5ea06-151">There is no API for converting year, month, date and time to an NTP time in the NetX Duo SNTP Client.</span></span> <span data-ttu-id="5ea06-152">NTP 時刻形式の詳細については、*RFC4330 の IPv4、IPv6 および OSI 向けの Simple Network Time Protocol (SNTP) バージョン 4* の説明を参照してください。</span><span class="sxs-lookup"><span data-stu-id="5ea06-152">For a description of NTP time format, refer to *RFC4330 “Simple Network Time Protocol (SNTP) Version 4 for IPv4, IPv6 and OSI”.*</span></span>

<span data-ttu-id="5ea06-153">SNTP クライアントの起動時に基となるローカル時刻が指定されていない場合、SNTP クライアントでは、最初の更新時にローカル時刻と比較せずに、SNTP 更新を受け入れます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-153">If no base local time is supplied when the SNTP Client starts up, the SNTP Client will accept the SNTP updates without comparing to its local time on the first update.</span></span> <span data-ttu-id="5ea06-154">その後、最大と最小の時刻更新値を適用して、ローカル時刻を変更するかどうかが決定されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-154">Thereafter it will apply the maximum and minimum time update values to determine if it will modify its local time.</span></span>

<span data-ttu-id="5ea06-155">SNTP クライアントのローカル時刻を取得するには、アプリケーションで *nx_sntp_client_get_local_time_extended* サービスが使用されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-155">To obtain the SNTP Client local time, the application can use the *nx_sntp_client_get_local_time_extended* service.</span></span>

### <a name="sntp-sanity-checks"></a><span data-ttu-id="5ea06-156">SNTP の整合性チェック</span><span class="sxs-lookup"><span data-stu-id="5ea06-156">SNTP Sanity Checks</span></span> 

<span data-ttu-id="5ea06-157">クライアントでは、次の条件で受信パケットが調査されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-157">The Client examines the incoming packet for the following criteria:</span></span>

  - <span data-ttu-id="5ea06-158">送信元 IP アドレスは、現在のサーバーの IP アドレスと一致する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ea06-158">Source IP address must match the current server IP address.</span></span>

  - <span data-ttu-id="5ea06-159">送信元ポートは、現在のサーバーの送信元ポートと一致している必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ea06-159">Sender source port must match with the current server source port.</span></span>

  - <span data-ttu-id="5ea06-160">パケット長は、SNTP 時刻メッセージを保持するための最小の長さである必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ea06-160">Packet length must be the minimum length to hold an SNTP time message.</span></span>

<span data-ttu-id="5ea06-161">次に、時刻データがパケット バッファーから抽出されて、クライアントによって特定の "正常性チェック" のセットが適用されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-161">Next, the time data is extracted from the packet buffer to which the Client then applies a set of specific ‘sanity checks’:</span></span>

  - <span data-ttu-id="5ea06-162">うるうインジケーターが 3 に設定されている場合は、サーバーが同期されていないことを示します。</span><span class="sxs-lookup"><span data-stu-id="5ea06-162">The Leap Indicator set to 3 indicates the Server is not synchronized.</span></span> <span data-ttu-id="5ea06-163">クライアントは、別のサーバーの検索を試行します。</span><span class="sxs-lookup"><span data-stu-id="5ea06-163">The Client should attempt to find an alternative server.</span></span>

  - <span data-ttu-id="5ea06-164">0 に設定された stratum フィールドは、Kiss of Death (KOD) パケットと呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-164">A stratum field set to zero is known as a Kiss of Death (KOD) packet.</span></span> <span data-ttu-id="5ea06-165">この状況の SMTP クライアント KOD ハンドラーは、ユーザー定義のコールバックです。</span><span class="sxs-lookup"><span data-stu-id="5ea06-165">The SMTP Client KOD handler for this situation is a user defined callback.</span></span> <span data-ttu-id="5ea06-166">小規模なサンプル デモ ファイルには、この状況に対する単純な KOD ハンドラーが含まれています。</span><span class="sxs-lookup"><span data-stu-id="5ea06-166">The small example demo file contains a simple KOD handler for this situation.</span></span> <span data-ttu-id="5ea06-167">必要に応じて、参照 ID フィールドに KOD 応答の理由を示すコードが含まれています。</span><span class="sxs-lookup"><span data-stu-id="5ea06-167">The Reference ID field optionally contains a code indicating the reason for the KOD reply.</span></span> <span data-ttu-id="5ea06-168">どのような場合でも、KOD ハンドラーは SNTP サーバーからの Kiss of Death 受信を処理する方法を示す必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ea06-168">At any rate, the KOD handler must indicate how to handle receiving a kiss of death from the SNTP Server.</span></span> <span data-ttu-id="5ea06-169">通常は、別の SNTP サーバーを使用して SNTP クライアントを再初期化します。</span><span class="sxs-lookup"><span data-stu-id="5ea06-169">Typically it will want to reinitialize the SNTP Client with another SNTP Server.</span></span>

  - <span data-ttu-id="5ea06-170">サーバーの SNTP バージョン、stratum、および操作モードがクライアント サービスと一致している必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ea06-170">The Server SNTP version, stratum and mode of operation must be matched to the Client service.</span></span>

  - <span data-ttu-id="5ea06-171">クライアントがサーバー クロックの分散最大値を使用して構成されている場合、クライアントは、最初に受信した更新のサーバー クロックの分散のみを確認し、クライアントの最大数を超えると、クライアントはサーバーを拒否します。</span><span class="sxs-lookup"><span data-stu-id="5ea06-171">If the Client is configured with a server clock dispersion maximum, the Client checks the server clock dispersion on the first update received only, and if it exceeds the Client maximum, the Client rejects the Server.</span></span>

  - <span data-ttu-id="5ea06-172">サーバーのタイム スタンプ フィールドも、特定のチェックに合格する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ea06-172">The Server time stamp fields must also pass specific checks.</span></span> <span data-ttu-id="5ea06-173">ユニキャスト サーバーでは、すべての時間フィールドに値を入力する必要があり、NULL にすることはできません。</span><span class="sxs-lookup"><span data-stu-id="5ea06-173">For the unicast Server, all time fields must be filled in and cannot be NULL.</span></span> <span data-ttu-id="5ea06-174">発信元のタイム スタンプは、クライアントの SNTP 時間メッセージ要求の送信タイム スタンプと同じである必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ea06-174">The Origination time stamp must equal the Transmit time stamp in the Client’s SNTP time message request.</span></span> <span data-ttu-id="5ea06-175">これにより、悪意のある侵入者や偽のサーバー動作からクライアントが保護されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-175">This protects the Client from malicious intruders and rogue Server behavior.</span></span> <span data-ttu-id="5ea06-176">ブロードキャスト サーバーは、送信タイム スタンプの値のみが必要です。</span><span class="sxs-lookup"><span data-stu-id="5ea06-176">The broadcast Server need only fill in the Transmit time stamp.</span></span> <span data-ttu-id="5ea06-177">クライアントからは何も受信されないため、受信フィールドまたは送信元フィールドに値はありません。</span><span class="sxs-lookup"><span data-stu-id="5ea06-177">Since it does not receive anything from the Client it has no Receive or Origination fields to fill in.</span></span>

    <span data-ttu-id="5ea06-178">正常性チェックに失敗した場合、時刻の更新は無効な時刻の更新として認識されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-178">A failed sanity check brands a time update as an invalid time update.</span></span> <span data-ttu-id="5ea06-179">SNTP クライアントの正常性チェック サービスでは、同じサーバーから受信した連続した無効な時刻更新の数が追跡されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-179">The SNTP Client sanity check service tracks the number of consecutive invalid time updates received from the same Server.</span></span>

<span data-ttu-id="5ea06-180">SNTP クライアントのスレッド タスクでローカルの SNTP クライアント時刻に適用するために、SNTP パケットの有効性がチェックされると、SNTP クライアントの `nx_sntp_client_invalid_time_updates.` の数が増分されます。これは、呼び出し元にもエラー状態を返しますが、これはすべて内部処理であるため、アプリケーションにすぐには表示されません。</span><span class="sxs-lookup"><span data-stu-id="5ea06-180">When SNTP Client thread task checks the validity of an SNTP packet for applying to the local SNTP Client time, it increments the count of the SNTP Client `nx_sntp_client_invalid_time_updates.` It also returns an error status to the caller but this is all internal processing so it is not immediately visible to the application.</span></span> <span data-ttu-id="5ea06-181">失敗した時刻の更新を検出する方法は、SNTP サーバーの時刻更新を受信した後に、SNTP クライアント `nx_sntp_client_invalid_time_updates` の値に対してクエリを実行することです。</span><span class="sxs-lookup"><span data-stu-id="5ea06-181">The way to detect failed time updates is to query the value of the SNTP Client `nx_sntp_client_invalid_time_updates` after receiving SNTP Server time updates.</span></span>

<span data-ttu-id="5ea06-182">サーバー時刻の更新が正常性チェックに合格すると、クライアントは時刻データをローカル時刻に処理しようとします。</span><span class="sxs-lookup"><span data-stu-id="5ea06-182">If the Server time update passes the sanity checks, the Client then attempts to process the time data to its local time.</span></span> <span data-ttu-id="5ea06-183">クライアントがラウンド トリップ計算を行うように構成されている場合は (たとえば、更新要求を送信した時刻から受信した時刻まで)、ラウンド トリップ時間が計算されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-183">If the Client is configured for round trip calculation, e.g. the time from sending an update request to the time one is received, the round trip time is calculated.</span></span> <span data-ttu-id="5ea06-184">この値は半分にされてサーバーの時刻に追加されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-184">This value is halved and then added to the Server’s time.</span></span>

<span data-ttu-id="5ea06-185">次に、現在の SNTP サーバーから受信した最初の更新の場合、SNTP クライアントでは、サーバーとクライアントのローカル時刻の違いを無視するかどうかが決定されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-185">Next, if this is the first update received from the current SNTP Server, the SNTP Client determines if it should ignore the difference between the Server and Client local time.</span></span> <span data-ttu-id="5ea06-186">その後、SNTP サーバーからのすべての更新は、クライアントのローカル時刻との差に対して評価されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-186">Thereafter all updates from the SNTP Server are evaluated for the difference with the Client local time.</span></span>

<span data-ttu-id="5ea06-187">クライアントとサーバーの時刻の違いは、`NX_SNTP_CLIENT_MAX_TIME_ADJUSTMENT` を使用して比較されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-187">The difference between Client and Server time is compared with `NX_SNTP_CLIENT_MAX_TIME_ADJUSTMENT`.</span></span> <span data-ttu-id="5ea06-188">この値を超えると、データがスローされます。差が `NX_SNTP_CLIENT_MIN_TIME_ADJUSTMENT` 未満の場合は、調整を必要とするには差が小さすぎると見なされます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-188">If it exceeds this value, the data is thrown out. If the difference is less than the `NX_SNTP_CLIENT_MIN_TIME_ADJUSTMENT` the difference is considered too small to require adjustment.</span></span>

<span data-ttu-id="5ea06-189">これらすべてのチェックに合格すると、内部の SNTP クライアント処理でいくつかの遅延が修正されて、時刻の更新が SNTP クライアントに適用されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-189">Passing all these checks, the time update is then applied to the SNTP Client with some corrections for delays in internal SNTP Client processing.</span></span>

### <a name="sntp-asynchronous-unicast-requests"></a><span data-ttu-id="5ea06-190">SNTP 非同期ユニキャスト要求</span><span class="sxs-lookup"><span data-stu-id="5ea06-190">SNTP Asynchronous Unicast Requests</span></span> 

<span data-ttu-id="5ea06-191">SNTP クライアントを使用すると、ホスト アプリケーションでは、NTP サーバーから現在の時刻のユニキャスト要求を非同期的に送信できます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-191">The SNTP Client allows the host application to asynchronously send a unicast request for the current time from the NTP server.</span></span>

```C
UINT _nx_sntp_client_request_unicast_time(
NX_SNTP_CLIENT *client_ptr, 
UINT wait_option)
```

<span data-ttu-id="5ea06-192">待機オプションは、応答を待機する有効期限です。</span><span class="sxs-lookup"><span data-stu-id="5ea06-192">The wait option is the expiration to wait for a response.</span></span>

<span data-ttu-id="5ea06-193">NTP サーバーが応答した場合、パケットでは、前のセクションの説明と同じ処理と正常性チェックが実施されてから、SNTP クライアントのローカル時刻が更新されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-193">If the NTP Server responds, the packet is subjected to the same processing and sanity checks as described in the previous section before updating the SNTP Client local time.</span></span>

<span data-ttu-id="5ea06-194">呼び出しが正常に完了して返された場合、アプリケーションでは、更新されたローカル時刻に対して *nx_sntp_client_utility_display_date_time* または *nx_sntp_client_get_local_time_extended* を呼び出すことができます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-194">If the call returns successful completion, the application can call *nx_sntp_client_utility_display_date_time* or *nx_sntp_client_get_local_time_extended* for the updated local time.</span></span>

<span data-ttu-id="5ea06-195">これらのユニキャスト要求は、次のユニキャスト要求を送信するための通常の SNTP クライアント スケジュールに干渉したり、ブロードキャスト モードの場合に、次の NTP ブロードキャストが予測されるタイミングに影響したりすることはありません。</span><span class="sxs-lookup"><span data-stu-id="5ea06-195">These unicast requests do not interfere with the normal SNTP Client schedule for sending the next unicast request, or if in broadcast mode, when to expect the next NTP broadcast.</span></span>

### <a name="periodic-local-time-updates"></a><span data-ttu-id="5ea06-196">ローカル時刻の定期的な更新</span><span class="sxs-lookup"><span data-stu-id="5ea06-196">Periodic Local Time Updates</span></span>

<span data-ttu-id="5ea06-197">ローカル時刻に対する最大の調整は、NX_SNTP_CLIENT_MAX_TIME_ADJUSTMENT オプションで設定します (ミリ秒単位)。</span><span class="sxs-lookup"><span data-stu-id="5ea06-197">The maximum adjustment to the local time is set in the NX_SNTP_CLIENT_MAX_TIME_ADJUSTMENT option (in milliseconds).</span></span> <span data-ttu-id="5ea06-198">ユニキャストの SNTP クライアント操作の更新ポーリング間隔は、NX_SNTP_CLIENT_UNICAST_POLL_INTERVAL オプションで設定します (秒単位)。</span><span class="sxs-lookup"><span data-stu-id="5ea06-198">The polling update interval for unicast SNTP Client operations is set in the NX_SNTP_CLIENT_UNICAST_POLL_INTERVAL option (in seconds).</span></span> <span data-ttu-id="5ea06-199">ポーリング間隔が最大の調整よりも大きい場合、最初のサーバー更新後に発生するそれ以降のサーバー更新は拒否されます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-199">If the polling interval is greater than the maximum adjustment, then subsequent server updates after the first server update will be rejected.</span></span> <span data-ttu-id="5ea06-200">これを防ぐために、SNTP クライアントでは、NX_SNTP_UPDATE_TIMEOUT_INTERVAL として定義されるように、ローカル時刻を定期的に更新します。</span><span class="sxs-lookup"><span data-stu-id="5ea06-200">To prevent this, the SNTP Client will update the local time periodically defined as NX_SNTP_UPDATE_TIMEOUT_INTERVAL.</span></span> 

<span data-ttu-id="5ea06-201">オンボード RTC と (SNTP クライアントのローカル時刻を設定するはずの) サーバー時刻の間に時刻の差がある場合は、RTC が SNTP クライアント時刻に同期されるようにする必要があります (これについては、このユーザー ガイドでは説明しません)。</span><span class="sxs-lookup"><span data-stu-id="5ea06-201">If there is a difference in time between the on board RTC and the server time (which the SNTP Client local time should be set to), the RTC should be synched to the SNTP Client time (we do not demonstrate that in this User Guide).</span></span>

<span data-ttu-id="5ea06-202">SNTP サーバーの更新は 1 時間に 1 回より多く実行しないようにする必要があるため、SNTP クライアントでそれよりも頻繁にサーバーの更新やサーバーの状態をポーリングすることは役立ちません。</span><span class="sxs-lookup"><span data-stu-id="5ea06-202">Since SNTP server updates should not occur more often than once per hour, it is not useful to poll the SNTP Client for server updates or server status more often than that.</span></span> <span data-ttu-id="5ea06-203">ただし、SNTP クライアントでは、最大時刻調整パラメーター NX_SNTP_CLIENT_MAX_TIME_LAPSE よりも大幅に長くならないようにするために十分な頻度でローカル クロックを更新する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5ea06-203">However, the SNTP Client should update its local clock often enough not to fall further than the maximum time adjustment parameter NX_SNTP_CLIENT_MAX_TIME_LAPSE.</span></span>

<span data-ttu-id="5ea06-204">または、最大調整 NX_SNTP_CLIENT_MAX_TIME_LAPSE を、ユニキャスト ポーリング更新 (または、予想されるブロードキャスト間隔) よりも大きい値に設定できます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-204">Alternatively, the maximum adjustment NX_SNTP_CLIENT_MAX_TIME_LAPSE can be set to greater than the unicast polling update (or anticipated broadcast intervals).</span></span> <span data-ttu-id="5ea06-205">後者の方法では、独立したリアル タイム クロックが不要になります。</span><span class="sxs-lookup"><span data-stu-id="5ea06-205">The latter eliminates the need for an independent real time clock.</span></span> <span data-ttu-id="5ea06-206">ただし、SNTP プロトコルの目的は、ローカル RTC またはネットワーク時刻の更新のいずれかに完全に頼ることを回避することです。</span><span class="sxs-lookup"><span data-stu-id="5ea06-206">However, the intention of SNTP protocol is to avoid total reliance on either local RTC or network time updates.</span></span> <span data-ttu-id="5ea06-207">さらに、SNTP サーバーの更新は、ローカル時刻のクロックのずれを防ぐことを目的としています。</span><span class="sxs-lookup"><span data-stu-id="5ea06-207">Further, the SNTP Server updates are intended to prevent drift in the local time clock.</span></span>

## <a name="multiple-network-interfaces"></a><span data-ttu-id="5ea06-208">複数のネットワーク インターフェイス</span><span class="sxs-lookup"><span data-stu-id="5ea06-208">Multiple Network Interfaces</span></span>

<span data-ttu-id="5ea06-209">NetX Duo SNTP クライアントは、IP インスタンスに登録されているセカンダリ ネットワークで実行されるように構成できます。</span><span class="sxs-lookup"><span data-stu-id="5ea06-209">NetX Duo SNTP Client can be configured to run on secondary networks as long as those networks are registered with the IP instance.</span></span> <span data-ttu-id="5ea06-210">セカンダリ ネットワークを登録する方法の詳細については、NetX Duo または NetX のユーザー ガイドを参照してください。</span><span class="sxs-lookup"><span data-stu-id="5ea06-210">See the NetX Duo or NetX User Guide for more information on how to register secondary networks.</span></span>

<span data-ttu-id="5ea06-211">*nx_sntp_client_create* の呼び出しで、3 番目の入力 (iface_index) を、時刻の更新を受信する SNTP クライアントのネットワークのインデックスに設定します。</span><span class="sxs-lookup"><span data-stu-id="5ea06-211">In the *nx_sntp_client_create* call, set the third input, iface_index, to the index of the network for the SNTP Client to receive time updates on.</span></span> <span data-ttu-id="5ea06-212">プライマリ インターフェイスは、常にインデックス 0 になります。</span><span class="sxs-lookup"><span data-stu-id="5ea06-212">The primary interface is always at index 0.</span></span> <span data-ttu-id="5ea06-213">NetX Duo SNTP クライアントでは、複数のネットワーク インターフェイスでの同時の時刻更新をサポートすることはできません。</span><span class="sxs-lookup"><span data-stu-id="5ea06-213">NetX Duo SNTP Client cannot support time updates simultaneously on multiple network interface.</span></span>

## <a name="sntp-and-ntp-rfcs"></a><span data-ttu-id="5ea06-214">SNTP および NTP RFC</span><span class="sxs-lookup"><span data-stu-id="5ea06-214">SNTP and NTP RFCs</span></span>

<span data-ttu-id="5ea06-215">NetX Duo SNTP クライアントでは、RFC4330 の IPv4、IPv6 および OSI 向けの Simple Network Time Protocol (SNTP) バージョン 4 と関連する RFC に準拠しています。</span><span class="sxs-lookup"><span data-stu-id="5ea06-215">NetX Duo SNTP client is compliant with RFC4330 “Simple Network Time Protocol (SNTP) Version 4 for IPv4, IPv6 and OSI” and related RFCs.</span></span>