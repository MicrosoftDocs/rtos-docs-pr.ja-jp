---
title: 第 1 章 - Azure RTOS NetX Duo SNTP の概要
description: Azure RTOS NetX Simple Network Time Protocol (SNTP) は、インターネット経由でクロックを同期するように設計されたプロトコルです。
author: philmea
ms.author: philmea
ms.date: 06/04/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: a284871d8da9b8d6d220e962de5d27483dafab201b68d64d5c794c1edab50153
ms.sourcegitcommit: 93d716cf7e3d735b18246d659ec9ec7f82c336de
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/07/2021
ms.locfileid: "116798828"
---
# <a name="chapter-1---introduction-to-azure-rtos-netx-duo-sntp"></a>第 1 章 - Azure RTOS NetX Duo SNTP の概要 

Azure RTOS NetX Simple Network Time Protocol (SNTP) は、インターネット経由でクロックを同期するように設計されたプロトコルです。 SNTP バージョン 4 は、ネットワーク タイム プロトコル (NTP) に基づいて簡略化されたプロトコルです。 ユーザー データグラム プロトコル (UDP) サービスを利用して、シンプルでステートレスなプロトコルで時刻の更新を実行します。 NTP ほど複雑ではありませんが、SNTP は信頼性と正確性に優れています。 現在のインターネットのほとんどの場所で、SNTP では、同期ソースとネットワーク パスの特性に応じて 1 ～ 50 ミリ秒の精度が実現されています。 SNTP には、時刻更新の受信に信頼性をもたらす多くのオプションが用意されています。 別のサーバーへの切り替え、バックオフ ポーリング アルゴリズムの適用、および自動タイム サーバー検出は、変わりやすいインターネット時刻サービス環境を SNTP クライアントが処理するための手段のほんの一部にすぎません。 シンプルさと簡単な実装で、精度に欠ける点を補います。 SNTP は、国の時刻および周波数伝達 (NTP サーバーなど) サービスにアクセスするための包括的なメカニズムを提供することを主な目的としています。

## <a name="netx-duo-sntp-client-requirements"></a>NetX Duo SNTP クライアントの要件

NetX Duo SNTP クライアントでは、IP インスタンスが既に作成されている必要があります。 さらに、同じ IP インスタンスで UDP が有効になっている必要があります。また、SNTP サーバーに時刻データを送信するための "*既知の*" ポート 123 にアクセスできるようにする必要がありますが、代替ポートも同様に機能します。 ブロードキャスト クライアントは、ブロードキャスト サーバーが送信している UDP ポート (通常は 123) をバインドする必要があります。 NetX Duo SNTP クライアント アプリケーションには、1 つまたは複数の IP SNTP サーバー アドレスが必要です。

## <a name="netx-duo-sntp-client-limitations"></a>NetX Duo SNTP クライアントの制限事項 

SNTP クライアント API によって処理される NTP 時刻の更新におけるローカル時刻表現の精度は、ミリ秒の分解能に制限されています。

SNTP クライアントは、常に 1 つの SNTP サーバー アドレスのみを保持します。 サーバーが有効ではなくなったと思われる場合、アプリケーションでは、SNTP クライアント タスクを停止し、ブロードキャストまたはユニキャストのいずれかの SNTP 通信を使用して、別の SNTP サーバー アドレスで再初期化する必要があります。

SNTP クライアントでは、メニーキャストはサポートされていません。

NetX Duo SNTP クライアントでは、受信したパケット データを検証するための認証メカニズムはサポートされません。

## <a name="netx-duo-sntp-client-operation"></a>NetX Duo SNTP クライアント操作

RFC 4330 では、SNTP クライアントがローカル ネットワークの最上位の stratum でのみ動作し、NTP または SNTP クライアントが同期のためにそれらのクライアントに依存していない構成にすることを推奨しています。 stratum レベルには、NTP 時刻階層のホスト位置が反映されます。これは、stratum 1 が最上位 (ルート タイム サーバー) で、15 が許容される最下位レベル (クライアントなど) です。 SNTP クライアントの既定の最小 stratum は 2 です。

NetX Duo SNTP クライアントは、ユニキャストまたはブロードキャストの 2 つの基本モードのいずれかで動作し、インターネット経由で時刻を取得できます。 ユニキャスト モードでは、クライアントは自身の SNTP サーバーを定期的にポーリングし、そのサーバーからの応答を受信するまで待機します。 受信したら、クライアントでは、RFC 4330 で推奨されている一連の "正常性チェック" を適用することによって、応答に有効な時刻の更新が含まれているかどうかが確認されます。 クライアントでは、サーバーのクロックとの時刻の差 (ある場合) が、自身のローカル クロックに適用されます。 ブロードキャスト モードでは、クライアントは、更新時刻データを確認するために類似する一連の正常性チェックを適用した後、時刻更新ブロードキャストをリッスンし、ローカル クロックを維持するだけです。 整合性チェックの詳細については、以下の「**SNTP の正常性チェック**」セクションを参照してください。

クライアントをいずれかのモードで実行するには、その動作のパラメーターを設定する必要があります。 これは、ユニキャスト モードまたはブロードキャスト モードで、*nx_sntp_client_initialize_unicast* または *nx_sntp_client_initialize_broadcast* のいずれかを呼び出すことによって行われます。 これらでは、有効な更新のない最大時間の経過に対するタイムアウト、受信した連続する無効な更新数の制限、ユニキャスト モードのポーリング間隔、オペレーション モード (ユニキャストとブロードキャストなど)、および SNTP サーバーが設定されます。

最大時間の経過または受信した無効な更新の最大数を超えた場合、SNTP クライアントは引き続き実行されますが、現在の SNTP サーバーの状態は無効に設定されます。 アプリケーションでは、*nx_sntp_client_receiving_updates* サービスを使用して SNTP クライアントをポーリングして、SNTP サーバーがまだ有効な更新を送信していることが確認されます。 これが行われていない場合は、*nx_sntp_client_stop* サービスを使用して SNTP クライアント スレッドを停止し、2 つの初期化サービスのいずれかを呼び出して、別の SNTP サーバー アドレスが設定されます。 SNTP クライアントを再起動するには、*nx_sntp_client_run_broadcast* または *nx_sntp_client_run_unicast* がアプリケーションで呼び出されます。 アプリケーションでは、初期化呼び出しで SNTP クライアントの動作モードを変更して、必要に応じてユニキャストまたはブロードキャストに切り替えることができることに注意してください。

### <a name="local-clock-operation"></a>ローカル クロックの動作

SNTP の時刻は、マスター NTP クロックの秒数、つまり、1 月 1 日 **1900 00:00:00 から** 1 月 1 日 **1999 00:00:00** までなどの、最初の NTP エポックの経過秒数に基づいています。 01-01-1999 の有意性は、これが最後のうるう秒が発生したときだったことです。 この値は、次のように定義されます。

\#define NTP_SECONDS_AT_01011999 0xBA368E80

SNTP クライアントを実行する前に、アプリケーションでは必要に応じて、クライアントが基準時刻として使用するために、SNTP クライアントのローカル時刻を初期化することができます。 これを行うには、*nx_sntp_client_set_local_time* サービスを使用する必要があります。 これには、NTP 形式の時刻 (秒と小数部) を指定します。ここで、小数部は、NTP の短縮された時刻におけるミリ秒です。 アプリケーションは、独立したソースから SNTP 時刻を取得できるのが理想的です。 NetX Duo SNTP クライアントには、年、月、日付、時刻を NTP 時刻に変換するための API はありません。 NTP 時刻形式の詳細については、*RFC4330 の IPv4、IPv6 および OSI 向けの Simple Network Time Protocol (SNTP) バージョン 4* の説明を参照してください。

SNTP クライアントの起動時に基となるローカル時刻が指定されていない場合、SNTP クライアントでは、最初の更新時にローカル時刻と比較せずに、SNTP 更新を受け入れます。 その後、最大と最小の時刻更新値を適用して、ローカル時刻を変更するかどうかが決定されます。

SNTP クライアントのローカル時刻を取得するには、アプリケーションで *nx_sntp_client_get_local_time_extended* サービスが使用されます。

### <a name="sntp-sanity-checks"></a>SNTP の整合性チェック 

クライアントでは、次の条件で受信パケットが調査されます。

  - 送信元 IP アドレスは、現在のサーバーの IP アドレスと一致する必要があります。

  - 送信元ポートは、現在のサーバーの送信元ポートと一致している必要があります。

  - パケット長は、SNTP 時刻メッセージを保持するための最小の長さである必要があります。

次に、時刻データがパケット バッファーから抽出されて、クライアントによって特定の "正常性チェック" のセットが適用されます。

  - うるうインジケーターが 3 に設定されている場合は、サーバーが同期されていないことを示します。 クライアントは、別のサーバーの検索を試行します。

  - 0 に設定された stratum フィールドは、Kiss of Death (KOD) パケットと呼ばれます。 この状況の SMTP クライアント KOD ハンドラーは、ユーザー定義のコールバックです。 小規模なサンプル デモ ファイルには、この状況に対する単純な KOD ハンドラーが含まれています。 必要に応じて、参照 ID フィールドに KOD 応答の理由を示すコードが含まれています。 どのような場合でも、KOD ハンドラーは SNTP サーバーからの Kiss of Death 受信を処理する方法を示す必要があります。 通常は、別の SNTP サーバーを使用して SNTP クライアントを再初期化します。

  - サーバーの SNTP バージョン、stratum、および操作モードがクライアント サービスと一致している必要があります。

  - クライアントがサーバー クロックの分散最大値を使用して構成されている場合、クライアントは、最初に受信した更新のサーバー クロックの分散のみを確認し、クライアントの最大数を超えると、クライアントはサーバーを拒否します。

  - サーバーのタイム スタンプ フィールドも、特定のチェックに合格する必要があります。 ユニキャスト サーバーでは、すべての時間フィールドに値を入力する必要があり、NULL にすることはできません。 発信元のタイム スタンプは、クライアントの SNTP 時間メッセージ要求の送信タイム スタンプと同じである必要があります。 これにより、悪意のある侵入者や偽のサーバー動作からクライアントが保護されます。 ブロードキャスト サーバーは、送信タイム スタンプの値のみが必要です。 クライアントからは何も受信されないため、受信フィールドまたは送信元フィールドに値はありません。

    正常性チェックに失敗した場合、時刻の更新は無効な時刻の更新として認識されます。 SNTP クライアントの正常性チェック サービスでは、同じサーバーから受信した連続した無効な時刻更新の数が追跡されます。

SNTP クライアントのスレッド タスクでローカルの SNTP クライアント時刻に適用するために、SNTP パケットの有効性がチェックされると、SNTP クライアントの `nx_sntp_client_invalid_time_updates.` の数が増分されます。これは、呼び出し元にもエラー状態を返しますが、これはすべて内部処理であるため、アプリケーションにすぐには表示されません。 失敗した時刻の更新を検出する方法は、SNTP サーバーの時刻更新を受信した後に、SNTP クライアント `nx_sntp_client_invalid_time_updates` の値に対してクエリを実行することです。

サーバー時刻の更新が正常性チェックに合格すると、クライアントは時刻データをローカル時刻に処理しようとします。 クライアントがラウンド トリップ計算を行うように構成されている場合は (たとえば、更新要求を送信した時刻から受信した時刻まで)、ラウンド トリップ時間が計算されます。 この値は半分にされてサーバーの時刻に追加されます。

次に、現在の SNTP サーバーから受信した最初の更新の場合、SNTP クライアントでは、サーバーとクライアントのローカル時刻の違いを無視するかどうかが決定されます。 その後、SNTP サーバーからのすべての更新は、クライアントのローカル時刻との差に対して評価されます。

クライアントとサーバーの時刻の違いは、`NX_SNTP_CLIENT_MAX_TIME_ADJUSTMENT` を使用して比較されます。 この値を超えると、データがスローされます。差が `NX_SNTP_CLIENT_MIN_TIME_ADJUSTMENT` 未満の場合は、調整を必要とするには差が小さすぎると見なされます。

これらすべてのチェックに合格すると、内部の SNTP クライアント処理でいくつかの遅延が修正されて、時刻の更新が SNTP クライアントに適用されます。

### <a name="sntp-asynchronous-unicast-requests"></a>SNTP 非同期ユニキャスト要求 

SNTP クライアントを使用すると、ホスト アプリケーションでは、NTP サーバーから現在の時刻のユニキャスト要求を非同期的に送信できます。

```C
UINT _nx_sntp_client_request_unicast_time(
NX_SNTP_CLIENT *client_ptr, 
UINT wait_option)
```

待機オプションは、応答を待機する有効期限です。

NTP サーバーが応答した場合、パケットでは、前のセクションの説明と同じ処理と正常性チェックが実施されてから、SNTP クライアントのローカル時刻が更新されます。

呼び出しが正常に完了して返された場合、アプリケーションでは、更新されたローカル時刻に対して *nx_sntp_client_utility_display_date_time* または *nx_sntp_client_get_local_time_extended* を呼び出すことができます。

これらのユニキャスト要求は、次のユニキャスト要求を送信するための通常の SNTP クライアント スケジュールに干渉したり、ブロードキャスト モードの場合に、次の NTP ブロードキャストが予測されるタイミングに影響したりすることはありません。

### <a name="periodic-local-time-updates"></a>ローカル時刻の定期的な更新

ローカル時刻に対する最大の調整は、NX_SNTP_CLIENT_MAX_TIME_ADJUSTMENT オプションで設定します (ミリ秒単位)。 ユニキャストの SNTP クライアント操作の更新ポーリング間隔は、NX_SNTP_CLIENT_UNICAST_POLL_INTERVAL オプションで設定します (秒単位)。 ポーリング間隔が最大の調整よりも大きい場合、最初のサーバー更新後に発生するそれ以降のサーバー更新は拒否されます。 これを防ぐために、SNTP クライアントでは、NX_SNTP_UPDATE_TIMEOUT_INTERVAL として定義されるように、ローカル時刻を定期的に更新します。 

オンボード RTC と (SNTP クライアントのローカル時刻を設定するはずの) サーバー時刻の間に時刻の差がある場合は、RTC が SNTP クライアント時刻に同期されるようにする必要があります (これについては、このユーザー ガイドでは説明しません)。

SNTP サーバーの更新は 1 時間に 1 回より多く実行しないようにする必要があるため、SNTP クライアントでそれよりも頻繁にサーバーの更新やサーバーの状態をポーリングすることは役立ちません。 ただし、SNTP クライアントでは、最大時刻調整パラメーター NX_SNTP_CLIENT_MAX_TIME_LAPSE よりも大幅に長くならないようにするために十分な頻度でローカル クロックを更新する必要があります。

または、最大調整 NX_SNTP_CLIENT_MAX_TIME_LAPSE を、ユニキャスト ポーリング更新 (または、予想されるブロードキャスト間隔) よりも大きい値に設定できます。 後者の方法では、独立したリアル タイム クロックが不要になります。 ただし、SNTP プロトコルの目的は、ローカル RTC またはネットワーク時刻の更新のいずれかに完全に頼ることを回避することです。 さらに、SNTP サーバーの更新は、ローカル時刻のクロックのずれを防ぐことを目的としています。

## <a name="multiple-network-interfaces"></a>複数のネットワーク インターフェイス

NetX Duo SNTP クライアントは、IP インスタンスに登録されているセカンダリ ネットワークで実行されるように構成できます。 セカンダリ ネットワークを登録する方法の詳細については、NetX Duo または NetX のユーザー ガイドを参照してください。

*nx_sntp_client_create* の呼び出しで、3 番目の入力 (iface_index) を、時刻の更新を受信する SNTP クライアントのネットワークのインデックスに設定します。 プライマリ インターフェイスは、常にインデックス 0 になります。 NetX Duo SNTP クライアントでは、複数のネットワーク インターフェイスでの同時の時刻更新をサポートすることはできません。

## <a name="sntp-and-ntp-rfcs"></a>SNTP および NTP RFC

NetX Duo SNTP クライアントでは、RFC4330 の IPv4、IPv6 および OSI 向けの Simple Network Time Protocol (SNTP) バージョン 4 と関連する RFC に準拠しています。