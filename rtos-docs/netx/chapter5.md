---
title: 第 5 章 - Azure RTO NetX ネットワーク ドライバー
description: この章では、Azure RTO NetX 用のネットワーク ドライバーについて説明します。
author: philmea
ms.author: philmea
ms.date: 09/11/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: 0770d6beb8b2715a8e5dddf1bdf187c0cd1d5ffd74e7bea9b7ff9bdf1785d088
ms.sourcegitcommit: 93d716cf7e3d735b18246d659ec9ec7f82c336de
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/07/2021
ms.locfileid: "116801922"
---
# <a name="chapter-5---netx-network-drivers"></a>第 5 章 - NetX ネットワーク ドライバー

この章では、NetX 用のネットワーク ドライバーについて説明します。 記載されている情報は、開発者が Azure RTO NetX 用のアプリケーション固有のネットワーク ドライバーを作成するのを支援することを目的としています。

## <a name="driver-introduction"></a>ドライバーの概要

NX_IP 構造体には、単一の IP インスタンスを管理するためのすべてが含まれています。 これには、一般的な TCP/IP プロトコル情報だけでなく、アプリケーション固有の物理ネットワーク ドライバーのエントリ ルーチンが含まれます。 ドライバーのエントリ ルーチンは、***nx_ip_create*** サービス中に定義されます。 追加のデバイスを IP インスタンスに追加するには、***Nx_ip_interface_attach*** サービスを使用します。

NetX とアプリケーションのネットワーク ドライバーの間の通信は、**NX_IP_DRIVER** 要求構造体を通じて行われます。 この構造体は、ほとんどの場合、呼び出し元のスタック上にローカルで定義されるため、ドライバーと呼び出し元の関数が返された後に解放されます。 構造体は、次のように定義されています。

```C
typedef struct NX_IP_DRIVER_STRUCT
{
    UINT nx_ip_driver_command;
    UINT nx_ip_driver_status;
    ULONG nx_ip_driver_physical_address_msw;
    ULONG nx_ip_driver_physical_address_lsw;
    NX_PACKET *nx_ip_driver_packet;
    ULONG *nx_ip_driver_return_ptr;
    NX_IP *nx_ip_driver_ptr;
    NX_INTERFACE *nx_ip_driver_interface;
} NX_IP_DRIVER;
```

## <a name="driver-entry"></a>ドライバー エントリ

NetX は、ドライバーの初期化、パケットの送信のほか、ネットワーク デバイスの初期化と有効化などのさまざまな制御および状態操作のために、ネットワーク ドライバーのエントリ関数を呼び出します。 NetX は、_ *NX_IP_DRIVER** 要求構造体内で ***nx_ip_driver_command** _ フィールドを設定することによって、ネットワーク ドライバーにコマンドを発行します。 ドライバー エントリ関数の形式は次のとおりです。

```C
VOID my_driver_entry(NX_IP_DRIVER *request);
```

## <a name="driver-requests"></a>ドライバー要求

NetX は、特定のコマンドを使用してドライバー要求を作成し、ドライバー エントリ関数を呼び出して、コマンドを実行します。 ネットワーク ドライバーごとに単一のエントリ関数があるため、NetX はドライバー要求のデータ構造体を通じてすべての要求を行います。 要求は、ドライバー要求のデータ構造体 (**NX_IP_DRIVER**) の ***nx_ip_driver_command*** メンバーによって定義されます。 メンバー ***nx_ip_driver_status*** 内の呼び出し元には状態情報が報告されます。 このフィールドが **NX_SUCCESS** の場合、ドライバー要求は正常に完了しています。

NetX は、ドライバーへのすべてのアクセスをシリアル化します。 このため、ドライバーは、エントリ関数を呼び出している複数のスレッドを非同期に処理する必要がありません。 デバイス ドライバー関数は、IP ミューテックスがロックされた状態で実行されることに注意してください。 このため、デバイス ドライバーの内部関数が自身をブロックすることはできません。

通常、デバイス ドライバーは割り込みも処理します。 したがって、すべてのドライバー関数が、割り込みセーフである必要があります。

### <a name="driver-initialization"></a>ドライバーの初期化

実際のドライバー初期化処理はアプリケーション固有ですが、通常、データ構造体と物理ハードウェアの初期化で構成されます。 ドライバー初期化のために NetX から求められる情報は、IP 最大転送単位 (MTU)、つまり IP レイヤー ペイロードで使用可能なバイト数 (IP ヘッダーを含む) と、物理インターフェイスが論理から物理へのマッピングが必要かどうかです。 ドライバーは、

_ *NX_INTERFACE** 構造体内の ***nx_interface_ip_mtu_size** _ の値を設定することで、インターフェイスの MTU を構成する必要があります。

また、デバイス ドライバーは、***nx_ip_interface_address_mapping_needed***

(**NX_INTERFACE** 内) の値を設定して、インターフェイス アドレスのマッピングが必要かどうかを NetX に通知する必要もあります。 アドレス マッピングが必要な場合、ドライバーは、有効な MAC アドレスを使用してインターフェイスを構成し、NetX に MAC アドレスを提供します。

ネットワーク ドライバーは、NetX から NX_LINK INITIALIZE 要求を受信するときに、上に示した NX_IP_DRIVER 要求制御ブロックの一部として IP 制御ブロックへのポインターを受け取ります。

アプリケーションが ***nx_ip_create*** を呼び出した後、IP ヘルパー スレッドは、NX_LINK_INITIALIZE に設定されたコマンドを使用して、ドライバー要求をドライバーに送信し、その物理ネットワーク インターフェイスを初期化します。 次の NX_IP_DRIVER メンバーは、初期化要求に使用されます。

| NX_IP_DRIVER メンバー    | 意味 |
|------------------------|-----------------------------------------------|
| nx_ip_driver_command   | NX_LINK_INITIALIZE |
| nx_ip_driver_ptr       | IP インスタンスへのポインター。 この値は、ドライバー関数が操作対象の IP インスタンスを検出できるように、ドライバーが保存する必要があります。 |
| nx_ip_driver_interface | IP インスタンス内のネットワーク インターフェイス構造へのポインター。 この情報は、ドライバーが保存する必要があります。 パケットを受信するとき、ドライバーは、スタックへのパケット送信時のインターフェイス構造情報を使用する必要があります。 |
| nx_ip_driver_status    | 完了状態。 IP インスタンスの指定されたインターフェイスをドライバーが初期化できない場合は、0 以外のエラー状態が返されます。                                                                                           |


> [!IMPORTANT]
> *ドライバー コマンドのほとんどが、IP インスタンス用に作成された IP ヘルパー スレッドから呼び出されます。そのため、ドライバー ルーチンは、ブロック操作が実行されないようにする必要があります。これを行わないと、IP ヘルパー スレッドが停止し、IP スレッドに依存するアプリケーションに無制限の遅延が生じる可能性があります。*

### <a name="enable-link"></a>リンクを有効にする  

次に、IP ヘルパー スレッドは、ドライバー要求内でドライバー コマンドを NX_LINK_ENABLE に設定し、その要求をネットワーク ドライバーに要求を送信することで、物理ネットワークを有効にします。 これは、IP ヘルパー スレッドが初期化要求を完了した直後に行われます。 リンクを有効にする処理は、インターフェイス インスタンス内の nx_interface_link_up フィールドを設定するのと同じくらい簡単ですが、 物理ハードウェアの操作が必要になる場合もあります。 次の NX_IP_DRIVER メンバーは、リンクの有効化要求に使用されます。

| NX_IP_DRIVER メンバー    | 意味 |
|------------------------|------------------------------------------|
| nx_ip_driver_command   | NX_LINK_ENABLE                                                                                                          |
| nx_ip_driver_ptr       | IP インスタンスへのポインター                                                                                                  |
| nx_ip_driver_interface | インターフェイス インスタンスへのポインター                                                                                       |
| nx_ip_driver_status    | 完了状態。 指定されたインターフェイスをドライバーが有効にできない場合は、0 以外のエラー状態が返されます。 |



### <a name="disable-link"></a>リンクを無効にする  

この要求は、***nx_ip_delete** _ サービスによる IP インスタンスの削除中、NetX によって行われます。 または、アプリケーションが、電源を節約するためにリンクを一時的に無効にする目的で、このコマンドを実行する場合があります。 このサービスは、IP インスタンス上の物理ネットワーク インターフェイスを無効にします。 リンクを無効にする処理は、インターフェイス インスタンス内の "_nx_interface_link_up*" フラグをオフにするのと同じくらい簡単ですが、物理ハードウェアの操作が必要になる場合もあります。通常、これは "***リンクを有効にする**_" 操作と逆の操作になります。 リンクが無効になった後、アプリケーションは "_ *_リンクを有効にする_**" 操作を要求して、インターフェイスを有効にします。 次の NX_IP_DRIVER メンバーは、リンクの無効化要求に使用されます。

| NX_IP_DRIVER メンバー    | 意味 |
|------------------------|--------------------------------------|
| nx_ip_driver_command   | NX_LINK_DISABLE |
| nx_ip_driver_ptr       | IP インスタンスへのポインター |
| nx_ip_driver_interface | インターフェイス インスタンスへのポインター |
| nx_ip_driver_status    | 完了状態。 IP インスタンス内の指定されたインターフェイスをドライバーが無効にできない場合は、0 以外のエラー状態が返されます。 |


### <a name="uninitialize-link"></a>リンクを初期化前の状態に戻す  

この要求は、***nx_ip_delete*** サービスによる IP インスタンスの削除中、NetX によって行われます。 この要求によってインターフェイスが初期化前の状態に戻り、初期化フェーズ中に作成されたすべてのリソースが解放されます。 通常、これは "***リンクを初期化する***" 操作と逆の操作になります。 インターフェイスが初期化前の状態に戻されたら、デバイスは、インターフェイスが再度初期化されるまで使用できません。

次の NX_IP_DRIVER メンバーは、リンクの無効化要求に使用されます。

| NX_IP_DRIVER メンバー  | 意味                |
|----------------------|------------------------|
| nx_ip_driver_command | NX_LINK_UNINITIALZE    |
| nx_ip_driver_ptr     | IP インスタンスへのポインター |
| nx_ip_driver_interface | インターフェイス インスタンスへのポインター |
| nx_ip_driver_status    | 完了状態。 IP インスタンスの指定されたインターフェイスをドライバーが初期前の状態に戻せない場合は、0 以外のエラー状態が返されます。 |


### <a name="packet-send"></a>パケット送信  

この要求は、内部 IP の送信処理中、つまり、すべての NetX プロトコルが (ARP、RARP を除く) パケットの送信に使用する処理を実行しているときに行われます。 パケット送信コマンドを受信するとき、*nx_packet_prepend_ptr* は、送信されるパケットの先頭 (IP ヘッダーの先頭) を指定します。
*nx_packet_length* は、転送されるデータの合計サイズ (バイト単位) を示します。 *Nx_packet_next* が有効な場合、発信 IP データグラムは複数のパケットに格納されるため、ドライバーは、チェーンされたパケットに従ってフレーム全体を送信する必要があります。 各チェーン パケットの有効なデータ領域は、*nx_packet_prepend_ptr* と *nx_packet_append_ptr* の間に格納されていることに注意してください。

ドライバーは、物理ヘッダーを構築する役割を担います。 IP アドレスへの物理アドレスのマッピングが必要な場合 (イーサネットなど)、IP レイヤーによって、既に MAC アドレスは解決されています。 送信先 MAC アドレスは、*nx_ip_driver_physical_address_msw と nx_ip_driver_physical_address_lsw* 内に格納されている IP インスタンスから渡されます。

物理ヘッダーを追加すると、パケット送信処理によってドライバーの出力関数が呼び出され、パケットが送信されます。

次の NX_IP_DRIVER メンバーは、パケット送信要求に使用されます。

| NX_IP_DRIVER メンバー               | 意味 |
|-----------------------------------|---------------------------------------------------------------|
| nx_ip_driver_command              | NX_LINK_PACKET_SEND |
| nx_ip_driver_ptr                  | IP インスタンスへのポインター |
| nx_ip_driver_packet               | 送信するパケットへのポインター |
| nx_ip_driver_interface            | インターフェイス インスタンスへのポインター             |
| nx_ip_driver_physical_address_msw | 最上位 32 ビットの物理アドレス (物理マッピングが必要な場合のみ) |
| nx_ip_driver_physical_address_lsw | 最下位 32 ビットの物理アドレス (物理マッピングが必要な場合のみ)    |
| nx_ip_driver_status               | 完了状態。 ドライバーがパケットを送信できない場合は、0 以外のエラー状態が返されます。  |

### <a name="packet-broadcast"></a>パケット ブロードキャスト  
この要求は、送信パケット要求とほぼ同じです。 唯一の違いは、ブロードキャスト先の物理アドレス フィールドがイーサネットのブロードキャスト MAC アドレスに設定されていることです。 次の NX_IP_DRIVER メンバーは、パケット ブロードキャスト要求に使用されます。

| NX_IP_DRIVER メンバー                | 意味          |
|------------------------------------|--------------------------------------------------------------|
| nx_ip_driver_command               | NX_LINK_PACKET_BROADCAST |
| nx_ip_driver_ptr                   | IP インスタンスへのポインター  |
| nx_ip_driver_packet                | 終了するパケットへのポインター |
| nx_ip_driver_physical_address_ms w | 0x0000FFFF (ブロードキャスト) |
| nx_ip_driver_physical_address_lsw  | 0xFFFFFFFF (ブロードキャスト) |
| nx_ip_driver_interface             | インターフェイス インスタンスへのポインター |
| nx_ip_driver_status                | 完了状態。 ドライバーがパケットを送信できない場合は、0 以外のエラー状態が返されます。 |

### <a name="arp-send"></a>ARP 送信  

この要求も、IP パケット送信要求に似ています。
唯一の違いは、イーサネット ヘッダーによって指定されるのが IP パケットではなく ARP パケットであること、そして送信先の物理アドレス フィールドが MAC ブロードキャスト アドレスに設定されていることです。 次の NX_IP_DRIVER メンバーは、ARP 送信要求に使用されます。

| **NX_IP_DRIVER member** | **意味** |
| --- | --- |
| nx_ip_driver_command | NX_LINK_ARP_SEND |
| nx_ip_driver_ptr | IP インスタンスへのポインター。 |
| nx_ip_driver_packet | 送信するパケットへのポインター。 |
| nx_ip_driver_physical_address_msw | 0x0000FFFF (ブロードキャスト) |
| nx_ip_driver_physical_address_lsw | 0xFFFFFFFF (ブロードキャスト) |
| nx_ip_driver_interface | インターフェイス インスタンスへのポインター |
| nx_ip_driver_status | 完了状態。 ドライバーが ARP パケットを送信できない場合は、0 以外のエラー状態が返されます。 |

*物理マッピングが不要な場合、この要求の実装は必要ありません。*

### <a name="arp-response-send"></a>ARP 応答送信  

この要求は、ARP 送信パケット要求とほぼ同じです。 唯一の違いは、送信先の物理アドレス フィールドが IP インスタンスから渡されることです。 次の NX_IP_DRIVER メンバーは、ARP 応答送信要求に使用されます。

| NX_IP_DRIVER メンバー               | 意味 |
|-----------------------------------| ------------------------------------|
| nx_ip_driver_command              | NX_LINK_ARP_RESPONSE_SEND |
| nx_ip_driver_ptr                  | IP インスタンスへのポインター |
| nx_ip_driver_packet               | 送信するパケットへのポインター|
| nx_ip_driver_physical_address_msw | 最上位 32 ビットの物理アドレス |
| nx_ip_driver_physical_address_lsw | 最下位 32 ビットの物理アドレス                     |
| nx_ip_driver_interface            | インターフェイス インスタンスへのポインター |
| nx_ip_driver_status               | 完了状態。 ドライバーが ARP パケットを送信できない場合は、0 以外のエラー状態が返されます。 |

> [!NOTE]
> *物理マッピングが不要な場合、この要求の実装は必要ありません。*

### <a name="rarp-send"></a>RARP 送信  

この要求は、ARP 送信パケット要求とほぼ同じです。 唯一の違いは、パケット ヘッダーの種類と、物理アドレス フィールドが不要であることです。これは、物理的な送信先が常にブロードキャスト アドレスであるためです。

次の NX_IP_DRIVER メンバーは、RARP 送信要求に使用されます。

| NX_IP_DRIVER メンバー               | 意味 |
|-----------------------------------|---------------------------------|
| nx_ip_driver_command              |NX_LINK_RARP_SEND |
| nx_ip_driver_ptr                  | IP インスタンスへのポインター |
| nx_ip_driver_packet               | 送信するパケットへのポインター |
| nx_ip_driver_physical_address_msw | 0x0000FFFF (ブロードキャスト) |
| nx_ip_driver_physical_address_lsw | 0xFFFFFFFF (ブロードキャスト) |
| NX_IP_DRIVER メンバー               | 意味 |
| nx_ip_driver_interface            | インターフェイス インスタンスへのポインター |
| nx_ip_driver_status               | 完了状態。 ドライバーが RARP パケットを送信できない場合は、0 以外のエラー状態が返されます。  |

> [!NOTE]
> *RARP サービスを必要とするアプリケーションは、このコマンドを実装する必要があります。*

### <a name="multicast-group-join"></a>マルチキャスト グループ参加  

この要求は、***nx_igmp_multicast_interface join*** サービスを使用して行われます。 ネットワーク ドライバーは、指定されたマルチキャスト グループアドレスを受け取り、そのマルチキャスト グループ アドレスからの受信パケットを受け入れるように物理メディアを設定します。 ドライバーがマルチキャスト フィルターをサポートしていない場合は、ドライバー受信ロジックを、無作為検出モードにしなければならない可能性があります。 この場合、ドライバーが、送信先 MAC アドレスに基づいて、受信フレームをフィルター処理する必要が出てくることがあるため、IP インスタンスに渡されるトラフィック量が減少します。 次の NX_IP_DRIVER メンバーは、マルチキャスト グループ参加要求に使用されます。

| NX_IP_DRIVER メンバー               | 意味 |
|-----------------------------------|-----------------------------------------------------------------------|
| nx_ip_driver_command              | NX_LINK_MULTICAST_JOIN                                                |
| nx_ip_driver_ptr                  | IP インスタンスへのポインター                                                |
| nx_ip_driver_physical_address_msw | 最上位 32 ビットの物理マルチキャスト アドレス                |
| nx_ip_driver_physical_address_lsw | 最下位 32 ビットの物理マルチキャスト アドレス               |
| nx_ip_driver_interface            | インターフェイス インスタンスへのポインター                                     |
| nx_ip_driver_status               | 完了状態。 ドライバーがマルチキャスト グループに参加できない場合は、0 以外のエラー状態が返されます。 |


### <a name="multicast-group-leave"></a>マルチキャスト グループ脱退  

この要求は、***nx_igmp_multicast_leave*** サービスを明示的に呼び出すことによって呼び出されます。 ドライバーは、指定されたイーサネット マルチキャスト アドレスをマルチキャスト リストから削除します。 ホストがマルチキャスト グループを脱退した後、この IP インスタンスは、このイーサネット マルチキャスト アドレスのネットワーク上のパケットを受信しなくなります。 次の NX_IP_DRIVER メンバーは、マルチキャスト グループ脱退要求に使用されます。

| NX_IP_DRIVER メンバー               | 意味 |
|-----------------------------------|-----------------------------------------------------------------|
| nx_ip_driver_command              | NX_LINK_MULTICAST_LEAVE |
| nx_ip_driver_ptr                  | IP インスタンスへのポインター |
| nx_ip_driver_physical_address_msw | 最上位 32 ビットの物理マルチキャスト アドレス |
| nx_ip_driver_physical_address_lsw | 最下位 32 ビットの物理マルチキャスト アドレス |
| nx_ip_driver_interface            | インターフェイス インスタンスへのポインター |
| nx_ip_driver_status               | 完了状態。 ドライバーがマルチキャスト グループを脱退できない場合は、0 以外のエラー状態が返されます。 |


### <a name="attach-interface"></a>インターフェイスをアタッチする  

この要求は、NetX からデバイス ドライバーに対して呼び出されます。これにより、ドライバーは、ドライバー インスタンスを、対応する IP インスタンス、および IP 内の物理インターフェイス インスタンスに関連付けることができます。 次の NX_IP_DRIVER メンバーは、インターフェイスのアタッチ要求に使用されます。

| NX_IP_DRIVER メンバー    | 意味 |
|------------------------|-------------------------------------------------|
| nx_ip_driver_command   | X_LINK_INTERFACE_ATTACH |
| nx_ip_driver_ptr       | IP インスタンスへのポインター |
| nx_ip_driver_interface | インターフェイス インスタンスへのポインター |
| nx_ip_driver_status    | 完了状態。 IP インスタンスの指定されたインターフェイスをドライバーがデタッチできない場合は、0 以外のエラー状態が返されます。  |


### <a name="detach-interface"></a>インターフェイスをデタッチする  

この要求は、NetX によってデバイス ドライバーに対して呼び出されます。これにより、ドライバーは、ドライバー インスタンと、対応する IP インスタンス、および IP 内の物理インターフェイス インスタンスとの関連付けを解除することができます。 次の NX_IP_DRIVER メンバーは、インターフェイスのアタッチ要求に使用されます。

| NX_IP_DRIVER メンバー    | 意味 |
|------------------------|---------------------------------------------------------|
| nx_ip_driver_command   | NX_LINK_INTERFACE_DETACH |
| nx_ip_driver_ptr       | IP インスタンスへのポインター |
| nx_ip_driver_interface | インターフェイス インスタンスへのポインター |
| nx_ip_driver_status    | 完了状態。 IP インスタンスの指定されたインターフェイスをドライバーがアタッチできない場合は、0 以外のエラー状態が返されます。 |

### <a name="get-link-status"></a>リンクの状態を取得する  

アプリケーションは、ホスト上の任意のインターフェイスに対して NetX サービス ***nx_ip_interface_status_check*** サービスを使用して、ネットワーク インターフェイス リンクの状態のクエリを実行できます。 これらのサービスの詳細については、107 ページの第 4 章「NetX サービスの説明」をご覧ください。

リンクの状態は *nx_ip_driver_interface* ポインターが指す NX_INTERFACE 構造体内の *nx_interface_link_up* フィールド内に含まれています。 次の NX_IP_DRIVER メンバーは、リンク状態要求に使用されます。

| NX_IP_DRIVER メンバー     | 意味                                                                                                      |
|-------------------------|--------------------------------------------------------------------------------------------------------------|
| nx_ip_driver_command    | NX_LINK_GET_STATUS                                                                                           |
| nx_ip_driver_ptr        | IP インスタンスへのポインター                                                                                       |
| nx_ip_driver_return_ptr | 状態の配置先へのポインター。                                                              |
| nx_ip_driver_interface  | インターフェイス インスタンスへのポインター                                                                            |
| nx_ip_driver_status     | 完了状態。 ドライバーが特定の状態を取得できない場合は、0 以外のエラー状態が返されます。 |
|                         |                                                                                                              |

> [!NOTE]
> ***nx_ip_status_check** は、プライマリ インターフェイスの状態を確認するために引き続き使用できますが、アプリケーション開発者は、インターフェイス固有のサービス **nx_ip_interface_status_check** を使用することをお勧めします。*

### <a name="get-link-speed"></a>リンクの速度を取得する  

この要求は、***nx_ip_driver_direct_command*** サービス内から行われます。 リンクの回線速度は、指定された宛先内にドライバーによって格納されます。 次の NX_IP_DRIVER メンバーは、リンク回線速度要求に使用されます。

| NX_IP_DRIVER メンバー     | 意味 |
|-------------------------|---------------------------------------------------------------|
| nx_ip_driver_command    | NX_LINK_GET_SPEED |
| nx_ip_driver_ptr        | IP インスタンスへのポインター |
| nx_ip_driver_return_ptr | 回線速度の配置先へのポインター |
| nx_ip_driver_interface  | インターフェイス インスタンスへのポインター |
| nx_ip_driver_status     | 完了状態。 ドライバーが速度情報を取得できない場合は、0 以外のエラー状態が返されます。
 |


> [!NOTE]
> *この要求は NetX によって内部的に使用されないため、実装は省略可能です。*

### <a name="get-duplex-type"></a>二重タイプを取得する  

この要求は、***nx_ip_driver_direct_command*** サービス内から行われます。 リンクの二重タイプは、指定された宛先内にドライバーによって格納されます。 次の NX_IP_DRIVER メンバーは、二重タイプ要求に使用されます。

| NX_IP_DRIVER メンバー     | 意味 |
|-------------------------|-----------------------------------------------------|
| nx_ip_driver_command    | NX_LINK_GET_DUPLEX_TYPE |
| nx_ip_driver_ptr        | IP インスタンスへのポインター |
| nx_ip_driver_return_ptr | 二重タイプの配置先へのポインター |
| nx_ip_driver_interface  | インターフェイス インスタンスへのポインター |
| nx_ip_driver_status     | 完了状態。 ドライバーが二重情報を取得できない場合は、0 以外のエラー状態が返されます。
 |


> [!NOTE]
> *この要求は NetX によって内部的に使用されないため、実装は省略可能です。*

### <a name="get-error-count"></a>エラー数を取得する  

この要求は、***nx_ip_driver_direct_command*** サービス内から行われます。 リンクのエラー数は、指定された宛先内にドライバーによって格納されます。 この機能をサポートするために、ドライバーは操作エラーを追跡する必要があります。 次の NX_IP_DRIVER メンバーは、リンク エラー数要求に使用されます。

| NX_IP_DRIVER メンバー     | 意味                                                                                                  |
|-------------------------|----------------------------------------------------------------------------------------------------------|
| nx_ip_driver_command    | NX_LINK_GET_ERROR_COUNT                                                                                  |
| nx_ip_driver_ptr        | IP インスタンスへのポインター                                                                                   |
| nx_ip_driver_return_ptr | エラー数の配置先へのポインター                                                      |
| nx_ip_driver_interface  | インターフェイス インスタンスへのポインター                                                                        |
| nx_ip_driver_status     | 完了状態。 ドライバーがエラー数を取得できない場合は、0 以外のエラー状態が返されます。 |


> [!NOTE]
> *この要求は NetX によって内部的に使用されないため、実装は省略可能です。*

### <a name="get-receive-packet-count"></a>受信パケット数を取得する  

この要求は、***nx_ip_driver_direct_command*** サービス内から行われます。 リンクの受信パケット数は、指定された宛先内にドライバーによって格納されます。 この機能をサポートするために、ドライバーは受信パケット数を追跡する必要があります。 次の NX_IP_DRIVER メンバーは、リンクの受信パケット数要求に使用されます。

| NX_IP_DRIVER メンバー     | 意味                                                                                                    |
|-------------------------|------------------------------------------------------------------------------------------------------------|
| nx_ip_driver_command    | NX_LINK_GET_RX_COUNT                                                                                       |
| nx_ip_driver_ptr        | IP インスタンスへのポインター                                                                                     |
| nx_ip_driver_return_ptr | 受信パケット数の配置先へのポインター                                               |
| nx_ip_driver_interface  | 物理ネットワーク インターフェイスへのポインター                                                                  |
| nx_ip_driver_status     | 完了状態。 ドライバーが受信数を取得できない場合は、0 以外のエラー状態が返されます。 |


> [!NOTE]
> *この要求は NetX によって内部的に使用されないため、実装は省略可能です。*

### <a name="get-transmit-packet-count"></a>送信パケット数を取得する  

この要求は、***nx_ip_driver_direct_command*** サービス内から行われます。 リンクの送信パケット数は、指定された宛先内にドライバーによって格納されます。 この機能をサポートするために、ドライバーは、各インターフェイス上で送信する各パケットを追跡する必要があります。 次の NX_IP_DRIVER メンバーは、リンクの送信パケット数要求に使用されます。

| NX_IP_DRIVER メンバー     | 意味                                                                                                     |
|-------------------------|-------------------------------------------------------------------------------------------------------------|
| nx_ip_driver_command    | NX_LINK_GET_TX_COUNT                                                                                        |
| nx_ip_driver_ptr        | IP インスタンスへのポインター                                                                                      |
| nx_ip_driver_return_ptr | 送信パケット数の配置先へのポインター                                               |
| nx_ip_driver_interface  | インターフェイス インスタンスへのポインター                                                                           |
| nx_ip_driver_status     | 完了状態。 ドライバーが送信数を取得できない場合は、0 以外のエラー状態が返されます。 |


> [!NOTE]
> *この要求は NetX によって内部的に使用されないため、実装は省略可能です。*

### <a name="get-allocation-errors"></a>割り当てエラーを取得する  

この要求は、***nx_ip_driver_direct_command*** サービス内から行われます。 リンクのパケット プール割り当てエラー数は、指定された宛先内にドライバーによって格納されます。 次の NX_IP_DRIVER メンバーは、リンクの割り当てエラー数要求に使用されます。

| **NX_IP_DRIVER member** | **意味** |
| --- | ---|
| nx_ip_driver_command | NX_LINK_GET_ALLOC_ERRORS |
| nx_ip_driver_ptr | IP インスタンスへのポインター |

| NX_IP_DRIVER メンバー     | 意味                                                                                                        |
|-------------------------|----------------------------------------------------------------------------------------------------------------|
| nx_ip_driver_return_ptr | 割り当てエラー数の配置先へのポインター                                                 |
| nx_ip_driver_interface  | インターフェイス インスタンスへのポインター                                                                              |
| nx_ip_driver_status     | 完了状態。 ドライバーが割り当てエラーを取得できない場合は、0 以外のエラー状態が返されます。 |


*この要求は NetX によって内部的に使用されないため、実装は省略可能です。*

### <a name="driver-deferred-processing"></a>ドライバー遅延処理  

この要求は、送信または受信 ISR から _ ***nx_ip_driver_deferred_processing*** ルーチンを呼び出しているドライバーへの応答として、IP ヘルパー スレッドから行われます。 これにより、ドライバー ISR はパケットの受信および送信処理を IP ヘルパー スレッドに任せて、ISR 内の処理量を減らすことができます。 *Nx_ip_driver_interface* が指す NX_INTERFACE 構造体内の *nx_interface_additional_link_info* フィールドは、IP ヘルパー スレッド コンテキストからの遅延処理イベントに関する情報を格納するために、ドライバーによって使用される場合があります。 次の NX_IP_DRIVER メンバーは、遅延処理イベントに使用されます。

**NX_IP_DRIVER**

| member                 | 意味                           |
|------------------------|-----------------------------------|
| nx_ip_driver_command   | NX_LINK_DEFERRED_PROCESSING       |
| nx_ip_driver_ptr       | IP インスタンスへのポインター            |
| nx_ip_driver_interface | インターフェイス インスタンスへのポインター |


### <a name="user-commands"></a>ユーザー コマンド  

この要求は、***nx_ip_driver_direct_command*** サービス内から行われます。 ドライバーは、アプリケーション固有のユーザーコマンドを処理します。 次の NX_IP_DRIVER メンバーは、ユーザー コマンド要求に使用されます。

| NX_IP_DRIVER メンバー     | 意味                                                                                                        |
|-------------------------|----------------------------------------------------------------------------------------------------------------|
| nx_ip_driver_command    | NX_LINK_USER_COMMAND                                                                                           |
| nx_ip_driver_ptr        | IP インスタンスへのポインター                                                                                         |
| nx_ip_driver_return_ptr | ユーザー定義                                                                                                   |
| nx_ip_driver_interface  | インターフェイス インスタンスへのポインター                                                                              |
| nx_ip_driver_status     | 完了状態。 ドライバーがユーザー コマンドを実行できない場合は、0 以外のエラー状態が返されます。 |


*この要求は NetX によって内部的に使用されないため、実装は省略可能です。*

### <a name="unimplemented-commands"></a>実装されていないコマンド  

ネットワーク ドライバーによって実装されていないコマンドのリターン状態フィールドは、NX_UNHANDLED_COMMAND に設定する必要があります。

## <a name="driver-output"></a>ドライバーの出力  

前述のすべてのパケット送信要求には、ドライバー内で実装された出力関数が必要です。 特別な送信ロジックはハードウェア固有ですが、通常は、パケットを直ちに送信できるハードウェア容量を確認することで構成されます。 可能な場合、パケット ペイロード (およびパケット チェーン内の追加ペイロード) は 1 つ以上のハードウェア送信バッファーに読み込まれ、送信操作が開始されます。 使用可能な送信バッファーに収まらないパケットは、キューに登録され、送信バッファーが使用可能になったときに送信されます。

推奨される送信キューは、ヘッド ポインターとテール ポインターの両方を持つシングルリンクリストです。 新しいパケットがキューの最後に追加され、最も古いパケットが先頭で保持されます。 *nx_packet_queue_next* フィールドは、キュー内のパケットの次のリンクとして使用されます。 ドライバーは、送信キューのヘッド ポインターとテール ポインターを定義します。

*このキューは、ドライバーのスレッドおよび割り込み部分からアクセスされるため、キュー操作を中心に割り込み保護を配置する必要があります。*

物理ハードウェア実装のほとんどによって、パケット送信の完了時に割り込みが発生します。
ドライバーは、このような割り込みを受け取ると、通常は、送信中のパケットに関連付けられているリソースを解放します。 送信ロジックが NX_PACKET バッファーから直接データを読み取る場合、ドライバーは、 ***nx_packet_transmit_release*** サービスを使用して、送信完了割り込みに関連付けられているパケットを解放し、使用可能なパケット プールに戻します。 次に、ドライバーは、送信キューに、送信待ちの追加パケットがないかどうかを調べます。 キュー登録された送信パケットのうち、ハードウェア送信バッファーに適合するものが、キューから取り出され、バッファーに読み込まれます。 その後、別の送信操作が開始されます。

NX_PACKET 内のデータが送信元 FIFO に移動された時点で (ドライバーがゼロコピー操作をサポートしている場合は、NX_PACKET 内のデータが送信された時点で)、ドライバーは、***nx_packet_transmit_release*** を呼び出す前に、nx_packet_prepend_ptr を IP ヘッダーの先頭に移動する必要があり ます。 忘れずに *nx_packet_length* フィールドを適宜調整してください。 IP フレームが複数のパケットで構成されている場合は、パケット チェーンの先頭のみを解放する必要があります。

## <a name="driver-input"></a>ドライバーの入力  

ネットワーク ドライバーは、受信パケットの割り込みを受信すると、物理ハードウェアの受信バッファーからパケットを取得し、有効な NetX パケットを構築します。 有効な NetX パケットを構築するには、適切な長さフィールドを設定し、受信パケットのサイズが単一パケット ペイロードよりも大きい場合は、複数のパケットを連結する必要があります。 適切に構築されたら、prepend_ptr は物理レイヤー ヘッダーの後に移動され、受信パケットは NetX にディスパッチされます。

NetX は、IP ヘッダーと ARP ヘッダーが ULONG 境界上でアラインされていることを前提としています。 そのため、NetX ドライバーは、このアライメントを確保する必要があります。 イーサネット環境内でこの処理を実行するには、パケットの先頭から 2 バイトのところでイーサネット ヘッダーを開始します。 *nx_packet_prepend_ptr* がイーサネット ヘッダーを超えて移動されると、基になる IP ヘッダーまたは ARP ヘッダーは 4 バイトでアラインされます。

NetX 内で使用可能な受信パケット関数は複数あります。 受信パケットが ARP パケットの場合は、 _***nx_arp_packet_deferred_receive**_ が呼び出されます。 受信パケットが RARP パケットの場合は、_*_nx_arp_packet_deferred_receive_*_ が呼び出されます。 受信 IP パケットの処理オプションは複数あり、 IP パケットを最速で処理する場合は、_ _*_nx_ip_packet_receive_*_ が呼び出されます。 この方法の場合、オーバーヘッドは最も少なくて済みますが、ドライバーの受信割り込みサービス ハンドラー (ISR) 内で必要な処理が増えます。 最小 ISR 処理の場合は、__ *_nx_ip_packet_deferred_receive_** が呼び出されます。

新しい受信パケットが適切に構築された後、物理ハードウェアの受信バッファーは、さらに多くのデータを受信するように設定されます。 これには、NetX パケットの割り当て、またはハードウェア受信バッファー内へのペイロード アドレスの配置が必要になることがあります。また、ハードウェア受信バッファー内の設定を変更するだけで済む場合もあります。 オーバーランの可能性を最小限に抑えるために重要なのは、パケットを受信した後、ハードウェアの受信バッファーにできるだけ早く使用可能なバッファーを確保することです。

*初期受信バッファーは、ドライバーの初期化中に設定されます。*

### <a name="deferred-receive-packet-handling"></a>遅延受信パケット処理  

ドライバーは、受信パケット処理を NetX IP ヘルパー スレッドに任せる場合があります。 一部のアプリケーションについては、これは ISR の処理とパケット破棄を最小限に抑えるうえで必要な場合があります。 遅延パケット処理を使用するには、NetX ライブラリが、定義済み ***NX_DRIVER_DEFERRED_PROCESSING** _ でコンパイルされている必要があります。 これにより、遅延パケットロジックが NetX IP ヘルパー スレッドに追加されます。 次に、データ パケットの受信時に、ドライバーが __nx_ip_packet_deferred_receive()* を呼び出す必要があります。

```C
_nx_ip_packet_deferred_receive(ip_ptr, packet_ptr);
```

遅延受信関数により、*packet_ptr* によって表される受信パケットが FIFO (リンクリスト) 上に配置され、IP ヘルパー スレッドに通知されます。 実行後、IP ヘルパーは遅延処理関数を繰り返し呼び出して、遅延パケットを処理します。 遅延ハンドラー処理には、通常、パケットの物理レイヤー ヘッダー (通常はイーサネット) の削除と、次のいずれかの NetX 受信関数へのディスパッチが含まれます。  

***_nx_ip_packet_deferred_receive***  
***_nx_arp_packet_deferred_receive***  
***_nx_rarp_packet_deferred_receive*** 


## <a name="example-ram-ethernet-network-driver"></a>RAM イーサネット ネットワーク ドライバーの例  

NetX デモ システムは、***nx_ram_network_driver*** ファイル内で定義されている小さな RAM ベースのネットワーク ドライバーを使用して提供されます。
このドライバーは、IP インスタンスがすべて同じネットワーク上にあることを前提としており、仮想ハードウェア アドレス (MAC アドレス) を、各デバイス インスタンスに作成時に割り当てるだけです。 このファイルには、NetX 物理ネットワーク ドライバーの基本構造の良い例が示されています。 ユーザーは、この例に示されているドライバー フレームワークを使用して、独自のネットワーク ドライバーを開発できます。

ネットワーク ドライバーのエントリ関数は、* **_nx_ram_network_driver** _ で、これは IP インスタンスの作成呼び出しに渡されます。 追加ネットワーク インターフェイスのエントリ関数は _*_nx_ip_interface_attach_*_ サービスに渡すことができます。 IP インスタンスが実行し始めたら、ドライバー エントリ関数が呼び出され、デバイスの初期化と有効化が行われます (「_ *NX_LINK_INITIALIZE**」および「**NX_LINK_ENABLE**」をご覧ください)。 **NX_LINK_ENABLE** コマンドの実行後は、デバイスをパケットの送受信が可能な状態にしておきます。 

IP インスタンスは、次のいずれかのコマンドを使用してネットワーク パケットを転送します。

| ***NX_LINK_PACKET_SEND***    | IP パケットが送信されています。                             |
| ------------------------------- | -------------------------------------------------------------- |
| ***NX_LINK_ARP_SEND***       | ARP 要求または ARP 応答パケットが送信されています。    |
| ***NX_LINK_ARP_RARP_SEND*** | リバース ARP 要求または応答パケットが送信されています。 |

これらのコマンドの処理中、ネットワーク ドライバーは、適切なイーサネット フレーム ヘッダーを付加してから、基になるハードウェアに送信して、転送する必要があります。 転送処理中、ネットワーク ドライバーには、パケット バッファー領域の排他的な所有権があります。 そのため、データが転送されると (または、データがドライバー内の転送バッファーにコピーされると)、ネットワーク ドライバーはパケット バッファーを解放する必要があります。それには、まず先頭のポインターをイーサネット ヘッダーから IP ヘッダーに移動し (そして、必要に応じてパケットの長さを調整し)、***nx_packet_transmit_release*** サービスを呼び出して、パケットを解放します。 データ転送後にパケットを解放しないと、パケットがリークします。

ネットワーク デバイス ドライバーは、受信データ パケットの処理も実行します。 RAM ドライバーの例では、受信パケットが、***_nx_ram_network_driver_receive*** 関数によって処理されます。

デバイスがイーサネット フレームを受け取ったら、ドライバーはデータを

NX_PACKET 構造体内に格納する必要があります。 NetX は IP ヘッダーが 4 バイトでアラインされたアドレスで始まることを前提としている点に注意してください。 イーサネット ヘッダーの長さは 14 バイトであるため、ドライバーは、IP ヘッダーが 4 バイトでアラインされたアドレスで始まることを保証するために、イーサネット ヘッダーの開始位置を、2 バイトでアラインされたアドレスに格納する必要があります。