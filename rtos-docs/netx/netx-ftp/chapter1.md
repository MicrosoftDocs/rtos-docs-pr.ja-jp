---
title: 第 1 章 - Azure RTOS NetX FTP の概要
description: ファイル転送プロトコル (FTP) は、ファイル転送用に設計されたプロトコルです。 FTP では、信頼性の高い伝送制御プロトコル (TCP) サービスを使用してファイル転送機能を実行します。
author: philmea
ms.author: philmea
ms.date: 06/04/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: 35a7487720578ce8da578c490d96aa3c444ee818167b1bbd10833556e34b3dce
ms.sourcegitcommit: 93d716cf7e3d735b18246d659ec9ec7f82c336de
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/07/2021
ms.locfileid: "116799474"
---
# <a name="chapter-1---introduction-to-azure-rtos-netx-ftp"></a>第 1 章 - Azure RTOS NetX FTP の概要

ファイル転送プロトコル (FTP) は、ファイル転送用に設計されたプロトコルです。 FTP では、信頼性の高い伝送制御プロトコル (TCP) サービスを利用して、ファイル転送機能を実行します。 そのため、FTP は信頼性の高いファイル転送プロトコルです。 また、FTP は高パフォーマンスです。 実際の FTP ファイル転送は、専用の FTP 接続で実行されます。

## <a name="ftp-requirements"></a>FTP の要件

Azure RTOS NetX FTP パッケージが正しく機能するには、NetX IP インスタンスが既に作成されている必要があります。 さらに、その同じ IP インスタンス上で TCP が有効になっている必要があります。 NetX FTP パッケージの FTP クライアント部分には、これ以外の要件はありません。

NetX FTP パッケージの FTP サーバー部分には、追加要件がいくつかあります。 最も重要なのは、TCP の "*ウェルノウン ポート 21*" (すべてのクライアント FTP コマンド要求を処理) と、"*ウェルノウン ポート 20*" (すべてのクライアント FTP データ転送を処理) への完全なアクセス権が必要であることです。 また、FTP サーバーは、組み込みファイルシステムの FileX と合わせて使用するように設計されています。 FileX が使用できない場合、ユーザーは、使用されている FileX の一部を自分自身の環境に移植することもできます。 これについては、このガイドの後のセクションで説明します。

## <a name="ftp-constraints"></a>FTP の制約

FTP 標準には、ファイル データの表現に関する多くのオプションがあります。 UNIX の実装と同様に、NetX FTP には次のファイル形式の制約があります。

- ファイルの種類: **バイナリ**
- ファイル形式: **onprint のみ**
- ファイル構造: **ファイル構造のみ**
- 送信モード: **ストリーム モードのみ**

## <a name="ftp-file-names"></a>FTP ファイル名

FTP ファイル名は、ターゲット ファイル システム (通常は FileX) の形式である必要があります。 これらは、必要に応じて完全なパス情報を含む、NULL 終端 ASCII 文字列である必要があります。 NetX FTP 実装では、FTP ファイル名のサイズに特に制限はありません。 ただし、パケット プールのペイロード サイズは、最大のパスやファイル名に対応できる必要があります。

## <a name="ftp-client-commands"></a>FTP クライアント コマンド

FTP には、接続を開き、ファイルおよびディレクトリ操作を実行するための単純なメカニズムがあります。 基本的には、TCP の "*ウェルノウン ポート 21*" で接続が正常に確立された後に、クライアントによって発行される一連の標準の FTP コマンドがあります。 基本的な FTP コマンドの一部を次に示します。

### <a name="ftp-command-and-meaning"></a>FTP コマンドおよび意味

- **CWD パス**: *作業ディレクトリを変更する*
- **DELE ファイル名**: *指定したファイル名を削除する*
- **LIST ディレクトリ**: *ディレクトリの一覧を取得する*
- **MKD ディレクトリ**: *新しいディレクトリを作成する*
- **NLST ディレクトリ**: *ディレクトリの一覧を取得する*
- **NOOP**: *操作なし、成功を返す*
- **PASS パスワード**: *ログインのパスワードを指定する*
- **PASV**: *パッシブ転送モードを要求する*
- **PWD パス**: *現在のディレクトリ パスを選択する*
- **QUIT**: *クライアント接続を終了する*
- **RETR ファイル名**: *指定したファイルを読み取る*
- **RMD ディレクトリ**: *指定したディレクトリを削除する*
- **RNFR 古いファイル名**: *名前を変更するファイルを指定する*
- **RNTO 新しいファイル名**: *ファイル名を、指定したファイル名に変更する*
- **STOR ファイル名**: *指定したファイルを書き込む*
- **TYPE I**: *バイナリ ファイル イメージを選択する*
- **USER ユーザー名**: *ログインのユーザー名を指定する*
- **PORT IP アドレス, ポート**: *IP アドレスとクライアント データ ポートを指定する*

これらの ASCII コマンドは、FTP サーバーで FTP 操作を実行するために、NetX FTP クライアント ソフトウェアによって内部的に使用されます。

## <a name="ftp-server-responses"></a>FTP サーバーの応答

FTP サーバーでは、"*ウェルノウン TCP ポート 21*" を使用してクライアント コマンド要求を処理します。 FTP サーバーは、クライアントコマンドを処理した後、3 桁の数値応答を ASCII で返し、オプションの ASCII 文字列を返します。 この数値の応答は、操作が成功したか、失敗したかを判断するために、FTP クライアント ソフトウェアによって使用されます。 クライアント要求に対するさまざまな FTP サーバー応答を次に示します。

### <a name="first-numeric-field-and-meaning"></a>最初の数値フィールドおよび意味

- **1xx**: *肯定的な準備状態 - さらに別の応答が返されます*。
- **2xx**: *肯定的な完了状態*。
- **3xx**: *肯定的な準備状態 - 別のコマンドを送信する必要があります*。
- **4xx**: *一時的なエラー状態*。
- **5xx**: *エラー状態*。

### <a name="second-numeric-field-and-meaning"></a>2 番目の数値フィールドおよび意味

- **x0x**: コマンドの構文エラー。
- **x1x**: 情報メッセージ。
- **x2x**: 接続関連。
- **x3x**: 認証関連。
- **x4x**: 未指定。
- **x5x**: ファイル システム関連。

たとえば、クライアントが QUIT コマンドで FTP 接続の切断を要求すると、通常はサーバーから "221" コードで応答が返されます (切断が成功した場合)。

## <a name="ftp-passive-transfer-mode"></a>FTP パッシブ転送モード

既定では、NetX FTP クライアントはアクティブ転送モードを使用して、データ ソケットを介して FTP サーバーとデータを交換します。 この配置の問題は、FTP サーバーが接続する TCP サーバー ソケットを FTP クライアントが開く必要があることです。 これはセキュリティ リスクをもたらす可能性があり、クライアント ファイアウォールによってブロックされる場合があります。 パッシブ転送モードは、データ接続で FTP サーバーが TCP サーバー ソケットを作成するという点で、アクティブ転送モードとは異なります。 これにより、(FTP クライアントの) セキュリティ リスクが排除されます。

パッシブ データ転送を有効にするには、以前に作成された FTP クライアントに対して、2 番目の引数を NX_TRUE に設定した *nx_ftp_client_passive_mode_set* をアプリケーションで呼び出します。 その後、データを転送するための後続の NetX FTP クライアント サービス (NLST、RETR、STOR) は、すべてパッシブ転送モードで試行されます。

FTP クライアントは、最初に PASV コマンド (引数なし) を送信します。 FTP サーバーがこの要求をサポートしている場合は、227 の "OK" 応答が返されます。 次に、クライアントが、RETR などの要求を送信します。 サーバーがパッシブ転送モードを拒否した場合、NetX FTP クライアント サービスはエラー状態を返します。

パッシブ転送モードを無効にし、アクティブ転送モードに戻すには、2 番目の引数を NX_FALSE に設定した *nx_ftp_client_passive_mode_set* をアプリケーションで呼び出します。

## <a name="ftp-communication"></a>FTP 通信

FTP サーバーでは、"*ウェルノウン TCP ポート 21*" を使用してクライアント要求を処理します。 FTP クライアントでは、使用可能な任意の TCP ポートを使用できます。 FTP イベントの一般的なシーケンスは次のとおりです。

### <a name="ftp-read-file-requests"></a>FTP ファイル読み取り要求

1. クライアントがサーバー ポート 21 への TCP 接続を発行します。
1. サーバーが "220" 応答を送信して成功を通知します。
1. クライアントが、"ユーザー名" を含む "USER" メッセージを送信します。
1. サーバーが "331" 応答を送信して成功を通知します。
1. クライアントが、"パスワード" を含む "PASS" メッセージを送信します。
1. サーバーが "230" 応答を送信して成功を通知します。
1. クライアントが、バイナリ転送用の "TYPE I" メッセージを送信します。
1. サーバーが "200" 応答を送信して成功を通知します。
1. クライアントが、IP アドレスとポートを含む "PORT" メッセージを送信します。
1. サーバーが "200" 応答を送信して成功を通知します。
1. クライアントが、読み取るファイル名を含む "RETR" メッセージを送信します。
1. サーバーがデータ ソケットを作成し、"PORT" コマンドで指定されたクライアント データ ポートに接続します。
1. サーバーが "125" 応答を送信して、ファイルの読み取りが開始されたことを通知します。
1. サーバーが、データ接続を介してファイルの内容を送信します。 ファイルが完全に転送されるまで、このプロセスが続行されます。
1. 完了すると、サーバーはデータ接続を切断します。
1. サーバーが "250" 応答を送信して、ファイルの読み取りが成功したことを通知します。
1. クライアントが "QUIT" を送信して FTP 接続を終了します。
1. サーバーが "221" 応答を送信して、切断が成功したことを通知します。
1. サーバーが FTP 接続を切断します。

前述のように、IPv4 で実行される FTP と、IPv6 で実行される FTP の違いは、IPv6 では PORT コマンドの代わりに EPRT コマンドが使用されることのみです。

FTP クライアントがパッシブ転送モードで読み取り要求を行う場合、コマンド シーケンスは次のようになります (**太字** の行は、アクティブ転送モードとは異なる手順を示しています)。

1. クライアントがサーバー ポート 21 への TCP 接続を発行します。
1. サーバーが "220" 応答を送信して成功を通知します。
1. クライアントが、"ユーザー名" を含む "USER" メッセージを送信します。
1. サーバーが "331" 応答を送信して成功を通知します。
1. クライアントが、"パスワード" を含む "PASS" メッセージを送信します。
1. サーバーが "230" 応答を送信して成功を通知します。
1. クライアントが、バイナリ転送用の "TYPE I" メッセージを送信します。
1. サーバーが "200" 応答を送信して成功を通知します。
1. **クライアントが "PASV" メッセージを送信します。**
1. **"227" 応答と、クライアントの接続先となる IP アドレスとポートをサーバーが送信して成功を通知します。**
1. クライアントが、読み取るファイル名を含む "RETR" メッセージを送信します。
1. **サーバーがデータ サーバー ソケットを作成し、"227" 応答で指定されたポートを使用して、このソケットでクライアント接続要求をリッスンします。**
1. **サーバーが制御ソケットで "150" 応答を送信して、ファイルの読み取りが開始されたことを通知します。**
1. サーバーが、データ接続を介してファイルの内容を送信します。 ファイルが完全に転送されるまで、このプロセスが続行されます。
1. 完了すると、サーバーはデータ接続を切断します。
1. **サーバーが制御ソケットで "226" 応答を送信して、ファイルの読み取りが成功したことを通知します。**
1. クライアントが "QUIT" を送信して FTP 接続を終了します。
1. サーバーが "221" 応答を送信して、切断が成功したことを通知します。
1. サーバーが FTP 接続を切断します。

### <a name="ftp-write-requests"></a>FTP 書き込み要求

1. クライアントがサーバー ポート 21 への TCP 接続を発行します。
1. サーバーが "220" 応答を送信して成功を通知します。
1. クライアントが、"ユーザー名" を含む "USER" メッセージを送信します。
1. サーバーが "331" 応答を送信して成功を通知します。
1. クライアントが、"パスワード" を含む "PASS" メッセージを送信します。
1. サーバーが "230" 応答を送信して成功を通知します。
1. クライアントが、バイナリ転送用の "TYPE I" メッセージを送信します。
1. サーバーが "200" 応答を送信して成功を通知します。
1. クライアントが、IP アドレスとポートを含む "PORT" メッセージを送信します。
1. サーバーが "200" 応答を送信して成功を通知します。
1. クライアントが、書き込むファイル名を含む "STOR" メッセージを送信します。
1. サーバーがデータ ソケットを作成し、"PORT" コマンドで指定されたクライアント データ ポートに接続します。
1. サーバーが "125" 応答を送信して、ファイルの書き込みが開始されたことを通知します。
1. クライアントが、データ接続を介してファイルの内容を送信します。 ファイルが完全に転送されるまで、このプロセスが続行されます。
1. 完了すると、クライアントはデータ接続を切断します。
1. サーバーが "250" 応答を送信して、ファイルの書き込みが成功したことを通知します。
1. クライアントが "QUIT" を送信して FTP 接続を終了します。
1. サーバーが "221" 応答を送信して、切断が成功したことを通知します。
1. サーバーが FTP 接続を切断します。

FTP クライアントがパッシブ転送モードで書き込み要求を行う場合、コマンド シーケンスは次のようになります (**太字** の行は、アクティブ転送モードとは異なる手順を示しています)。

1. クライアントがサーバー ポート 21 への TCP 接続を発行します。
1. サーバーが "220" 応答を送信して成功を通知します。
1. クライアントが、"ユーザー名" を含む "USER" メッセージを送信します。
1. サーバーが "331" 応答を送信して成功を通知します。
1. クライアントが、"パスワード" を含む "PASS" メッセージを送信します。
1. サーバーが "230" 応答を送信して成功を通知します。
1. クライアントが、バイナリ転送用の "TYPE I" メッセージを送信します。
1. サーバーが "200" 応答を送信して成功を通知します。
1. **クライアントが "PASV" メッセージを送信します。**
1. **"227" 応答と、クライアントの接続先となる IP アドレスとポートをサーバーが送信して成功を通知します。**
1. クライアントが、書き込むファイル名を含む "STOR" メッセージを送信します。
1. **サーバーがデータ サーバー ソケットを作成し、"227" 応答で指定されたポートを使用して、このソケットでクライアント接続要求をリッスンします。**
1. **サーバーが制御ソケットで "150" 応答を送信して、ファイルの書き込みが開始されたことを通知します。**
1. クライアントが、データ接続を介してファイルの内容を送信します。 ファイルが完全に転送されるまで、このプロセスが続行されます。
1. 完了すると、クライアントはデータ接続を切断します。
1. **サーバーが制御ソケットで "226" 応答を送信して、ファイルの書き込みが成功したことを通知します。**
1. クライアントが "QUIT" を送信して FTP 接続を終了します。
1. サーバーが "221" 応答を送信して、切断が成功したことを通知します。
1. サーバーが FTP 接続を切断します。

## <a name="ftp-authentication"></a>FTP Authentication

FTP 接続が行われるたびに、クライアントは "*ユーザー名*" と "*パスワード*" をサーバーに提供する必要があります。 一部の FTP サイトでは、特定のユーザー名およびパスワードなしで FTP アクセスを許可する、"*匿名 FTP*" と呼ばれるものを使用できます。 この種類の接続では、"anonymous" をユーザー名として、完全な電子メール アドレスをパスワードとして指定します。

ログインおよびログアウト認証ルーチンは、ユーザーが NetX FTP に提供する必要があります。 これらは、***nx_ftp_server_create** _ 関数内で提供され、パスワード処理から呼び出されます。 login* 関数により NX_SUCCESS が返された場合は、接続が認証され、FTP 操作が許可されます。 *login* 関数により NX_SUCCESS 以外のものが返された場合は、接続が拒否されます。

## <a name="ftp-multi-thread-support"></a>FTP マルチスレッドのサポート

NetX FTP クライアント サービスは、複数のスレッドから同時に呼び出すことができます。 ただし、特定の FTP クライアント インスタンスの読み取りまたは書き込み要求は、同じスレッドから順番に実行する必要があります。

## <a name="ftp-rfcs"></a>FTP RFC

NetX FTP は、RFC959 および関連する RFC に準拠しています。